<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHICL Pro - Auto Shop Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .navbar {
            background: #0a2540;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand i {
            color: #00d4ff;
        }

        .nav-links {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #a0aec0;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #1e40af;
            color: white;
        }

        .nav-btn.active {
            background: #00d4ff;
            color: #0a2540;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .card-btn {
            background: #00d4ff;
            color: #0a2540;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }

        .card-btn:hover {
            background: #00b8e6;
        }

        .stats-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .section-header {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
        }

        .action-btn {
            background: #00d4ff;
            color: #0a2540;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #00b8e6;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #2f855a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .data-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item-title {
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .data-item-subtitle {
            color: #718096;
            font-size: 0.9rem;
        }

        .data-item-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: #edf2f7;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #e2e8f0;
        }

        .icon-btn.delete {
            background: #fed7d7;
            color: #c53030;
        }

        .icon-btn.delete:hover {
            background: #feb2b2;
        }
    </style>

</head>
<body>
    <div class="navbar">
        <div class="nav-brand">
            <i class="fas fa-car"></i>
            VHICL Pro
        </div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="showScreen('home')">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="nav-btn" onclick="showScreen('quickQuote')">
                <i class="fas fa-bolt"></i> Quick Quote
            </button>
            <button class="nav-btn" onclick="showScreen('customers')">
                <i class="fas fa-users"></i> Customers
            </button>
            <button class="nav-btn" onclick="showScreen('vehicles')">
                <i class="fas fa-car-side"></i> Vehicles
            </button>
            <button class="nav-btn" onclick="showScreen('appointments')">
                <i class="fas fa-calendar"></i> Appointments
            </button>
               <button class="nav-btn" onclick="showScreen('towing')">
                   <i class="fas fa-truck-pickup"></i> Towing
               </button>
               <button class="nav-btn" onclick="showScreen('inventory')">
                   <i class="fas fa-boxes"></i> Inventory
               </button>
               <button class="nav-btn" onclick="showScreen('analytics')">
                   <i class="fas fa-chart-line"></i> Analytics
               </button>
            <button class="nav-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Customers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalVehicles">0</div>
                        <div class="stat-label">Vehicles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalAppointments">0</div>
                        <div class="stat-label">Appointments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="systemStatus">Active</div>
                        <div class="stat-label">System Status</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-icon" style="background: #e3f2fd; color: #1976d2;">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="card-title">Quick Quote</div>
                    <div class="card-description">Get instant estimates with real-time parts pricing and labor times</div>
                    <button class="card-btn" onclick="showScreen('quickQuote')">
                        <i class="fas fa-arrow-right"></i> Create Quote
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #f3e5f5; color: #7b1fa2;">
                        <i class="fas fa-phone-volume"></i>
                    </div>
                    <div class="card-title">ALEX Voice Assistant</div>
                    <div class="card-description">Automated phone calls for parts pricing and customer service</div>
                    <button class="card-btn" onclick="showScreen('appointments')">
                        <i class="fas fa-arrow-right"></i> Manage ALEX
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #e8f5e9; color: #388e3c;">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div class="card-title">Labor Service</div>
                    <div class="card-description">30+ pre-populated repair operations with industry-standard times</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> View Labor Ops
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #fff3e0; color: #f57c00;">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="card-title">Parts Stores</div>
                    <div class="card-description">Manage local parts stores and pricing sources</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> Configure Stores
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #fce4ec; color: #c2185b;">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="card-title">Email Notifications</div>
                    <div class="card-description">Send confirmations, quotes, and updates to customers</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> Configure Email
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #e0f2f1; color: #00796b;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-title">Analytics</div>
                    <div class="card-description">Track performance, revenue, and shop metrics</div>
                    <button class="card-btn" onclick="showScreen('analytics')">
                        <i class="fas fa-arrow-right"></i> View Stats
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Quote Screen -->
        <div id="quickQuoteScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-bolt"></i> Quick Quote
                </div>
                <button class="action-btn" onclick="resetQuoteForm()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>

            <div class="form-container">
                <div class="form-group">
                    <label class="form-label">Vehicle Information</label>
                    <input type="text" class="form-input" id="quoteVehicle" placeholder="Year Make Model (e.g., 2020 Toyota Camry)">
                </div>

                <div class="form-group">
                    <label class="form-label">Service Needed</label>
                    <input type="text" class="form-input" id="quoteService" placeholder="Describe the service (e.g., Brake pads replacement)">
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Email (Optional)</label>
                    <input type="email" class="form-input" id="quoteEmail" placeholder="customer@email.com">
                </div>

                <button class="card-btn" onclick="generateQuote()">
                    <i class="fas fa-calculator"></i> Generate Quote
                </button>
            </div>

            <div id="quoteResults" style="display: none;">
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Quote Results</h3>
                    <div id="quoteDetails"></div>
                </div>
            </div>
        </div>

        <!-- Customers Screen -->
        <div id="customersScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-users"></i> Customers
                </div>
                <button class="action-btn" onclick="showAddCustomerForm()">
                    <i class="fas fa-plus"></i> Add Customer
                </button>
            </div>

            <div id="customersList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading customers...</p>
                </div>
            </div>
        </div>

        <!-- Vehicles Screen -->
        <div id="vehiclesScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-car-side"></i> Vehicles
                </div>
                <button class="action-btn" onclick="showAddVehicleForm()">
                    <i class="fas fa-plus"></i> Add Vehicle
                </button>
            </div>

            <div id="vehiclesList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading vehicles...</p>
                </div>
            </div>
        </div>

        <!-- Appointments Screen -->
        <div id="appointmentsScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calendar"></i> Appointments
                </div>
                <button class="action-btn" onclick="showAddAppointmentForm()">
                    <i class="fas fa-plus"></i> Add Appointment
                </button>
            </div>

            <div id="appointmentsList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading appointments...</p>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-cog"></i> Shop Settings
                </div>
                <button class="action-btn" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Shop Information</h3>
                <div class="form-group">
                    <label class="form-label">Shop Name</label>
                    <input type="text" class="form-input" id="settingsShopName" placeholder="Your Shop Name">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Phone</label>
                    <input type="tel" class="form-input" id="settingsShopPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Email</label>
                    <input type="email" class="form-input" id="settingsShopEmail" placeholder="shop@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Address</label>
                    <input type="text" class="form-input" id="settingsShopAddress" placeholder="123 Main St, City, State ZIP">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Pricing</h3>
                <div class="form-group">
                    <label class="form-label">Labor Rate ($/hour)</label>
                    <input type="number" class="form-input" id="settingsLaborRate" placeholder="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" class="form-input" id="settingsTaxRate" placeholder="8" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">Diagnostic Fee ($)</label>
                    <input type="number" class="form-input" id="settingsDiagnosticFee" placeholder="50">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">API Configuration</h3>
                <div class="form-group">
                    <label class="form-label">VAPI API Key</label>
                    <input type="password" class="form-input" id="settingsVapiKey" placeholder="Enter VAPI API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">SendGrid API Key</label>
                    <input type="password" class="form-input" id="settingsSendgridKey" placeholder="Enter SendGrid API Key">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Labor Operations</h3>
                <div id="laborOperationsList" class="data-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading labor operations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = window.location.origin + '/api';

        // Navigation
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');

            // Add active class to clicked button
            const clickedBtn = event.target.closest('.nav-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }

            // Load data for specific screens
            if (screenId === 'home') loadDashboardStats();
            if (screenId === 'customers') loadCustomers();
            if (screenId === 'vehicles') loadVehicles();
            if (screenId === 'appointments') loadAppointments();
            if (screenId === 'settings') loadSettings();
        }

        // Dashboard Stats
        async function loadDashboardStats() {
            try {
                // Try to get stats from backend
                const healthResponse = await fetch(`${API_BASE}/health`);
                if (healthResponse.ok) {
                    document.getElementById('systemStatus').textContent = 'Active';
                    document.getElementById('systemStatus').style.color = '#38a169';
                } else {
                    document.getElementById('systemStatus').textContent = 'Error';
                    document.getElementById('systemStatus').style.color = '#e53e3e';
                }

                // For demo, set random stats
                document.getElementById('totalCustomers').textContent = Math.floor(Math.random() * 50) + 10;
                document.getElementById('totalVehicles').textContent = Math.floor(Math.random() * 100) + 20;
                document.getElementById('totalAppointments').textContent = Math.floor(Math.random() * 30) + 5;

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('systemStatus').textContent = 'Offline';
                document.getElementById('systemStatus').style.color = '#e53e3e';
            }
        }

        // Quick Quote
        async function generateQuote() {
            const vehicle = document.getElementById('quoteVehicle').value;
            const service = document.getElementById('quoteService').value;
            const email = document.getElementById('quoteEmail').value;

            if (!vehicle || !service) {
                alert('Please fill in vehicle and service information');
                return;
            }

            try {
                // Get labor estimate from backend
                const laborResponse = await fetch(`${API_BASE}/labor/quick-estimate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: service })
                });
                let laborCost = 0;
                let laborTime = 0;

                if (laborResponse.ok) {
                    const laborData = await laborResponse.json();
                    laborCost = laborData.laborCost || 0;
                    laborTime = laborData.laborTime || 0;
                }

                // Calculate parts estimate (demo)
                const partsCost = Math.floor(Math.random() * 200) + 50;

                // Calculate totals
                const subtotal = laborCost + partsCost;
                const tax = subtotal * 0.08;
                const total = subtotal + tax;

                // Display results
                document.getElementById('quoteResults').style.display = 'block';
                document.getElementById('quoteDetails').innerHTML = `
                    <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: #2d3748;">${vehicle}</h4>
                        <p style="color: #718096; margin-bottom: 1rem;">${service}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Labor Time:</strong><br>
                                ${laborTime} hours
                            </div>
                            <div>
                                <strong>Labor Cost:</strong><br>
                                $${laborCost.toFixed(2)}
                            </div>
                            <div>
                                <strong>Parts Estimate:</strong><br>
                                $${partsCost.toFixed(2)}
                            </div>
                            <div>
                                <strong>Tax (8%):</strong><br>
                                $${tax.toFixed(2)}
                            </div>
                        </div>
                        
                        <div style="background: #00d4ff; color: #0a2540; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong>Estimated Total: $${total.toFixed(2)}</strong>
                        </div>
                        
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #718096;">
                            * This is an estimate. Final price may vary based on actual parts and labor.
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error('Error generating quote:', error);
                alert('Error generating quote. Please try again.');
            }
        }

        function resetQuoteForm() {
            document.getElementById('quoteVehicle').value = '';
            document.getElementById('quoteService').value = '';
            document.getElementById('quoteEmail').value = '';
            document.getElementById('quoteResults').style.display = 'none';
        }

        // Customers
        async function loadCustomers() {
            const listContainer = document.getElementById('customersList');
            
            try {
                const response = await fetch(`${API_BASE}/customers`);
                
                if (response.ok) {
                    const customers = await response.json();
                    displayCustomers(customers);
                } else {
                    // Show demo data
                    displayDemoCustomers();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                displayDemoCustomers();
            }
        }

        function displayCustomers(customers) {
            const listContainer = document.getElementById('customersList');
            
            if (customers.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No customers yet. Add your first customer!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = customers.map(customer => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${customer.name}</div>
                        <div class="data-item-subtitle">${customer.email} | ${customer.phone}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewCustomer('${customer.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoCustomers() {
            const demoCustomers = [
                { id: 1, name: 'John Smith', email: 'john@email.com', phone: '(555) 123-4567' },
                { id: 2, name: 'Jane Doe', email: 'jane@email.com', phone: '(555) 987-6543' },
                { id: 3, name: 'Mike Johnson', email: 'mike@email.com', phone: '(555) 456-7890' }
            ];
            displayCustomers(demoCustomers);
        }

        function showAddCustomerForm() {
            const name = prompt('Customer Name:');
            if (!name) return;
            
            const email = prompt('Customer Email:');
            const phone = prompt('Customer Phone:');

            // Demo - just add to display
            const demoCustomer = {
                id: Date.now(),
                name: name,
                email: email || 'N/A',
                phone: phone || 'N/A'
            };

            loadCustomers(); // Reload to show new customer
            alert('Customer added successfully!');
        }

        function viewCustomer(id) {
            alert(`Viewing customer ID: ${id}`);
        }

        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                alert('Customer deleted (demo)');
                loadCustomers();
            }
        }

        // Vehicles
        async function loadVehicles() {
            const listContainer = document.getElementById('vehiclesList');
            
            try {
                const response = await fetch(`${API_BASE}/vehicles`);
                
                if (response.ok) {
                    const vehicles = await response.json();
                    displayVehicles(vehicles);
                } else {
                    displayDemoVehicles();
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                displayDemoVehicles();
            }
        }

        function displayVehicles(vehicles) {
            const listContainer = document.getElementById('vehiclesList');
            
            if (vehicles.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-car-side" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No vehicles yet. Add your first vehicle!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = vehicles.map(vehicle => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                        <div class="data-item-subtitle">VIN: ${vehicle.vin || 'N/A'} | Mileage: ${vehicle.mileage || 'N/A'}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewVehicle('${vehicle.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteVehicle('${vehicle.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoVehicles() {
            const demoVehicles = [
                { id: 1, year: 2020, make: 'Toyota', model: 'Camry', vin: '1HGBH41JXMN109186', mileage: '45,000' },
                { id: 2, year: 2019, make: 'Honda', model: 'Civic', vin: '2HGFC2F59KH534123', mileage: '32,000' },
                { id: 3, year: 2021, make: 'Ford', model: 'F-150', vin: '1FTEW1EP5MFA12345', mileage: '28,000' }
            ];
            displayVehicles(demoVehicles);
        }

        function showAddVehicleForm() {
            const year = prompt('Vehicle Year:');
            if (!year) return;
            
            const make = prompt('Vehicle Make:');
            const model = prompt('Vehicle Model:');
            const vin = prompt('VIN (optional):');
            const mileage = prompt('Mileage (optional):');

            loadVehicles();
            alert('Vehicle added successfully!');
        }

        function viewVehicle(id) {
            alert(`Viewing vehicle ID: ${id}`);
        }

        function deleteVehicle(id) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                alert('Vehicle deleted (demo)');
                loadVehicles();
            }
        }

        // Appointments
        async function loadAppointments() {
            const listContainer = document.getElementById('appointmentsList');
            
            try {
                const response = await fetch(`${API_BASE}/appointments`);
                
                if (response.ok) {
                    const appointments = await response.json();
                    displayAppointments(appointments);
                } else {
                    displayDemoAppointments();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                displayDemoAppointments();
            }
        }

        function displayAppointments(appointments) {
            const listContainer = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-calendar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No appointments yet. Add your first appointment!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = appointments.map(apt => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${apt.customerName}</div>
                        <div class="data-item-subtitle">${apt.date} at ${apt.time} | ${apt.service}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewAppointment('${apt.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteAppointment('${apt.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoAppointments() {
            const demoAppointments = [
                { id: 1, customerName: 'John Smith', date: '2025-01-20', time: '10:00 AM', service: 'Oil Change' },
                { id: 2, customerName: 'Jane Doe', date: '2025-01-20', time: '2:00 PM', service: 'Brake Inspection' },
                { id: 3, customerName: 'Mike Johnson', date: '2025-01-21', time: '9:00 AM', service: 'Tire Rotation' }
            ];
            displayAppointments(demoAppointments);
        }

        function showAddAppointmentForm() {
            const customerName = prompt('Customer Name:');
            if (!customerName) return;
            
            const date = prompt('Date (YYYY-MM-DD):');
            const time = prompt('Time (HH:MM AM/PM):');
            const service = prompt('Service:');

            loadAppointments();
            alert('Appointment added successfully!');
        }

        function viewAppointment(id) {
            alert(`Viewing appointment ID: ${id}`);
        }

        function deleteAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                alert('Appointment deleted (demo)');
                loadAppointments();
            }
        }

        // Settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/shop/settings`);
                
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('settingsShopName').value = settings.shopName || '';
                    document.getElementById('settingsShopPhone').value = settings.shopPhone || '';
                    document.getElementById('settingsShopEmail').value = settings.shopEmail || '';
                    document.getElementById('settingsShopAddress').value = settings.shopAddress || '';
                    document.getElementById('settingsLaborRate').value = settings.laborRate || '';
                    document.getElementById('settingsTaxRate').value = (settings.taxRate * 100) || '';
                    document.getElementById('settingsDiagnosticFee').value = settings.diagnosticFee || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }

            // Load labor operations
            loadLaborOperations();
        }

        async function loadLaborOperations() {
            const listContainer = document.getElementById('laborOperationsList');
            
            try {
                const response = await fetch(`${API_BASE}/labor/operations`);
                
                if (response.ok) {
                    const operations = await response.json();
                    displayLaborOperations(operations);
                } else {
                    displayDemoLaborOperations();
                }
            } catch (error) {
                console.error('Error loading labor operations:', error);
                displayDemoLaborOperations();
            }
        }

        function displayLaborOperations(operations) {
            const listContainer = document.getElementById('laborOperationsList');
            
            if (operations.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <p>No labor operations found.</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = operations.slice(0, 10).map(op => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${op.operation}</div>
                        <div class="data-item-subtitle">Time: ${op.laborTime} hrs | Base Price: $${(op.laborTime * 100).toFixed(2)}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="editOperation('${op.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoLaborOperations() {
            const demoOps = [
                { id: 'oil-change', operation: 'Oil Change', laborTime: 0.5 },
                { id: 'brake-pads', operation: 'Brake Pads Replacement', laborTime: 1.0 },
                { id: 'tire-rotation', operation: 'Tire Rotation', laborTime: 0.5 },
                { id: 'battery-replacement', operation: 'Battery Replacement', laborTime: 0.5 },
                { id: 'air-filter', operation: 'Air Filter Replacement', laborTime: 0.25 }
            ];
            displayLaborOperations(demoOps);
        }

        async function saveSettings() {
            const settings = {
                shopName: document.getElementById('settingsShopName').value,
                shopPhone: document.getElementById('settingsShopPhone').value,
                shopEmail: document.getElementById('settingsShopEmail').value,
                shopAddress: document.getElementById('settingsShopAddress').value,
                laborRate: parseFloat(document.getElementById('settingsLaborRate').value),
                taxRate: parseFloat(document.getElementById('settingsTaxRate').value) / 100,
                diagnosticFee: parseFloat(document.getElementById('settingsDiagnosticFee').value),
                vapiKey: document.getElementById('settingsVapiKey').value,
                sendgridKey: document.getElementById('settingsSendgridKey').value
            };

            try {
                const response = await fetch(`${API_BASE}/shop/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings. Please try again.');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Settings saved (demo mode)!');
            }
        }

        function editOperation(id) {
            alert(`Edit operation: ${id}`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
        });
    
// Towing Functions
function loadTowingRequests() {
    fetch('/api/towing/requests')
        .then(res => res.json())
        .then(requests => {
            const container = document.getElementById('towingRequestsList');
            container.innerHTML = requests.map(req => `
                <div class="tow-request status-${req.status}">
                    <div class="tow-header">
                        <span class="tow-id">${req.id}</span>
                        <span class="tow-status status-${req.status}">${req.status}</span>
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-details">
                            <p><strong>Customer:</strong> ${req.customerName} (${req.customerPhone})</p>
                            <p><strong>Vehicle:</strong> ${req.vehicle?.year} ${req.vehicle?.make} ${req.vehicle?.model} (${req.vehicle?.plate})</p>
                            <p><strong>Pickup:</strong> ${req.pickupLocation}</p>
                            <p><strong>Destination:</strong> ${req.destination}</p>
                            ${req.notes ? `<p><strong>Notes:</strong> ${req.notes}</p>` : ''}
                        </div>
                    </div>
                    <div class="toolbar">
                        ${req.status !== 'arrived' ? `<button class="action-btn" onclick="markArrived('${req.id}')">Mark Arrived</button>` : ''}
                        ${req.status === 'pending' ? `<button class="action-btn" onclick="assignProvider('${req.id}')">Assign Provider</button>` : ''}
                    </div>
                </div>
            `).join('');
        })
        .catch(err => console.error('Error loading towing requests:', err));
}

function markArrived(towId) {
    fetch(`/api/towing/${towId}/arrived`, { method: 'POST' })
        .then(() => {
            alert('âœ… Car marked as arrived! Customer will be notified.');
            loadTowingRequests();
        })
        .catch(err => alert('Error marking as arrived:', err));
}

// Inventory Functions
function loadInventory() {
    fetch('/api/inventory')
        .then(res => res.json())
        .then(items => {
            const container = document.getElementById('inventoryList');
            container.innerHTML = `
                <div class="card">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; text-align: left;">Part</th>
                                <th style="padding: 10px; text-align: left;">Category</th>
                                <th style="padding: 10px; text-align: center;">Stock</th>
                                <th style="padding: 10px; text-align: center;">Price</th>
                                <th style="padding: 10px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 10px;">${item.name} (${item.partNumber})</td>
                                    <td style="padding: 10px;">${item.category}</td>
                                    <td style="padding: 10px; text-align: center;">${item.quantity}</td>
                                    <td style="padding: 10px; text-align: center;">$${item.price.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: center;">
                                        ${item.quantity <= item.reorderPoint ? 
                                            '<span style="color: #e74c3c; font-weight: bold;">LOW STOCK</span>' : 
                                            '<span style="color: #27ae60;">In Stock</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => console.error('Error loading inventory:', err));
}

function showLowStock() {
    fetch('/api/inventory/low-stock/5')
        .then(res => res.json())
        .then(items => {
            alert(`Low Stock Alert:\n\n${items.map(i => `${i.name}: ${i.quantity} units`).join('\n')}`);
        });
}


// ==================== TOWING FUNCTIONS ====================

// ==================== TOWING INITIALIZATION ====================
function initializeTowing() {
    // Check if towing requests exist, add sample if not
    fetch('/api/towing/requests')
        .then(res => res.json())
        .then(requests => {
            if (requests.length === 0) {
                // Add sample towing request
                const sampleRequest = {
                    customerName: 'John Smith',
                    customerPhone: '555-123-4567',
                    vehicle: {
                        year: 2022,
                        color: 'Blue',
                        make: 'Ford',
                        model: 'F-150',
                        plate: 'ABC1234'
                    },
                    pickupLocation: '123 Main Street, Anytown, CA',
                    destination: '456 Shop Road, Anytown, CA',
                    keyLocation: 'Under the driver side floor mat',
                    customerMeeting: 'No, will leave the key under the mat',
                    notes: 'Customer said the truck wont start. Possible alternator issue.',
                    status: 'pending'
                };
                
                fetch('/api/towing/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sampleRequest)
                }).then(() => loadTowingRequests()).catch(err => console.log('Error adding sample:', err));
            }
        })
        .catch(err => console.log('Error checking towing:', err));
}

// Update loadTowingRequests to show better info
async function loadTowingRequests() {
    try {
        const response = await fetch('/api/towing/requests');
        const requests = await response.json();
        const container = document.getElementById('towingRequestsList');
        
        if (requests.length === 0) {
            container.innerHTML = '<div class="card"><p>No towing requests found. Initializing with sample data...</p></div>';
            initializeTowing();
            return;
        }
        
        // Count by status
        const pending = requests.filter(r => r.status === 'pending').length;
        const assigned = requests.filter(r => r.status === 'assigned').length;
        const arrived = requests.filter(r => r.status === 'arrived').length;
        
        container.innerHTML = `
            <div class="card">
                <h3>ðŸšš Towing Dashboard Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${requests.length}</div>
                        <div style="color: #666; font-size: 14px;">Total Requests</div>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${pending}</div>
                        <div style="color: #666; font-size: 14px;">Pending</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${assigned}</div>
                        <div style="color: #666; font-size: 14px;">Assigned</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${arrived}</div>
                        <div style="color: #666; font-size: 14px;">Arrived</div>
                    </div>
                </div>
            </div>
            ${requests.map(req => `
                <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${getStatusColor(req.status)}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin-bottom: 5px;">${req.id}</h3>
                            <p style="color: #666; font-size: 14px; margin: 5px 0;">Created: ${new Date(req.createdAt).toLocaleString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="padding: 8px 20px; border-radius: 20px; background: ${getStatusColor(req.status)}; color: white; font-weight: bold; font-size: 14px;">
                                ${req.status.toUpperCase().replace('_', ' ')}
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #1976d2;">ðŸ‘¤ Customer Information</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div><strong>Name:</strong> ${req.customerName}</div>
                            <div><strong>Phone:</strong> <a href="tel:${req.customerPhone}" style="color: #1976d2;">${req.customerPhone}</a></div>
                        </div>
                    </div>
                    
                    ${req.vehicle ? `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin-bottom: 10px; color: #1976d2;">ðŸš— Vehicle Information</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div><strong>Year:</strong> ${req.vehicle.year}</div>
                                <div><strong>Color:</strong> ${req.vehicle.color}</div>
                                <div><strong>Make:</strong> ${req.vehicle.make}</div>
                                <div><strong>Model:</strong> ${req.vehicle.model}</div>
                                <div><strong>Plate:</strong> ${req.vehicle.plate}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px; color: #f57c00;">ðŸ“ Location Information</h4>
                        <div style="margin-bottom: 8px;"><strong>Pickup Location:</strong><br>${req.pickupLocation}</div>
                        <div style="margin-bottom: 8px;"><strong>Destination:</strong><br>${req.destination}</div>
                        ${req.keyLocation ? `<div style="margin-bottom: 8px;"><strong>Key Location:</strong><br>${req.keyLocation}</div>` : ''}
                        ${req.customerMeeting ? `<div><strong>Customer Meeting:</strong><br>${req.customerMeeting}</div>` : ''}
                    </div>
                    
                    ${req.assignedProvider ? `
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>ðŸšš Assigned Provider:</strong> ${req.assignedProvider}
                            ${req.providerPhone ? ` (${req.providerPhone})` : ''}
                        </div>
                    ` : ''}
                    
                    ${req.notes ? `
                        <div style="background: #fff9c4; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                            <strong>ðŸ“ Notes:</strong> ${req.notes}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${req.status === 'pending' ? `
                            <button class="action-btn" onclick="assignProvider('${req.id}')">ðŸšš Assign Provider</button>
                        ` : ''}
                        ${req.status !== 'arrived' && req.status !== 'completed' ? `
                            <button class="action-btn" onclick="markArrived('${req.id}')">âœ… Mark Arrived</button>
                        ` : ''}
                        ${req.status === 'arrived' ? `
                            <button class="action-btn" onclick="alert('Customer has been notified via SMS!')">ðŸ“± SMS Sent</button>
                        ` : ''}
                        <button class="action-btn" onclick="alert('Request ID: ${req.id}
Created: ${new Date(req.createdAt).toLocaleString()}
Status: ${req.status}')">ðŸ“… Details</button>
                    </div>
                </div>
            `).join('')}
        `;
    } catch (error) {
        console.error('Error loading towing requests:', error);
        document.getElementById('towingRequestsList').innerHTML = '<div class="card" style="color: red;">Error loading towing requests</div>';
    }
}


async function markArrived(towId) {
        } else {
            alert('Error marking as arrived');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function assignProvider(towId) {
    const providerName = prompt('Enter provider name:');
    if (!providerName) return;
    
    const providerPhone = prompt('Enter provider phone:');
    
    try {
        const response = await fetch(`/api/towing/requests/${towId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ providerName, providerPhone })
        });
        
        if (response.ok) {
            alert('âœ… Provider assigned!');
            loadTowingRequests();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ==================== INVENTORY FUNCTIONS ====================
async function loadInventory() {
    try {
        const response = await fetch('/api/inventory');
        const items = await response.json();
        const container = document.getElementById('inventoryList');
        
        if (items.length === 0) {
            container.innerHTML = '<div class="card"><p>No inventory items found.</p></div>';
            return;
        }
        
        const lowStockCount = items.filter(i => i.quantity <= i.reorderPoint).length;
        
        container.innerHTML = `
            <div class="card">
                <h3>Inventory Overview</h3>
                <p><strong>Total Items:</strong> ${items.length} | <strong>Low Stock:</strong> <span style="color: #e74c3c;">${lowStockCount}</span></p>
                <br>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Part Name</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Category</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Stock</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Price</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr style="border-bottom: 1px solid #e0e0e0; ${item.quantity <= item.reorderPoint ? 'background: #fee;' : ''}">
                                <td style="padding: 12px;">
                                    <strong>${item.name}</strong>
                                    <div style="font-size: 12px; color: #666;">${item.partNumber || 'N/A'}</div>
                                </td>
                                <td style="padding: 12px;">${item.category}</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">
                                    ${item.quantity} ${item.unit}
                                </td>
                                <td style="padding: 12px; text-align: right;">$${item.price.toFixed(2)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    ${item.quantity <= item.reorderPoint ? 
                                        '<span style="background: #e74c3c; color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px;">LOW STOCK</span>' : 
                                        '<span style="background: #27ae60; color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px;">IN STOCK</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading inventory:', error);
        document.getElementById('inventoryList').innerHTML = '<div class="card" style="color: red;">Error loading inventory</div>';
    }
}

async function showLowStock() {
    try {
        const response = await fetch('/api/inventory/low-stock/5');
        const items = await response.json();
        
        if (items.length === 0) {
            alert('âœ… No low stock items! All inventory levels are healthy.');
        } else {
            const message = `âš ï¸ LOW STOCK ALERT (${items.length} items):\n\n` + 
                items.map(i => `â€¢ ${i.name}: ${i.quantity} ${i.unit} (min: ${i.reorderPoint})`).join('\n') +
                '\n\nPlease reorder these items.';
            alert(message);
        }
    } catch (error) {
        alert('Error checking low stock: ' + error.message);
    }
}

// Auto-load when screens are shown
const originalShowScreen = window.showScreen;
window.showScreen = function(screenId) {
    try {
        originalShowScreen(screenId);
        if (screenId === 'towing') loadTowingRequests();
        if (screenId === 'inventory') loadInventory();
        if (screenId === 'customers') loadCustomers();
        if (screenId === 'vehicles') loadAllVehicles();
        if (screenId === 'analytics') loadAnalytics();
    } catch (error) {
        console.error('Error loading screen:', screenId, error);
    }
};

// Initialize system status
function updateSystemStatus() {
    const statusEl = document.getElementById('systemStatus');
    if (statusEl) {
        statusEl.textContent = 'Active';
        statusEl.style.color = '#4caf50';
    }
}

// Update stats on home screen
function updateHomeStats() {
    fetch('/api/customers')
        .then(res => res.json())
        .then(customers => {
            const custEl = document.getElementById('totalCustomers');
            if (custEl) custEl.textContent = customers.length;
        })
        .catch(err => console.log('Error loading customers:', err));
    
    fetch('/api/vehicles')
        .then(res => res.json())
        .then(vehicles => {
            const vehEl = document.getElementById('totalVehicles');
            if (vehEl) vehEl.textContent = vehicles.length;
        })
        .catch(err => console.log('Error loading vehicles:', err));
}

// Initialize on load
window.addEventListener('DOMContentLoaded', () => {
    updateSystemStatus();
    updateHomeStats();
});


// ==================== CUSTOMER FUNCTIONS ====================
async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        const customers = await response.json();
        const container = document.getElementById('customersList');
        
        if (customers.length === 0) {
            container.innerHTML = '<div class="card"><p>No customers found. Add your first customer!</p></div>';
            return;
        }
        
        container.innerHTML = customers.map(customer => `
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin-bottom: 5px;">${customer.firstName} ${customer.lastName}</h3>
                        <p style="color: #666; margin: 5px 0;">
                            <i class="fas fa-phone"></i> <a href="tel:${customer.phone}">${customer.phone}</a>
                        </p>
                        ${customer.email ? `<p style="color: #666; margin: 5px 0;"><i class="fas fa-envelope"></i> ${customer.email}</p>` : ''}
                        ${customer.address ? `<p style="color: #666; margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${customer.address}, ${customer.city}, ${customer.state} ${customer.zip}</p>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <button class="action-btn" onclick="editCustomer('${customer.id}')">âœï¸ Edit</button>
                        <button class="action-btn" onclick="deleteCustomer('${customer.id}')">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
                
                ${customer.vehicles && customer.vehicles.length > 0 ? `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <h4 style="margin-bottom: 10px;">ðŸš— Vehicles (${customer.vehicles.length})</h4>
                        ${customer.vehicles.map(vehicle => `
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${vehicle.year} ${vehicle.color} ${vehicle.make} ${vehicle.model}</strong>
                                    <div style="font-size: 13px; color: #666; margin-top: 3px;">
                                        ${vehicle.plate ? `Plate: ${vehicle.plate}` : ''} 
                                        ${vehicle.mileage ? `| ${vehicle.mileage.toLocaleString()} mi` : ''}
                                        ${vehicle.vin ? `| VIN: ${vehicle.vin}` : ''}
                                    </div>
                                </div>
                                <div>
                                    <button class="action-btn" onclick="editVehicle('${vehicle.id}')" style="padding: 5px 10px; font-size: 12px;">âœï¸</button>
                                    <button class="action-btn" onclick="deleteVehicle('${vehicle.id}')" style="padding: 5px 10px; font-size: 12px;">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="action-btn" onclick="addVehicle('${customer.id}')" style="margin-top: 10px; width: 100%;">
                            âž• Add Vehicle
                        </button>
                    </div>
                ` : `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 10px; text-align: center;">
                        <p style="margin-bottom: 10px; color: #856404;">No vehicles on file for this customer</p>
                        <button class="action-btn" onclick="addVehicle('${customer.id}')">
                            âž• Add First Vehicle
                        </button>
                    </div>
                `}
                
                ${customer.notes ? `
                    <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 14px;">
                        <strong>Notes:</strong> ${customer.notes}
                    </div>
                ` : ''}
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading customers:', error);
        document.getElementById('customersList').innerHTML = '<div class="card" style="color: red;">Error loading customers</div>';
    }
}

async function addCustomer() {
    const firstName = prompt('Customer First Name:');
    if (!firstName) return;
    const lastName = prompt('Customer Last Name:');
    if (!lastName) return;
    const phone = prompt('Phone Number:');
    const email = prompt('Email (optional):') || '';
    const address = prompt('Address (optional):') || '';
    
    try {
        const response = await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ firstName, lastName, phone, email, address })
        });
        
        if (response.ok) {
            alert('âœ… Customer added!');
            loadCustomers();
        } else {
            alert('Error adding customer');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function addVehicle(customerId) {
    const year = prompt('Vehicle Year:');
    if (!year) return;
    const make = prompt('Make:');
    if (!make) return;
    const model = prompt('Model:');
    if (!model) return;
    const color = prompt('Color:') || '';
    const plate = prompt('License Plate:') || '';
    const vin = prompt('VIN (optional):') || '';
    const mileage = prompt('Mileage:') || '';
    
    try {
        const response = await fetch('/api/vehicles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customerId, year, make, model, color, plate, vin, mileage })
        });
        
        if (response.ok) {
            alert('âœ… Vehicle added to customer!');
            loadCustomers();
        } else {
            alert('Error adding vehicle');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function editCustomer(customerId) {
    const response = await fetch(`/api/customers/${customerId}`);
    const customer = await response.json();
    
    const firstName = prompt('First Name:', customer.firstName);
    if (!firstName) return;
    const lastName = prompt('Last Name:', customer.lastName);
    const phone = prompt('Phone:', customer.phone);
    const email = prompt('Email:', customer.email) || '';
    const address = prompt('Address:', customer.address) || '';
    
    try {
        const updateResponse = await fetch(`/api/customers/${customerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ firstName, lastName, phone, email, address })
        });
        
        if (updateResponse.ok) {
            alert('âœ… Customer updated!');
            loadCustomers();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteCustomer(customerId) {
    if (!confirm('Delete this customer and ALL their vehicles?')) return;
    
    try {
        const response = await fetch(`/api/customers/${customerId}`, { method: 'DELETE' });
        if (response.ok) {
            alert('âœ… Customer and vehicles deleted!');
            loadCustomers();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function editVehicle(vehicleId) {
    const response = await fetch(`/api/vehicles/${vehicleId}`);
    const vehicle = await response.json();
    
    const year = prompt('Year:', vehicle.year);
    if (!year) return;
    const make = prompt('Make:', vehicle.make);
    const model = prompt('Model:', vehicle.model);
    const color = prompt('Color:', vehicle.color) || '';
    const plate = prompt('License Plate:', vehicle.plate) || '';
    
    try {
        const updateResponse = await fetch(`/api/vehicles/${vehicleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year, make, model, color, plate })
        });
        
        if (updateResponse.ok) {
            alert('âœ… Vehicle updated!');
            loadCustomers();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteVehicle(vehicleId) {
    if (!confirm('Delete this vehicle?')) return;
    
    try {
        const response = await fetch(`/api/vehicles/${vehicleId}`, { method: 'DELETE' });
        if (response.ok) {
            alert('âœ… Vehicle deleted!');
            loadCustomers();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ==================== VEHICLE SEARCH ====================
async function searchVehicles() {
    const query = document.getElementById('vehicleSearchInput').value;
    if (!query) {
        loadAllVehicles();
        return;
    }
    
    try {
        const response = await fetch(`/api/vehicles/search/${query}`);
        const vehicles = await response.json();
        const container = document.getElementById('vehiclesList');
        
        if (vehicles.length === 0) {
            container.innerHTML = '<div class="card"><p>No vehicles found matching: ' + query + '</p></div>';
            return;
        }
        
        container.innerHTML = vehicles.map(vehicle => `
            <div class="card" style="margin-bottom: 15px; border-left: 4px solid #3498db;">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <h3 style="margin-bottom: 5px;">${vehicle.year} ${vehicle.color} ${vehicle.make} ${vehicle.model}</h3>
                        ${vehicle.plate ? `<p><strong>Plate:</strong> ${vehicle.plate}</p>` : ''}
                        ${vehicle.vin ? `<p><strong>VIN:</strong> ${vehicle.vin}</p>` : ''}
                        ${vehicle.mileage ? `<p><strong>Mileage:</strong> ${vehicle.mileage.toLocaleString()} mi</p>` : ''}
                    </div>
                    <div style="text-align: right;">
                        ${vehicle.customer ? `
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <p style="margin: 5px 0;"><strong>Owner:</strong> ${vehicle.customer.name}</p>
                                <p style="margin: 5px 0;"><strong>Phone:</strong> <a href="tel:${vehicle.customer.phone}">${vehicle.customer.phone}</a></p>
                            </div>
                        ` : '<p style="color: #e74c3c;">No owner linked</p>'}
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error searching vehicles:', error);
    }
}

// ==================== INITIALIZATION ====================
function initializeInventory() {
    // Check if inventory is empty, add sample items if so
    fetch('/api/inventory')
        .then(res => res.json())
        .then(items => {
            if (items.length === 0) {
                // Add sample inventory items
                const sampleItems = [
                    {
                        name: 'Brake Pads - Front',
                        partNumber: 'BRK-F-001',
                        category: 'Brakes',
                        quantity: 25,
                        unit: 'set',
                        cost: 45.00,
                        price: 67.50,
                        reorderPoint: 10,
                        supplier: 'AutoParts Co',
                        location: 'Aisle 3'
                    },
                    {
                        name: 'Oil Filter - Synthetic',
                        partNumber: 'OIL-SYN-001',
                        category: 'Filters',
                        quantity: 50,
                        unit: 'each',
                        cost: 8.50,
                        price: 12.75,
                        reorderPoint: 20,
                        supplier: 'Parts Direct',
                        location: 'Aisle 1'
                    },
                    {
                        name: 'Spark Plug - Iridium',
                        partNumber: 'SPK-IRD-001',
                        category: 'Ignition',
                        quantity: 100,
                        unit: 'each',
                        cost: 6.00,
                        price: 9.00,
                        reorderPoint: 30,
                        supplier: 'AutoParts Co',
                        location: 'Aisle 2'
                    },
                    {
                        name: 'Air Filter - Engine',
                        partNumber: 'AIR-ENG-001',
                        category: 'Filters',
                        quantity: 30,
                        unit: 'each',
                        cost: 12.00,
                        price: 18.00,
                        reorderPoint: 10,
                        supplier: 'Parts Direct',
                        location: 'Aisle 1'
                    },
                    {
                        name: 'Battery - 12V',
                        partNumber: 'BAT-12V-001',
                        category: 'Electrical',
                        quantity: 15,
                        unit: 'each',
                        cost: 85.00,
                        price: 127.50,
                        reorderPoint: 5,
                        supplier: 'Battery World',
                        location: 'Aisle 4'
                    },
                    {
                        name: 'Wiper Blades - 22 inch',
                        partNumber: 'WIP-22-001',
                        category: 'Wipers',
                        quantity: 40,
                        unit: 'pair',
                        cost: 15.00,
                        price: 22.50,
                        reorderPoint: 15,
                        supplier: 'AutoParts Co',
                        location: 'Aisle 5'
                    }
                ];
                
                sampleItems.forEach(item => {
                    fetch('/api/inventory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    }).catch(err => console.log('Item already exists:', err));
                });
                
                // Reload after adding
                setTimeout(() => loadInventory(), 1000);
            }
        })
        .catch(err => console.log('Error checking inventory:', err));
}

// Call this when page loads
window.addEventListener('DOMContentLoaded', () => {
    initializeInventory();
});


// ==================== ANALYTICS FUNCTIONS ====================
async function loadAnalytics() {
    try {
        const period = document.getElementById('analyticsPeriod').value;
        const container = document.getElementById('analyticsContent');
        
        // Get data from all endpoints
        const [customers, vehicles, inventory, towing] = await Promise.all([
            fetch('/api/customers').then(r => r.json()),
            fetch('/api/vehicles').then(r => r.json()),
            fetch('/api/inventory').then(r => r.json()),
            fetch('/api/towing/requests').then(r => r.json())
        ]);
        
        // Calculate metrics
        const totalCustomers = customers.length;
        const totalVehicles = vehicles.length;
        const totalInventoryItems = inventory.reduce((sum, item) => sum + item.quantity, 0);
        const totalInventoryValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const towingPending = towing.filter(t => t.status === 'pending').length;
        const towingArrived = towing.filter(t => t.status === 'arrived').length;
        
        // Mock revenue data (in real app, this would come from estimates/invoices)
        const revenue = {
            today: 1250.00,
            week: 8750.00,
            month: 28500.00,
            year: 245000.00
        }[period];
        
        const profit = revenue * 0.35; // 35% profit margin
        
        container.innerHTML = `
            <!-- KPI Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="card" style="margin-bottom: 0; border-top: 4px solid #4caf50;">
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ðŸ’° Revenue</div>
                    <div style="font-size: 32px; font-weight: bold; color: #4caf50;">$${revenue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">${period === 'today' ? 'Today' : period === 'week' ? 'This week' : period === 'month' ? 'This month' : 'This year'}</div>
                    <div style="color: #4caf50; font-size: 12px; margin-top: 5px;">+12.5% from last ${period}</div>
                </div>
                
                <div class="card" style="margin-bottom: 0; border-top: 4px solid #2196f3;">
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ðŸ“ˆ Profit</div>
                    <div style="font-size: 32px; font-weight: bold; color: #2196f3;">$${profit.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">35% profit margin</div>
                </div>
                
                <div class="card" style="margin-bottom: 0; border-top: 4px solid #ff9800;">
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ðŸ‘¥ Customers</div>
                    <div style="font-size: 32px; font-weight: bold; color: #ff9800;">${totalCustomers}</div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">${vehicles.length} vehicles on file</div>
                    <div style="color: #4caf50; font-size: 12px; margin-top: 5px;">+8 this week</div>
                </div>
                
                <div class="card" style="margin-bottom: 0; border-top: 4px solid #9c27b0;">
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">ðŸ“¦ Inventory</div>
                    <div style="font-size: 32px; font-weight: bold; color: #9c27b0;">${totalInventoryItems}</div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">items in stock</div>
                    <div style="color: #4caf50; font-size: 12px; margin-top: 5px;">Value: $${totalInventoryValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Revenue Chart -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">ðŸ“Š Revenue Trend</h3>
                    <div style="height: 250px; display: flex; align-items: flex-end; justify-content: space-around; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                        ${generateRevenueBars(period)}
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 12px; color: #666;">
                        ${generateLabels(period)}
                    </div>
                </div>
                
                <!-- Services Breakdown -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">ðŸ”§ Services Breakdown</h3>
                    <div style="padding: 20px;">
                        ${generateServiceBreakdown()}
                    </div>
                </div>
            </div>
            
            <!-- Activity Table -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">ðŸ“‹ Recent Activity</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left;">Activity</th>
                            <th style="padding: 12px; text-align: left;">Details</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: right;">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px;">
                                <span style="background: #e8f5e9; color: #388e3c; padding: 4px 10px; border-radius: 15px; font-size: 12px;">Estimate Approved</span>
                            </td>
                            <td style="padding: 12px;">Brake replacement - John Smith (Ford F-150)</td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; color: #4caf50;">+$485.00</td>
                            <td style="padding: 12px; text-align: right; color: #666;">2 hours ago</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px;">
                                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 15px; font-size: 12px;">Appointment</span>
                            </td>
                            <td style="padding: 12px;">Oil change scheduled - Mary Johnson (Toyota Camry)</td>
                            <td style="padding: 12px; text-align: right;">$75.00</td>
                            <td style="padding: 12px; text-align: right; color: #666;">4 hours ago</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px;">
                                <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 15px; font-size: 12px;">Towing</span>
                            </td>
                            <td style="padding: 12px;">Vehicle arrived - John Smith (Ford F-150)</td>
                            <td style="padding: 12px; text-align: right;">$125.00</td>
                            <td style="padding: 12px; text-align: right; color: #666;">6 hours ago</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 12px;">
                                <span style="background: #e8f5e9; color: #388e3c; padding: 4px 10px; border-radius: 15px; font-size: 12px;">Invoice Paid</span>
                            </td>
                            <td style="padding: 12px;">Engine repair - Bob Wilson (Chevrolet Silverado)</td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; color: #4caf50;">+$1,250.00</td>
                            <td style="padding: 12px; text-align: right; color: #666;">Yesterday</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px;">
                                <span style="background: #f3e5f5; color: #9c27b0; padding: 4px 10px; border-radius: 15px; font-size: 12px;">New Customer</span>
                            </td>
                            <td style="padding: 12px;">Customer registered - Lisa Anderson</td>
                            <td style="padding: 12px; text-align: right;">-</td>
                            <td style="padding: 12px; text-align: right; color: #666;">Yesterday</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Towing Status -->
            ${towing.length > 0 ? `
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 20px;">ðŸšš Towing Status</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${towingPending}</div>
                        <div style="color: #666; font-size: 14px;">Pending</div>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${towing.filter(t => t.status === 'assigned').length}</div>
                        <div style="color: #666; font-size: 14px;">Assigned</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #e67e22;">${towing.filter(t => t.status === 'in_progress').length}</div>
                        <div style="color: #666; font-size: 14px;">In Progress</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${towingArrived}</div>
                        <div style="color: #666; font-size: 14px;">Arrived</div>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsContent').innerHTML = '<div class="card" style="color: red;">Error loading analytics</div>';
    }
}

function generateRevenueBars(period) {
    const data = {
        today: [100, 150, 200, 250, 300, 250],
        week: [800, 950, 1100, 1250, 1050, 1400, 1200],
        month: [8500, 9200, 10500, 11000, 9800, 12000, 11500, 10800, 9500, 11200, 12500, 11800, 10200, 11000, 12800, 12000, 11500, 9800, 13200, 12500, 11000, 11800, 13500, 12200, 10800, 11500, 13000, 12500, 11800, 11000],
        year: [18500, 19800, 22500, 24200, 23800, 26500, 25800, 24100, 23500, 25200, 28500, 27800]
    }[period];
    
    const max = Math.max(...data);
    
    return data.map(value => {
        const height = (value / max) * 200;
        const color = value >= max * 0.8 ? '#4caf50' : value >= max * 0.6 ? '#2196f3' : '#ff9800';
        return `<div style="width: 30px; height: ${height}px; background: ${color}; border-radius: 4px 4px 0 0; position: relative; min-width: 20px;" title="$${value}">
            <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #666; writing-mode: vertical-rl; text-orientation: mixed;">$${(value/1000).toFixed(1)}k</div>
        </div>`;
    }).join('');
}

function generateLabels(period) {
    const labels = {
        today: ['8AM', '10AM', '12PM', '2PM', '4PM', '6PM'],
        week: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        month: Array.from({length: 30}, (_, i) => (i + 1).toString()),
        year: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    }[period];
    
    // Show fewer labels if there are many
    const showEvery = labels.length > 12 ? Math.ceil(labels.length / 12) : 1;
    
    return labels.filter((_, i) => i % showEvery === 0).join('  ');
}

function generateServiceBreakdown() {
    const services = [
        { name: 'Oil Change', count: 45, revenue: 3375, color: '#4caf50' },
        { name: 'Brake Service', count: 28, revenue: 7000, color: '#2196f3' },
        { name: 'Engine Repair', count: 15, revenue: 8750, color: '#ff9800' },
        { name: 'Tires', count: 22, revenue: 5500, color: '#9c27b0' },
        { name: 'Electrical', count: 18, revenue: 2700, color: '#e91e63' },
        { name: 'Other', count: 32, revenue: 4160, color: '#607d8b' }
    ];
    
    const totalRevenue = services.reduce((sum, s) => sum + s.revenue, 0);
    
    return services.map(service => {
        const percentage = ((service.revenue / totalRevenue) * 100).toFixed(1);
        return `
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="font-weight: 500;">${service.name}</span>
                    <span style="color: #666;">${service.count} jobs â€¢ $${service.revenue.toLocaleString()} (${percentage}%)</span>
                </div>
                <div style="width: 100%; height: 10px; background: #f5f5f5; border-radius: 5px; overflow: hidden;">
                    <div style="width: ${percentage}%; height: 100%; background: ${service.color}; border-radius: 5px;"></div>
                </div>
            </div>
        `;
    }).join('');
}


// ==================== ESTIMATE & INVOICE FUNCTIONS ====================
let estimates = [];
let invoices = [];

// Initialize with sample data
function initializeEstimatesInvoices() {
    // Add sample estimates
    estimates = [
        {
            id: 'EST1234567890',
            customerId: 'CUST1234567890',
            vehicleId: 'VEH1234567890',
            customerName: 'John Smith',
            vehicle: '2022 Blue Ford F-150',
            status: 'pending',
            items: [
                { name: 'Brake Pads - Front', quantity: 1, price: 120.00 },
                { name: 'Labor - Brake Installation', hours: 2, hourlyRate: 100.00 },
                { name: 'Shop Supplies', price: 15.00 }
            ],
            laborRate: 100,
            partsMarkup: 30,
            taxRate: 8.5,
            subtotal: 335.00,
            tax: 28.48,
            total: 363.48,
            notes: 'Customer prefers OEM parts',
            createdAt: '2026-02-09T10:30:00.000Z',
            validUntil: '2026-02-23T10:30:00.000Z'
        }
    ];
    
    // Add sample invoices
    invoices = [
        {
            id: 'INV0987654321',
            customerId: 'CUST0987654321',
            vehicleId: 'VEH0987654321',
            customerName: 'Mary Johnson',
            vehicle: '2020 Silver Toyota Camry',
            status: 'paid',
            items: [
                { name: 'Oil Change - Synthetic', price: 75.00 },
                { name: 'Oil Filter', price: 12.75 },
                { name: 'Labor - Oil Change', hours: 0.5, hourlyRate: 100.00 }
            ],
            subtotal: 137.75,
            tax: 11.71,
            total: 149.46,
            paidDate: '2026-02-08T14:30:00.000Z',
            paymentMethod: 'Credit Card',
            createdAt: '2026-02-08T14:00:00.000Z'
        }
    ];
}

async function loadEstimates() {
    const container = document.getElementById('estimatesList');
    
    if (estimates.length === 0) {
        initializeEstimatesInvoices();
    }
    
    if (estimates.length === 0) {
        container.innerHTML = '<div class="card"><p>No estimates found. Create your first estimate!</p></div>';
        return;
    }
    
    container.innerHTML = estimates.map(estimate => `
        <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${estimate.status === 'approved' ? '#4caf50' : estimate.status === 'rejected' ? '#f44336' : '#ff9800'}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h3 style="margin-bottom: 5px;">${estimate.id}</h3>
                    <p style="color: #666; font-size: 14px;">
                        <strong>Customer:</strong> ${estimate.customerName}<br>
                        <strong>Vehicle:</strong> ${estimate.vehicle}
                    </p>
                </div>
                <div style="text-align: right;">
                    <span style="padding: 8px 20px; border-radius: 20px; background: ${estimate.status === 'approved' ? '#4caf50' : estimate.status === 'rejected' ? '#f44336' : '#ff9800'}; color: white; font-weight: bold;">
                        ${estimate.status.toUpperCase()}
                    </span>
                    <div style="font-size: 20px; font-weight: bold; color: #4caf50; margin-top: 10px;">$${estimate.total.toFixed(2)}</div>
                </div>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px;">Items</h4>
                ${estimate.items.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e0e0e0;">
                        <div>${item.name} ${item.quantity ? `Ã— ${item.quantity}` : ''} ${item.hours ? `(${item.hours} hrs @ $${item.hourlyRate}/hr)` : ''}</div>
                        <div style="font-weight: bold;">$${(item.price || item.hours * item.hourlyRate).toFixed(2)}</div>
                    </div>
                `).join('')}
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #ddd; margin-top: 10px;">
                    <div>Subtotal</div>
                    <div>$${estimate.subtotal.toFixed(2)}</div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                    <div>Tax (${estimate.taxRate}%)</div>
                    <div>$${estimate.tax.toFixed(2)}</div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #ddd; font-weight: bold;">
                    <div>Total</div>
                    <div style="color: #4caf50;">$${estimate.total.toFixed(2)}</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" onclick="viewEstimate('${estimate.id}')">ðŸ“„ View</button>
                <button class="action-btn" onclick="printEstimate('${estimate.id}')">ðŸ–¨ï¸ Print</button>
                ${estimate.status === 'pending' ? `
                    <button class="action-btn" onclick="approveEstimate('${estimate.id}')" style="background: #4caf50;">âœ… Approve</button>
                    <button class="action-btn" onclick="rejectEstimate('${estimate.id}')" style="background: #f44336;">âŒ Reject</button>
                    <button class="action-btn" onclick="convertToInvoice('${estimate.id}')">ðŸ§¾ Create Invoice</button>
                ` : ''}
                <button class="action-btn" onclick="editEstimate('${estimate.id}')">âœï¸ Edit</button>
                <button class="action-btn" onclick="deleteEstimate('${estimate.id}')">ðŸ—‘ï¸ Delete</button>
            </div>
        </div>
    `).join('');
}

async function loadInvoices() {
    const container = document.getElementById('invoicesList');
    
    if (invoices.length === 0) {
        initializeEstimatesInvoices();
    }
    
    if (invoices.length === 0) {
        container.innerHTML = '<div class="card"><p>No invoices found. Create your first invoice!</p></div>';
        return;
    }
    
    container.innerHTML = invoices.map(invoice => `
        <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${invoice.status === 'paid' ? '#4caf50' : '#ff9800'}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h3 style="margin-bottom: 5px;">${invoice.id}</h3>
                    <p style="color: #666; font-size: 14px;">
                        <strong>Customer:</strong> ${invoice.customerName}<br>
                        <strong>Vehicle:</strong> ${invoice.vehicle}
                    </p>
                </div>
                <div style="text-align: right;">
                    <span style="padding: 8px 20px; border-radius: 20px; background: ${invoice.status === 'paid' ? '#4caf50' : '#ff9800'}; color: white; font-weight: bold;">
                        ${invoice.status.toUpperCase()}
                    </span>
                    <div style="font-size: 20px; font-weight: bold; color: #4caf50; margin-top: 10px;">$${invoice.total.toFixed(2)}</div>
                    ${invoice.status === 'paid' ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">Paid: ${new Date(invoice.paidDate).toLocaleDateString()}</div>` : ''}
                </div>
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px;">Items</h4>
                ${invoice.items.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e0e0e0;">
                        <div>${item.name} ${item.hours ? `(${item.hours} hrs)` : ''}</div>
                        <div style="font-weight: bold;">$${(item.price || item.hours * item.hourlyRate).toFixed(2)}</div>
                    </div>
                `).join('')}
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid #ddd; font-weight: bold;">
                    <div>Total</div>
                    <div style="color: #4caf50;">$${invoice.total.toFixed(2)}</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" onclick="viewInvoice('${invoice.id}')">ðŸ“„ View</button>
                <button class="action-btn" onclick="printInvoice('${invoice.id}')">ðŸ–¨ï¸ Print</button>
                ${invoice.status === 'unpaid' ? `
                    <button class="action-btn" onclick="markAsPaid('${invoice.id}')" style="background: #4caf50;">âœ… Mark Paid</button>
                    <button class="action-btn" onclick="sendInvoice('${invoice.id}')">ðŸ“§ Send to Customer</button>
                ` : ''}
                <button class="action-btn" onclick="editInvoice('${invoice.id}')">âœï¸ Edit</button>
            </div>
        </div>
    `).join('');
}

function createNewEstimate() {
    const customerName = prompt('Customer Name:');
    if (!customerName) return;
    const vehicle = prompt('Vehicle (e.g., 2022 Blue Ford F-150):');
    if (!vehicle) return;
    
    const newEstimate = {
        id: 'EST' + Date.now(),
        customerId: 'CUST' + Date.now(),
        vehicleId: 'VEH' + Date.now(),
        customerName,
        vehicle,
        status: 'pending',
        items: [
            { name: 'Labor', hours: 1, hourlyRate: 100 }
        ],
        laborRate: 100,
        partsMarkup: 30,
        taxRate: 8.5,
        subtotal: 100,
        tax: 8.50,
        total: 108.50,
        notes: '',
        createdAt: new Date().toISOString(),
        validUntil: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString()
    };
    
    estimates.push(newEstimate);
    loadEstimates();
    alert('âœ… Estimate created! You can now add items and edit details.');
}

function createNewInvoice() {
    const customerName = prompt('Customer Name:');
    if (!customerName) return;
    const vehicle = prompt('Vehicle (e.g., 2022 Blue Ford F-150):');
    if (!vehicle) return;
    
    const newInvoice = {
        id: 'INV' + Date.now(),
        customerId: 'CUST' + Date.now(),
        vehicleId: 'VEH' + Date.now(),
        customerName,
        vehicle,
        status: 'unpaid',
        items: [
            { name: 'Labor', hours: 1, hourlyRate: 100 }
        ],
        subtotal: 100,
        tax: 8.50,
        total: 108.50,
        createdAt: new Date().toISOString()
    };
    
    invoices.push(newInvoice);
    loadInvoices();
    alert('âœ… Invoice created! You can now add items and edit details.');
}

function approveEstimate(estimateId) {
    const estimate = estimates.find(e => e.id === estimateId);
    if (estimate && confirm('Approve this estimate?')) {
        estimate.status = 'approved';
        loadEstimates();
        alert('âœ… Estimate approved!');
    }
}

function rejectEstimate(estimateId) {
    const estimate = estimates.find(e => e.id === estimateId);
    if (estimate && confirm('Reject this estimate?')) {
        estimate.status = 'rejected';
        loadEstimates();
        alert('âŒ Estimate rejected.');
    }
}

function convertToInvoice(estimateId) {
    const estimate = estimates.find(e => e.id === estimateId);
    if (estimate && confirm('Convert this estimate to an invoice?')) {
        const newInvoice = {
            id: 'INV' + Date.now(),
            customerId: estimate.customerId,
            vehicleId: estimate.vehicleId,
            customerName: estimate.customerName,
            vehicle: estimate.vehicle,
            status: 'unpaid',
            items: [...estimate.items],
            subtotal: estimate.subtotal,
            tax: estimate.tax,
            total: estimate.total,
            createdAt: new Date().toISOString()
        };
        
        estimate.status = 'converted';
        invoices.push(newInvoice);
        loadEstimates();
        alert('âœ… Estimate converted to invoice!');
    }
}

function markAsPaid(invoiceId) {
    const invoice = invoices.find(i => i.id === invoiceId);
    if (invoice && confirm('Mark this invoice as paid?')) {
        invoice.status = 'paid';
        invoice.paidDate = new Date().toISOString();
        invoice.paymentMethod = prompt('Payment method (Cash, Credit Card, Check, etc.):') || 'Cash';
        loadInvoices();
        alert('âœ… Invoice marked as paid!');
    }
}

function viewEstimate(estimateId) {
    const estimate = estimates.find(e => e.id === estimateId);
    if (estimate) {
        alert(`Estimate: ${estimate.id}\n\nCustomer: ${estimate.customerName}\nVehicle: ${estimate.vehicle}\n\nTotal: $${estimate.total.toFixed(2)}\n\nItems:\n${estimate.items.map(i => `- ${i.name}: $${(i.price || i.hours * i.hourlyRate).toFixed(2)}`).join('\n')}`);
    }
}

function viewInvoice(invoiceId) {
    const invoice = invoices.find(i => i.id === invoiceId);
    if (invoice) {
        alert(`Invoice: ${invoice.id}\n\nCustomer: ${invoice.customerName}\nVehicle: ${invoice.vehicle}\nStatus: ${invoice.status}\n\nTotal: $${invoice.total.toFixed(2)}\n\nItems:\n${invoice.items.map(i => `- ${i.name}: $${(i.price || i.hours * i.hourlyRate).toFixed(2)}`).join('\n')}`);
    }
}

function printEstimate(estimateId) {
    alert('ðŸ–¨ï¸ Printing estimate ' + estimateId + '...\n\n(This would open a print dialog with a formatted estimate)');
}

function printInvoice(invoiceId) {
    alert('ðŸ–¨ï¸ Printing invoice ' + invoiceId + '...\n\n(This would open a print dialog with a formatted invoice)');
}

function editEstimate(estimateId) {
    alert('âœï¸ Edit estimate: ' + estimateId + '\n\n(This would open a modal to edit estimate items and details)');
}

function editInvoice(invoiceId) {
    alert('âœï¸ Edit invoice: ' + invoiceId + '\n\n(This would open a modal to edit invoice items and details)');
}

function deleteEstimate(estimateId) {
    if (confirm('Delete this estimate?')) {
        estimates = estimates.filter(e => e.id !== estimateId);
        loadEstimates();
        alert('ðŸ—‘ï¸ Estimate deleted.');
    }
}

function sendInvoice(invoiceId) {
    const invoice = invoices.find(i => i.id === invoiceId);
    if (invoice) {
        alert(`ðŸ“§ Sending invoice to ${invoice.customerName}...\n\n(This would send the invoice via email)`);
    }
}

function searchCustomers(query) {
    if (!query) {
        loadCustomers();
        return;
    }
    
    // Filter customers by name or phone
    fetch('/api/customers')
        .then(res => res.json())
        .then(allCustomers => {
            const filtered = allCustomers.filter(c => 
                c.firstName?.toLowerCase().includes(query.toLowerCase()) ||
                c.lastName?.toLowerCase().includes(query.toLowerCase()) ||
                c.phone?.includes(query)
            );
            displayFilteredCustomers(filtered);
        })
        .catch(err => console.error('Error searching:', err));
}

function displayFilteredCustomers(customers) {
    const container = document.getElementById('customersList');
    // Reuse the loadCustomers display logic with filtered list
    // (This would call the same display function with filtered data)
    if (customers.length === 0) {
        container.innerHTML = '<div class="card"><p>No customers found matching: ' + query + '</p></div>';
    }
}

function loadAllVehicles() {
    // Redirect to customers screen with vehicles
    showScreen('customers');
    alert('Vehicles are now displayed with their owners in the Customers screen!');
}
</script>
</body>
</html>
