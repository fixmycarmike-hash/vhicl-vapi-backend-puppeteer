<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHICL Pro - Auto Shop Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .navbar {
            background: #0a2540;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand i {
            color: #00d4ff;
        }

        .nav-links {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: #a0aec0;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #1e40af;
            color: white;
        }

        .nav-btn.active {
            background: #00d4ff;
            color: #0a2540;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .card-btn {
            background: #00d4ff;
            color: #0a2540;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }

        .card-btn:hover {
            background: #00b8e6;
        }

        .stats-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .section-header {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1a202c;
        }

        .action-btn {
            background: #00d4ff;
            color: #0a2540;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background: #00b8e6;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #2f855a;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .data-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item-title {
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .data-item-subtitle {
            color: #718096;
            font-size: 0.9rem;
        }

        .data-item-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: #edf2f7;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #e2e8f0;
        }

        .icon-btn.delete {
            background: #fed7d7;
            color: #c53030;
        }

        .icon-btn.delete:hover {
            background: #feb2b2;
        }
    </style>

</head>
<body>
    <div class="navbar">
        <div class="nav-brand">
            <i class="fas fa-car"></i>
            VHICL Pro
        </div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="showScreen('home')">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="nav-btn" onclick="showScreen('quickQuote')">
                <i class="fas fa-bolt"></i> Quick Quote
            </button>
            <button class="nav-btn" onclick="showScreen('customers')">
                <i class="fas fa-users"></i> Customers
            </button>
            <button class="nav-btn" onclick="showScreen('vehicles')">
                <i class="fas fa-car-side"></i> Vehicles
            </button>
            <button class="nav-btn" onclick="showScreen('appointments')">
                <i class="fas fa-calendar"></i> Appointments
            </button>
               <button class="nav-btn" onclick="showScreen('towing')">
                   <i class="fas fa-truck-pickup"></i> Towing
               </button>
               <button class="nav-btn" onclick="showScreen('inventory')">
                   <i class="fas fa-boxes"></i> Inventory
               </button>
            <button class="nav-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Customers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalVehicles">0</div>
                        <div class="stat-label">Vehicles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalAppointments">0</div>
                        <div class="stat-label">Appointments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="systemStatus">Active</div>
                        <div class="stat-label">System Status</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-icon" style="background: #e3f2fd; color: #1976d2;">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="card-title">Quick Quote</div>
                    <div class="card-description">Get instant estimates with real-time parts pricing and labor times</div>
                    <button class="card-btn" onclick="showScreen('quickQuote')">
                        <i class="fas fa-arrow-right"></i> Create Quote
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #f3e5f5; color: #7b1fa2;">
                        <i class="fas fa-phone-volume"></i>
                    </div>
                    <div class="card-title">ALEX Voice Assistant</div>
                    <div class="card-description">Automated phone calls for parts pricing and customer service</div>
                    <button class="card-btn" onclick="showScreen('appointments')">
                        <i class="fas fa-arrow-right"></i> Manage ALEX
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #e8f5e9; color: #388e3c;">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div class="card-title">Labor Service</div>
                    <div class="card-description">30+ pre-populated repair operations with industry-standard times</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> View Labor Ops
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #fff3e0; color: #f57c00;">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="card-title">Parts Stores</div>
                    <div class="card-description">Manage local parts stores and pricing sources</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> Configure Stores
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #fce4ec; color: #c2185b;">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="card-title">Email Notifications</div>
                    <div class="card-description">Send confirmations, quotes, and updates to customers</div>
                    <button class="card-btn" onclick="window.location.href='settings-with-api-inventory.html'">
                        <i class="fas fa-arrow-right"></i> Configure Email
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon" style="background: #e0f2f1; color: #00796b;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-title">Analytics</div>
                    <div class="card-description">Track performance, revenue, and shop metrics</div>
                    <button class="card-btn" onclick="alert('Analytics coming soon!')">
                        <i class="fas fa-arrow-right"></i> View Stats
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Quote Screen -->
        <div id="quickQuoteScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-bolt"></i> Quick Quote
                </div>
                <button class="action-btn" onclick="resetQuoteForm()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>

            <div class="form-container">
                <div class="form-group">
                    <label class="form-label">Vehicle Information</label>
                    <input type="text" class="form-input" id="quoteVehicle" placeholder="Year Make Model (e.g., 2020 Toyota Camry)">
                </div>

                <div class="form-group">
                    <label class="form-label">Service Needed</label>
                    <input type="text" class="form-input" id="quoteService" placeholder="Describe the service (e.g., Brake pads replacement)">
                </div>

                <div class="form-group">
                    <label class="form-label">Customer Email (Optional)</label>
                    <input type="email" class="form-input" id="quoteEmail" placeholder="customer@email.com">
                </div>

                <button class="card-btn" onclick="generateQuote()">
                    <i class="fas fa-calculator"></i> Generate Quote
                </button>
            </div>

            <div id="quoteResults" style="display: none;">
                <div class="form-container">
                    <h3 style="margin-bottom: 1rem;">Quote Results</h3>
                    <div id="quoteDetails"></div>
                </div>
            </div>
        </div>

        <!-- Customers Screen -->
        <div id="customersScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-users"></i> Customers
                </div>
                <button class="action-btn" onclick="showAddCustomerForm()">
                    <i class="fas fa-plus"></i> Add Customer
                </button>
            </div>

            <div id="customersList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading customers...</p>
                </div>
            </div>
        </div>

        <!-- Vehicles Screen -->
        <div id="vehiclesScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-car-side"></i> Vehicles
                </div>
                <button class="action-btn" onclick="showAddVehicleForm()">
                    <i class="fas fa-plus"></i> Add Vehicle
                </button>
            </div>

            <div id="vehiclesList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading vehicles...</p>
                </div>
            </div>
        </div>

        <!-- Appointments Screen -->
        <div id="appointmentsScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-calendar"></i> Appointments
                </div>
                <button class="action-btn" onclick="showAddAppointmentForm()">
                    <i class="fas fa-plus"></i> Add Appointment
                </button>
            </div>

            <div id="appointmentsList" class="data-list">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading appointments...</p>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-cog"></i> Shop Settings
                </div>
                <button class="action-btn" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Shop Information</h3>
                <div class="form-group">
                    <label class="form-label">Shop Name</label>
                    <input type="text" class="form-input" id="settingsShopName" placeholder="Your Shop Name">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Phone</label>
                    <input type="tel" class="form-input" id="settingsShopPhone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Email</label>
                    <input type="email" class="form-input" id="settingsShopEmail" placeholder="shop@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Shop Address</label>
                    <input type="text" class="form-input" id="settingsShopAddress" placeholder="123 Main St, City, State ZIP">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Pricing</h3>
                <div class="form-group">
                    <label class="form-label">Labor Rate ($/hour)</label>
                    <input type="number" class="form-input" id="settingsLaborRate" placeholder="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" class="form-input" id="settingsTaxRate" placeholder="8" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">Diagnostic Fee ($)</label>
                    <input type="number" class="form-input" id="settingsDiagnosticFee" placeholder="50">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">API Configuration</h3>
                <div class="form-group">
                    <label class="form-label">VAPI API Key</label>
                    <input type="password" class="form-input" id="settingsVapiKey" placeholder="Enter VAPI API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">SendGrid API Key</label>
                    <input type="password" class="form-input" id="settingsSendgridKey" placeholder="Enter SendGrid API Key">
                </div>
            </div>

            <div class="form-container">
                <h3 style="margin-bottom: 1rem;">Labor Operations</h3>
                <div id="laborOperationsList" class="data-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading labor operations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = window.location.origin + '/api';

        // Navigation
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');

            // Add active class to clicked button
            const clickedBtn = event.target.closest('.nav-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }

            // Load data for specific screens
            if (screenId === 'home') loadDashboardStats();
            if (screenId === 'customers') loadCustomers();
            if (screenId === 'vehicles') loadVehicles();
            if (screenId === 'appointments') loadAppointments();
            if (screenId === 'settings') loadSettings();
        }

        // Dashboard Stats
        async function loadDashboardStats() {
            try {
                // Try to get stats from backend
                const healthResponse = await fetch(`${API_BASE}/health`);
                if (healthResponse.ok) {
                    document.getElementById('systemStatus').textContent = 'Active';
                    document.getElementById('systemStatus').style.color = '#38a169';
                } else {
                    document.getElementById('systemStatus').textContent = 'Error';
                    document.getElementById('systemStatus').style.color = '#e53e3e';
                }

                // For demo, set random stats
                document.getElementById('totalCustomers').textContent = Math.floor(Math.random() * 50) + 10;
                document.getElementById('totalVehicles').textContent = Math.floor(Math.random() * 100) + 20;
                document.getElementById('totalAppointments').textContent = Math.floor(Math.random() * 30) + 5;

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('systemStatus').textContent = 'Offline';
                document.getElementById('systemStatus').style.color = '#e53e3e';
            }
        }

        // Quick Quote
        async function generateQuote() {
            const vehicle = document.getElementById('quoteVehicle').value;
            const service = document.getElementById('quoteService').value;
            const email = document.getElementById('quoteEmail').value;

            if (!vehicle || !service) {
                alert('Please fill in vehicle and service information');
                return;
            }

            try {
                // Get labor estimate from backend
                const laborResponse = await fetch(`${API_BASE}/labor/quick-estimate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: service })
                });
                let laborCost = 0;
                let laborTime = 0;

                if (laborResponse.ok) {
                    const laborData = await laborResponse.json();
                    laborCost = laborData.laborCost || 0;
                    laborTime = laborData.laborTime || 0;
                }

                // Calculate parts estimate (demo)
                const partsCost = Math.floor(Math.random() * 200) + 50;

                // Calculate totals
                const subtotal = laborCost + partsCost;
                const tax = subtotal * 0.08;
                const total = subtotal + tax;

                // Display results
                document.getElementById('quoteResults').style.display = 'block';
                document.getElementById('quoteDetails').innerHTML = `
                    <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: #2d3748;">${vehicle}</h4>
                        <p style="color: #718096; margin-bottom: 1rem;">${service}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Labor Time:</strong><br>
                                ${laborTime} hours
                            </div>
                            <div>
                                <strong>Labor Cost:</strong><br>
                                $${laborCost.toFixed(2)}
                            </div>
                            <div>
                                <strong>Parts Estimate:</strong><br>
                                $${partsCost.toFixed(2)}
                            </div>
                            <div>
                                <strong>Tax (8%):</strong><br>
                                $${tax.toFixed(2)}
                            </div>
                        </div>
                        
                        <div style="background: #00d4ff; color: #0a2540; padding: 1rem; border-radius: 8px; text-align: center;">
                            <strong>Estimated Total: $${total.toFixed(2)}</strong>
                        </div>
                        
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #718096;">
                            * This is an estimate. Final price may vary based on actual parts and labor.
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error('Error generating quote:', error);
                alert('Error generating quote. Please try again.');
            }
        }

        function resetQuoteForm() {
            document.getElementById('quoteVehicle').value = '';
            document.getElementById('quoteService').value = '';
            document.getElementById('quoteEmail').value = '';
            document.getElementById('quoteResults').style.display = 'none';
        }

        // Customers
        async function loadCustomers() {
            const listContainer = document.getElementById('customersList');
            
            try {
                const response = await fetch(`${API_BASE}/customers`);
                
                if (response.ok) {
                    const customers = await response.json();
                    displayCustomers(customers);
                } else {
                    // Show demo data
                    displayDemoCustomers();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                displayDemoCustomers();
            }
        }

        function displayCustomers(customers) {
            const listContainer = document.getElementById('customersList');
            
            if (customers.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No customers yet. Add your first customer!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = customers.map(customer => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${customer.name}</div>
                        <div class="data-item-subtitle">${customer.email} | ${customer.phone}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewCustomer('${customer.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteCustomer('${customer.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoCustomers() {
            const demoCustomers = [
                { id: 1, name: 'John Smith', email: 'john@email.com', phone: '(555) 123-4567' },
                { id: 2, name: 'Jane Doe', email: 'jane@email.com', phone: '(555) 987-6543' },
                { id: 3, name: 'Mike Johnson', email: 'mike@email.com', phone: '(555) 456-7890' }
            ];
            displayCustomers(demoCustomers);
        }

        function showAddCustomerForm() {
            const name = prompt('Customer Name:');
            if (!name) return;
            
            const email = prompt('Customer Email:');
            const phone = prompt('Customer Phone:');

            // Demo - just add to display
            const demoCustomer = {
                id: Date.now(),
                name: name,
                email: email || 'N/A',
                phone: phone || 'N/A'
            };

            loadCustomers(); // Reload to show new customer
            alert('Customer added successfully!');
        }

        function viewCustomer(id) {
            alert(`Viewing customer ID: ${id}`);
        }

        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                alert('Customer deleted (demo)');
                loadCustomers();
            }
        }

        // Vehicles
        async function loadVehicles() {
            const listContainer = document.getElementById('vehiclesList');
            
            try {
                const response = await fetch(`${API_BASE}/vehicles`);
                
                if (response.ok) {
                    const vehicles = await response.json();
                    displayVehicles(vehicles);
                } else {
                    displayDemoVehicles();
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                displayDemoVehicles();
            }
        }

        function displayVehicles(vehicles) {
            const listContainer = document.getElementById('vehiclesList');
            
            if (vehicles.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-car-side" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No vehicles yet. Add your first vehicle!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = vehicles.map(vehicle => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                        <div class="data-item-subtitle">VIN: ${vehicle.vin || 'N/A'} | Mileage: ${vehicle.mileage || 'N/A'}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewVehicle('${vehicle.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteVehicle('${vehicle.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoVehicles() {
            const demoVehicles = [
                { id: 1, year: 2020, make: 'Toyota', model: 'Camry', vin: '1HGBH41JXMN109186', mileage: '45,000' },
                { id: 2, year: 2019, make: 'Honda', model: 'Civic', vin: '2HGFC2F59KH534123', mileage: '32,000' },
                { id: 3, year: 2021, make: 'Ford', model: 'F-150', vin: '1FTEW1EP5MFA12345', mileage: '28,000' }
            ];
            displayVehicles(demoVehicles);
        }

        function showAddVehicleForm() {
            const year = prompt('Vehicle Year:');
            if (!year) return;
            
            const make = prompt('Vehicle Make:');
            const model = prompt('Vehicle Model:');
            const vin = prompt('VIN (optional):');
            const mileage = prompt('Mileage (optional):');

            loadVehicles();
            alert('Vehicle added successfully!');
        }

        function viewVehicle(id) {
            alert(`Viewing vehicle ID: ${id}`);
        }

        function deleteVehicle(id) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                alert('Vehicle deleted (demo)');
                loadVehicles();
            }
        }

        // Appointments
        async function loadAppointments() {
            const listContainer = document.getElementById('appointmentsList');
            
            try {
                const response = await fetch(`${API_BASE}/appointments`);
                
                if (response.ok) {
                    const appointments = await response.json();
                    displayAppointments(appointments);
                } else {
                    displayDemoAppointments();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                displayDemoAppointments();
            }
        }

        function displayAppointments(appointments) {
            const listContainer = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <i class="fas fa-calendar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No appointments yet. Add your first appointment!</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = appointments.map(apt => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${apt.customerName}</div>
                        <div class="data-item-subtitle">${apt.date} at ${apt.time} | ${apt.service}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="viewAppointment('${apt.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteAppointment('${apt.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoAppointments() {
            const demoAppointments = [
                { id: 1, customerName: 'John Smith', date: '2025-01-20', time: '10:00 AM', service: 'Oil Change' },
                { id: 2, customerName: 'Jane Doe', date: '2025-01-20', time: '2:00 PM', service: 'Brake Inspection' },
                { id: 3, customerName: 'Mike Johnson', date: '2025-01-21', time: '9:00 AM', service: 'Tire Rotation' }
            ];
            displayAppointments(demoAppointments);
        }

        function showAddAppointmentForm() {
            const customerName = prompt('Customer Name:');
            if (!customerName) return;
            
            const date = prompt('Date (YYYY-MM-DD):');
            const time = prompt('Time (HH:MM AM/PM):');
            const service = prompt('Service:');

            loadAppointments();
            alert('Appointment added successfully!');
        }

        function viewAppointment(id) {
            alert(`Viewing appointment ID: ${id}`);
        }

        function deleteAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                alert('Appointment deleted (demo)');
                loadAppointments();
            }
        }

        // Settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/shop/settings`);
                
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('settingsShopName').value = settings.shopName || '';
                    document.getElementById('settingsShopPhone').value = settings.shopPhone || '';
                    document.getElementById('settingsShopEmail').value = settings.shopEmail || '';
                    document.getElementById('settingsShopAddress').value = settings.shopAddress || '';
                    document.getElementById('settingsLaborRate').value = settings.laborRate || '';
                    document.getElementById('settingsTaxRate').value = (settings.taxRate * 100) || '';
                    document.getElementById('settingsDiagnosticFee').value = settings.diagnosticFee || '';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }

            // Load labor operations
            loadLaborOperations();
        }

        async function loadLaborOperations() {
            const listContainer = document.getElementById('laborOperationsList');
            
            try {
                const response = await fetch(`${API_BASE}/labor/operations`);
                
                if (response.ok) {
                    const operations = await response.json();
                    displayLaborOperations(operations);
                } else {
                    displayDemoLaborOperations();
                }
            } catch (error) {
                console.error('Error loading labor operations:', error);
                displayDemoLaborOperations();
            }
        }

        function displayLaborOperations(operations) {
            const listContainer = document.getElementById('laborOperationsList');
            
            if (operations.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #718096;">
                        <p>No labor operations found.</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = operations.slice(0, 10).map(op => `
                <div class="data-item">
                    <div>
                        <div class="data-item-title">${op.operation}</div>
                        <div class="data-item-subtitle">Time: ${op.laborTime} hrs | Base Price: $${(op.laborTime * 100).toFixed(2)}</div>
                    </div>
                    <div class="data-item-actions">
                        <button class="icon-btn" onclick="editOperation('${op.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayDemoLaborOperations() {
            const demoOps = [
                { id: 'oil-change', operation: 'Oil Change', laborTime: 0.5 },
                { id: 'brake-pads', operation: 'Brake Pads Replacement', laborTime: 1.0 },
                { id: 'tire-rotation', operation: 'Tire Rotation', laborTime: 0.5 },
                { id: 'battery-replacement', operation: 'Battery Replacement', laborTime: 0.5 },
                { id: 'air-filter', operation: 'Air Filter Replacement', laborTime: 0.25 }
            ];
            displayLaborOperations(demoOps);
        }

        async function saveSettings() {
            const settings = {
                shopName: document.getElementById('settingsShopName').value,
                shopPhone: document.getElementById('settingsShopPhone').value,
                shopEmail: document.getElementById('settingsShopEmail').value,
                shopAddress: document.getElementById('settingsShopAddress').value,
                laborRate: parseFloat(document.getElementById('settingsLaborRate').value),
                taxRate: parseFloat(document.getElementById('settingsTaxRate').value) / 100,
                diagnosticFee: parseFloat(document.getElementById('settingsDiagnosticFee').value),
                vapiKey: document.getElementById('settingsVapiKey').value,
                sendgridKey: document.getElementById('settingsSendgridKey').value
            };

            try {
                const response = await fetch(`${API_BASE}/shop/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings. Please try again.');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Settings saved (demo mode)!');
            }
        }

        function editOperation(id) {
            alert(`Edit operation: ${id}`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
        });
    
// Towing Functions
function loadTowingRequests() {
    fetch('/api/towing/requests')
        .then(res => res.json())
        .then(requests => {
            const container = document.getElementById('towingRequestsList');
            container.innerHTML = requests.map(req => `
                <div class="tow-request status-${req.status}">
                    <div class="tow-header">
                        <span class="tow-id">${req.id}</span>
                        <span class="tow-status status-${req.status}">${req.status}</span>
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-details">
                            <p><strong>Customer:</strong> ${req.customerName} (${req.customerPhone})</p>
                            <p><strong>Vehicle:</strong> ${req.vehicle?.year} ${req.vehicle?.make} ${req.vehicle?.model} (${req.vehicle?.plate})</p>
                            <p><strong>Pickup:</strong> ${req.pickupLocation}</p>
                            <p><strong>Destination:</strong> ${req.destination}</p>
                            ${req.notes ? `<p><strong>Notes:</strong> ${req.notes}</p>` : ''}
                        </div>
                    </div>
                    <div class="toolbar">
                        ${req.status !== 'arrived' ? `<button class="action-btn" onclick="markArrived('${req.id}')">Mark Arrived</button>` : ''}
                        ${req.status === 'pending' ? `<button class="action-btn" onclick="assignProvider('${req.id}')">Assign Provider</button>` : ''}
                    </div>
                </div>
            `).join('');
        })
        .catch(err => console.error('Error loading towing requests:', err));
}

function markArrived(towId) {
    fetch(`/api/towing/${towId}/arrived`, { method: 'POST' })
        .then(() => {
            alert('âœ… Car marked as arrived! Customer will be notified.');
            loadTowingRequests();
        })
        .catch(err => alert('Error marking as arrived:', err));
}

// Inventory Functions
function loadInventory() {
    fetch('/api/inventory')
        .then(res => res.json())
        .then(items => {
            const container = document.getElementById('inventoryList');
            container.innerHTML = `
                <div class="card">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; text-align: left;">Part</th>
                                <th style="padding: 10px; text-align: left;">Category</th>
                                <th style="padding: 10px; text-align: center;">Stock</th>
                                <th style="padding: 10px; text-align: center;">Price</th>
                                <th style="padding: 10px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 10px;">${item.name} (${item.partNumber})</td>
                                    <td style="padding: 10px;">${item.category}</td>
                                    <td style="padding: 10px; text-align: center;">${item.quantity}</td>
                                    <td style="padding: 10px; text-align: center;">$${item.price.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: center;">
                                        ${item.quantity <= item.reorderPoint ? 
                                            '<span style="color: #e74c3c; font-weight: bold;">LOW STOCK</span>' : 
                                            '<span style="color: #27ae60;">In Stock</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => console.error('Error loading inventory:', err));
}

function showLowStock() {
    fetch('/api/inventory/low-stock/5')
        .then(res => res.json())
        .then(items => {
            alert(`Low Stock Alert:\n\n${items.map(i => `${i.name}: ${i.quantity} units`).join('\n')}`);
        });
}


// ==================== TOWING FUNCTIONS ====================
async function loadTowingRequests() {
    try {
        const response = await fetch('/api/towing/requests');
        const requests = await response.json();
        const container = document.getElementById('towingRequestsList');
        
        if (requests.length === 0) {
            container.innerHTML = '<div class="card"><p>No towing requests found.</p></div>';
            return;
        }
        
        container.innerHTML = requests.map(req => `
            <div class="card tow-request status-${req.status}" style="border-left: 4px solid ${getStatusColor(req.status)}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-weight: bold; font-size: 18px;">${req.id}</span>
                    <span style="padding: 5px 15px; border-radius: 20px; background: ${getStatusColor(req.status)}; color: white; font-weight: bold;">
                        ${req.status.toUpperCase()}
                    </span>
                </div>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <p><strong>Customer:</strong> ${req.customerName} - <a href="tel:${req.customerPhone}">${req.customerPhone}</a></p>
                    ${req.vehicle ? `<p><strong>Vehicle:</strong> ${req.vehicle.year} ${req.vehicle.color} ${req.vehicle.make} ${req.vehicle.model} (${req.vehicle.plate})</p>` : ''}
                    <p><strong>Pickup:</strong> ${req.pickupLocation}</p>
                    <p><strong>Destination:</strong> ${req.destination}</p>
                    ${req.keyLocation ? `<p><strong>Key Location:</strong> ${req.keyLocation}</p>` : ''}
                    ${req.customerMeeting ? `<p><strong>Customer Meeting:</strong> ${req.customerMeeting}</p>` : ''}
                    ${req.assignedProvider ? `<p><strong>Provider:</strong> ${req.assignedProvider}</p>` : ''}
                </div>
                <div style="display: flex; gap: 10px;">
                    ${req.status !== 'arrived' ? `<button class="action-btn" onclick="markArrived('${req.id}')">âœ… Mark Arrived</button>` : ''}
                    ${req.status === 'pending' ? `<button class="action-btn" onclick="assignProvider('${req.id}')">ðŸšš Assign Provider</button>` : ''}
                    <button class="action-btn" onclick="alert('Created: ${new Date(req.createdAt).toLocaleString()}')">ðŸ“… Details</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading towing requests:', error);
        document.getElementById('towingRequestsList').innerHTML = '<div class="card" style="color: red;">Error loading towing requests</div>';
    }
}

function getStatusColor(status) {
    const colors = {
        pending: '#f39c12',
        assigned: '#3498db',
        in_progress: '#e67e22',
        arrived: '#27ae60',
        completed: '#95a5a6'
    };
    return colors[status] || '#95a5a6';
}

async function markArrived(towId) {
    if (!confirm('Mark this car as arrived? Customer will be notified via SMS.')) return;
    
    try {
        const response = await fetch(`/api/towing/${towId}/arrived`, { method: 'POST' });
        if (response.ok) {
            alert('âœ… Car marked as arrived! Customer has been notified.');
            loadTowingRequests();
        } else {
            alert('Error marking as arrived');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function assignProvider(towId) {
    const providerName = prompt('Enter provider name:');
    if (!providerName) return;
    
    const providerPhone = prompt('Enter provider phone:');
    
    try {
        const response = await fetch(`/api/towing/requests/${towId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ providerName, providerPhone })
        });
        
        if (response.ok) {
            alert('âœ… Provider assigned!');
            loadTowingRequests();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// ==================== INVENTORY FUNCTIONS ====================
async function loadInventory() {
    try {
        const response = await fetch('/api/inventory');
        const items = await response.json();
        const container = document.getElementById('inventoryList');
        
        if (items.length === 0) {
            container.innerHTML = '<div class="card"><p>No inventory items found.</p></div>';
            return;
        }
        
        const lowStockCount = items.filter(i => i.quantity <= i.reorderPoint).length;
        
        container.innerHTML = `
            <div class="card">
                <h3>Inventory Overview</h3>
                <p><strong>Total Items:</strong> ${items.length} | <strong>Low Stock:</strong> <span style="color: #e74c3c;">${lowStockCount}</span></p>
                <br>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Part Name</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Category</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Stock</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Price</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr style="border-bottom: 1px solid #e0e0e0; ${item.quantity <= item.reorderPoint ? 'background: #fee;' : ''}">
                                <td style="padding: 12px;">
                                    <strong>${item.name}</strong>
                                    <div style="font-size: 12px; color: #666;">${item.partNumber || 'N/A'}</div>
                                </td>
                                <td style="padding: 12px;">${item.category}</td>
                                <td style="padding: 12px; text-align: center; font-weight: bold;">
                                    ${item.quantity} ${item.unit}
                                </td>
                                <td style="padding: 12px; text-align: right;">$${item.price.toFixed(2)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    ${item.quantity <= item.reorderPoint ? 
                                        '<span style="background: #e74c3c; color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px;">LOW STOCK</span>' : 
                                        '<span style="background: #27ae60; color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px;">IN STOCK</span>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (error) {
        console.error('Error loading inventory:', error);
        document.getElementById('inventoryList').innerHTML = '<div class="card" style="color: red;">Error loading inventory</div>';
    }
}

async function showLowStock() {
    try {
        const response = await fetch('/api/inventory/low-stock/5');
        const items = await response.json();
        
        if (items.length === 0) {
            alert('âœ… No low stock items! All inventory levels are healthy.');
        } else {
            const message = `âš ï¸ LOW STOCK ALERT (${items.length} items):\n\n` + 
                items.map(i => `â€¢ ${i.name}: ${i.quantity} ${i.unit} (min: ${i.reorderPoint})`).join('\n') +
                '\n\nPlease reorder these items.';
            alert(message);
        }
    } catch (error) {
        alert('Error checking low stock: ' + error.message);
    }
}

// Auto-load when screens are shown
const originalShowScreen = window.showScreen;
window.showScreen = function(screenId) {
    originalShowScreen(screenId);
    if (screenId === 'towing') loadTowingRequests();
    if (screenId === 'inventory') loadInventory();
};
</script>
</body>
</html>
