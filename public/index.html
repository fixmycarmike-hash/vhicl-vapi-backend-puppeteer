<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHICL Pro - Complete Shop Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .navbar {
            background: #2c3e50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .navbar h1 {
            color: white;
            font-size: 24px;
            margin: 0;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #3498db;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #3498db;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card .stat {
            font-size: 36px;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }

        .card .label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .card.success .stat {
            color: #27ae60;
        }

        .card.warning .stat {
            color: #f39c12;
        }

        .card.danger .stat {
            color: #e74c3c;
        }

        .card.info .stat {
            color: #3498db;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 250px;
        }

        .half {
            flex: 0 0 calc(50% - 10px);
        }

        .third {
            flex: 0 0 calc(33.333% - 13px);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.primary {
            background: #cce5ff;
            color: #004085;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        /* Invoice Line Items */
        .line-items {
            margin-top: 20px;
        }

        .line-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .line-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .line-item-total {
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
            margin-top: 10px;
        }

        .invoice-summary {
            background: #f8f9fa;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            border-top: 2px solid #2c3e50;
            margin-top: 10px;
            padding-top: 10px;
        }

        /* Modal Styles */
        /* Modal Styles for ALEX Nexpart modals */
        .modal-content.alex-modal {
            background: white;
            margin: 20px auto;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #f44336;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-results {
            padding: 20px;
            border-top: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                width: 100%;
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .row {
                flex-direction: column;
            }

            .half,
            .third {
                flex: 1;
            }
        }

        /* Stat Cards */
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        /* Table improvements */
        table {
            border-radius: 8px;
            overflow: hidden;
        }

        table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="navbar">
        <h1>üöó VHICL Pro</h1>
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showScreen('homeScreen')">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" onclick="showScreen('alexScreen')">
                <i class="fas fa-robot"></i> ALEX
            </button>
            <button class="nav-btn" onclick="showScreen('appointmentsScreen')">
                <i class="fas fa-calendar"></i> Appointments
            </button>
            <button class="nav-btn" onclick="showScreen('estimatesScreen')">
                <i class="fas fa-file-invoice-dollar"></i> Estimates
            </button>
            <button class="nav-btn" onclick="showScreen('invoicesScreen')">
                <i class="fas fa-file-invoice"></i> Invoices
            </button>
            <button class="nav-btn" onclick="showScreen('partsStoresScreen')">
                <i class="fas fa-store"></i> Parts Stores
            </button>
            <button class="nav-btn" onclick="showScreen('analyticsScreen')">
                <i class="fas fa-chart-line"></i> Analytics
            </button>
            <button class="nav-btn" onclick="showScreen('techFlowScreen')">
                <i class="fas fa-user-tie"></i> Tech Flow
            </button>
            <button class="nav-btn" onclick="showScreen('settingsScreen')">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Screen -->
        <div id="homeScreen" class="screen active">
            <div class="section">
                <h2>üìä Today's Overview</h2>
                <div class="dashboard-grid">
                    <div class="card success">
                        <h3><i class="fas fa-dollar-sign"></i> Revenue</h3>
                        <div class="stat" id="todayRevenue">$0.00</div>
                        <div class="label">Total revenue today</div>
                    </div>
                    <div class="card info">
                        <h3><i class="fas fa-file-invoice"></i> Invoices</h3>
                        <div class="stat" id="todayInvoices">0</div>
                        <div class="label">Invoices generated today</div>
                    </div>
                    <div class="card warning">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Estimates</h3>
                        <div class="stat" id="todayEstimates">0</div>
                        <div class="label">Estimates created today</div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-wrench"></i> Jobs</h3>
                        <div class="stat" id="todayJobs">0</div>
                        <div class="label">Jobs completed today</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>‚ö° Quick Actions</h2>
                <div class="row">
                    <button class="btn btn-primary" onclick="openAppointmentModal()">
                        <i class="fas fa-plus"></i> New Appointment
                    </button>
                    <button class="btn btn-info" onclick="openEstimateModal()">
                        <i class="fas fa-file-invoice-dollar"></i> Create Estimate
                    </button>
                    <button class="btn btn-success" onclick="openInvoiceModal()">
                        <i class="fas fa-file-invoice"></i> Create Invoice
                    </button>
                    <button class="btn btn-warning" onclick="showScreen('alexScreen')">
                        <i class="fas fa-phone"></i> Call Parts Store
                    </button>
                </div>
            </div>
        </div>

        <!-- Estimates Screen -->
        <div id="estimatesScreen" class="screen">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìã Estimates</h2>
                    <button class="btn btn-info" onclick="openEstimateModal()">
                        <i class="fas fa-plus"></i> New Estimate
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="stat-label">Total Estimates</div>
                        <div class="stat-value" id="estTotalCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div class="stat-label">Pending</div>
                        <div class="stat-value" id="estPendingCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div class="stat-label">Approved</div>
                        <div class="stat-value" id="estApprovedCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                        <div class="stat-label">Total Value</div>
                        <div class="stat-value" id="estTotalValue">$0</div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="searchEstimates" placeholder="üîç Search by customer, vehicle, or estimate #..." onkeyup="searchEstimates()" style="padding: 10px;">
                    <select id="filterEstimatesByStatus" onchange="filterEstimatesByStatus()" style="padding: 10px;">
                        <option value="all">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <select id="filterEstimatesByDate" onchange="filterEstimatesByDate()" style="padding: 10px;">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left;">Estimate #</th>
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Customer</th>
                            <th style="padding: 12px; text-align: left;">Vehicle</th>
                            <th style="padding: 12px; text-align: right;">Total</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="estimatesTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                <p>No estimates found</p>
                                <p style="font-size: 12px;">Click "New Estimate" to create your first estimate</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Invoices Screen -->
        <div id="invoicesScreen" class="screen">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìÑ Invoices</h2>
                    <button class="btn btn-success" onclick="openInvoiceModal()">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="stat-label">Total Invoices</div>
                        <div class="stat-value" id="invTotalCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: white;">
                        <div class="stat-label">Unpaid</div>
                        <div class="stat-value" id="invUnpaidCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white;">
                        <div class="stat-label">Paid</div>
                        <div class="stat-value" id="invPaidCount">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%); color: white;">
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value" id="invTotalRevenue">$0</div>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="searchInvoices" placeholder="üîç Search by customer, vehicle, or invoice #..." onkeyup="searchInvoices()" style="padding: 10px;">
                    <select id="filterInvoicesByStatus" onchange="filterInvoicesByStatus()" style="padding: 10px;">
                        <option value="all">All Statuses</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Partial">Partial</option>
                        <option value="Paid">Paid</option>
                    </select>
                    <select id="filterInvoicesByDate" onchange="filterInvoicesByDate()" style="padding: 10px;">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left;">Invoice #</th>
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Customer</th>
                            <th style="padding: 12px; text-align: left;">Vehicle</th>
                            <th style="padding: 12px; text-align: right;">Total</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                                <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                                <p>No invoices found</p>
                                <p style="font-size: 12px;">Click "New Invoice" to create your first invoice</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Appointments Screen -->
        <div id="appointmentsScreen" class="screen">
            <div class="section">
                <h2>üìÖ Appointments</h2>
                
                <div class="form-group">
                    <div class="row">
                        <div class="third">
                            <input type="text" id="searchAppointments" placeholder="Search appointments..." onkeyup="searchAppointments()">
                        </div>
                        <div class="third">
                            <select id="filterAppointments" onchange="filterAppointments()">
                                <option value="all">All Appointments</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="third">
                            <button class="btn btn-primary" style="width: 100%;" onclick="openAppointmentModal()">
                                <i class="fas fa-plus"></i> New Appointment
                            </button>
                        </div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTable">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #7f8c8d;">No appointments found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tech Flow Screen -->
        <div id="techFlowScreen" class="screen">
            <div class="section">
                <h2>üë∑ Technician Dashboard</h2>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3><i class="fas fa-tools"></i> Active Jobs</h3>
                        <div class="stat" id="techActiveJobs">0</div>
                        <div class="label">Jobs currently in progress</div>
                    </div>
                    <div class="card success">
                        <h3><i class="fas fa-check-circle"></i> Completed Today</h3>
                        <div class="stat" id="techCompletedToday">0</div>
                        <div class="label">Jobs completed today</div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Total Hours</h3>
                        <div class="stat" id="techTotalHours">0.0</div>
                        <div class="label">Hours worked today</div>
                    </div>
                    <div class="card warning">
                        <h3><i class="fas fa-star"></i> Rating</h3>
                        <div class="stat" id="techRating">0.0</div>
                        <div class="label">Customer rating (out of 5)</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üîß Active Jobs</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Service</th>
                            <th>Bay</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="techActiveJobsTable">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #7f8c8d;">No active jobs</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>‚úÖ Recent Completed Jobs</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Customer</th>
                            <th>Vehicle</th>
                            <th>Service</th>
                            <th>Hours</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody id="techCompletedJobsTable">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #7f8c8d;">No completed jobs today</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="section">
                <h2>‚öôÔ∏è Shop Settings</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    Configure your shop's settings, credentials, and preferences.
                </p>
                
                <div class="form-group">
                    <label>Shop Name</label>
                    <input type="text" id="settingShopName" value="VHICL Pro Auto Shop">
                </div>

                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="settingPhone" value="(555) 123-4567">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="settingEmail" value="info@vhiclpro.com">
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="settingAddress" value="123 Main Street">
                </div>

                <div class="form-group">
                    <label>Labor Rate ($/hour)</label>
                    <input type="number" id="settingLaborRate" value="100">
                </div>

                <div class="form-group">
                    <label>Sales Tax Rate (%)</label>
                    <input type="number" id="settingTaxRate" value="7" min="0" step="0.1" placeholder="Enter 0 for no sales tax">
                    <small style="color: #7f8c8d;">Set to 0 for states with no sales tax (e.g., Florida)</small>
                </div>

                <div class="form-group">
                    <label>Diagnostic Fee ($)</label>
                    <input type="number" id="settingDiagnosticFee" value="50">
                </div>

                <div class="form-group">
                    <label>Server URL</label>
                    <input type="text" id="settingServerUrl" value="https://vhicl-vapi-backend-puppeteer-production.up.railway.app">
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>

        <!-- Other screens (ALEX, Parts Stores, Analytics) would go here -->
        <div id="alexScreen" class="screen">
            <div class="section">
                <h2>ü§ñ ALEX - Nexpart Integration</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Parts and labor lookup via Nexpart (industry standard data)</p>
                
                <!-- ALEX Status Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="stats-card">
                        <div class="stats-label">Parts Lookups Today</div>
                        <div class="stats-value" id="alexLookupsToday">0</div>
                        <div class="stats-sub">Nexpart searches</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Labor Lookups</div>
                        <div class="stats-value" id="alexLaborLookups">0</div>
                        <div class="stats-sub">Today</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Parts Found</div>
                        <div class="stats-value" id="alexPartsFound">0</div>
                        <div class="stats-sub">This month</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">VIN Decodes</div>
                        <div class="stats-value" id="alexVINDecodes">0</div>
                        <div class="stats-sub">This month</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Plate Lookups</div>
                        <div class="stats-value" id="alexPlateLookups">0</div>
                        <div class="stats-sub">This month</div>
                    </div>
                </div>

                <!-- Quick Lookup Tools -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>üîç Quick Lookup Tools</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="openPartsLookupModal()">
                            üîß Parts Lookup
                        </button>
                        <button class="btn btn-secondary" onclick="openLaborLookupModal()">
                            ‚è±Ô∏è Labor Lookup
                        </button>
                        <button class="btn btn-success" onclick="openVINDecoderModal()">
                            üöó VIN Decoder
                        </button>
                        <button class="btn btn-info" onclick="openLicensePlateModal()">
                            ü™™ Plate ‚Üí VIN
                        </button>
                        <button class="btn btn-warning" onclick="openVehiclePartsModal()">
                            üìã Vehicle Parts
                        </button>
                    </div>
                </div>

                <!-- Services We Don't Do -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3>üö´ Services We Don't Do</h3>
                    <p style="color: #666; margin-bottom: 10px;">ALEX will not book these services automatically</p>
                    <div id="servicesWeDontDo" style="margin-bottom: 10px;"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newServiceNotOffered" placeholder="Add service we don't offer..." style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addServiceNotOffered()">Add</button>
                    </div>
                </div>

                <!-- Lookup History -->
                <div class="card">
                    <h3>üìã Lookup History</h3>
                    <div id="alexActivityLog" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: #999; padding: 20px;">No lookups yet</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="partsStoresScreen" class="screen">
            <div class="section">
                <h2>üè™ Parts Stores Management</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Manage your parts supplier network</p>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="stats-card">
                        <div class="stats-label">Total Stores</div>
                        <div class="stats-value" id="totalStores">0</div>
                        <div class="stats-sub">In network</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Active This Week</div>
                        <div class="stats-value" id="activeStoresThisWeek">0</div>
                        <div class="stats-sub">Recent orders</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Avg Rating</div>
                        <div class="stats-value" id="avgStoreRating">0</div>
                        <div class="stats-sub">Overall satisfaction</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-label">Total Orders</div>
                        <div class="stats-value" id="totalStoreOrders">0</div>
                        <div class="stats-sub">This month</div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="openAddStoreModal()">
                        ‚ûï Add Store
                    </button>
                    <input type="text" id="searchStores" placeholder="üîç Search stores..." 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onkeyup="filterStores()">
                </div>

                <!-- Stores Table -->
                <div class="card">
                    <table id="storesTable">
                        <thead>
                            <tr>
                                <th>Store Name</th>
                                <th>Location</th>
                                <th>Phone</th>
                                <th>Contact</th>
                                <th>Rating</th>
                                <th>Orders</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="storesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #999; padding: 30px;">
                                    No parts stores added yet. Click "Add Store" to get started.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="analyticsScreen" class="screen">
            <div class="section">
                <h2>üìä Analytics Dashboard</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Track your shop's performance and metrics</p>

                <!-- Time Period Selector -->
                <div style="margin-bottom: 20px;">
                    <select id="analyticsPeriod" onchange="loadAnalyticsData()" 
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="stats-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="stats-label">Total Revenue</div>
                        <div class="stats-value" id="analyticsRevenue">$0</div>
                        <div class="stats-sub" id="revenueChange">vs last period</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div class="stats-label">Total Jobs</div>
                        <div class="stats-value" id="analyticsJobs">0</div>
                        <div class="stats-sub" id="jobsChange">vs last period</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div class="stats-label">Appointments</div>
                        <div class="stats-value" id="analyticsAppointments">0</div>
                        <div class="stats-sub" id="appointmentsChange">vs last period</div>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                        <div class="stats-label">Customer Rating</div>
                        <div class="stats-value" id="analyticsRating">0.0</div>
                        <div class="stats-sub">Average satisfaction</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <!-- Revenue Chart -->
                    <div class="card">
                        <h3>üí∞ Revenue Trend</h3>
                        <div id="revenueChart" style="height: 300px; padding: 20px;">
                            <canvas id="revenueCanvas"></canvas>
                        </div>
                    </div>

                    <!-- Jobs by Type Chart -->
                    <div class="card">
                        <h3>üîß Jobs by Service Type</h3>
                        <div id="jobsChart" style="height: 300px; padding: 20px;">
                            <canvas id="jobsCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <!-- Top Services -->
                    <div class="card">
                        <h3>üèÜ Top Services</h3>
                        <div id="topServices" style="padding: 10px;">
                            <p style="text-align: center; color: #999;">No data yet</p>
                        </div>
                    </div>

                    <!-- Parts Usage -->
                    <div class="card">
                        <h3>üì¶ Most Ordered Parts</h3>
                        <div id="topParts" style="padding: 10px;">
                            <p style="text-align: center; color: #999;">No data yet</p>
                        </div>
                    </div>

                    <!-- Tech Performance -->
                    <div class="card">
                        <h3>üë®‚Äçüîß Tech Performance</h3>
                        <div id="techPerformance" style="padding: 10px;">
                            <p style="text-align: center; color: #999;">No data yet</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3>üìã Recent Activity</h3>
                    <div id="analyticsRecentActivity" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: #999; padding: 20px;">No activity yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estimate Modal -->
    <div id="estimateModal" class="modal">
        <div class="modal-content alex-modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> New Estimate</h2>
                <button class="close-btn" onclick="closeEstimateModal()">&times;</button>
            </div>
            
            <form id="estimateForm" onsubmit="saveEstimate(event)">
                <!-- Customer Information -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üë§ Customer Information</h3>
                    <div class="row">
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="estCustomerName" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Phone *</label>
                                <input type="tel" id="estCustomerPhone" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Email</label>
                                <input type="email" id="estCustomerEmail">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="half">
                            <div class="form-group">
                                <label>Vehicle *</label>
                                <input type="text" id="estVehicle" placeholder="e.g., 2019 Toyota Camry" required>
                            </div>
                        </div>
                        <div class="half">
                            <div class="form-group">
                                <label>Estimate Date *</label>
                                <input type="date" id="estDate" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parts Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">üîß Parts</h3>
                        <button type="button" class="btn btn-primary" onclick="addEstimatePart()">
                            <i class="fas fa-plus"></i> Add Part
                        </button>
                    </div>
                    <div id="estimateParts" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>
                    </div>
                </div>

                <!-- Labor Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">‚è±Ô∏è Labor</h3>
                        <button type="button" class="btn btn-primary" onclick="addEstimateLabor()">
                            <i class="fas fa-plus"></i> Add Labor
                        </button>
                    </div>
                    <div id="estimateLabor" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>
                    </div>
                </div>

                <!-- Running Total -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; text-align: center;">üí∞ Estimate Total</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Parts Subtotal</div>
                            <div style="font-size: 18px; font-weight: bold;" id="estPartsSubtotal">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Labor Subtotal</div>
                            <div style="font-size: 18px; font-weight: bold;" id="estLaborSubtotal">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;" id="estTaxLabel">Parts Tax (7%)</div>
                            <div style="font-size: 18px; font-weight: bold;" id="estPartsTax">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Grand Total</div>
                            <div style="font-size: 24px; font-weight: bold;" id="estGrandTotal">$0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Notes</label>
                    <textarea id="estNotes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>

                <!-- Buttons -->
                <div class="row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeEstimateModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-info" style="flex: 1; margin-left: 10px;">
                        <i class="fas fa-check"></i> Save Estimate
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content alex-modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice"></i> New Invoice</h2>
                <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
            </div>
            
            <form id="invoiceForm" onsubmit="saveInvoice(event)">
                <!-- Customer Information -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üë§ Customer Information</h3>
                    <div class="row">
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="invCustomerName" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Phone *</label>
                                <input type="tel" id="invCustomerPhone" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Customer Email</label>
                                <input type="email" id="invCustomerEmail">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="third">
                            <div class="form-group">
                                <label>Vehicle *</label>
                                <input type="text" id="invVehicle" placeholder="e.g., 2019 Toyota Camry" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Invoice Date *</label>
                                <input type="date" id="invDate" required>
                            </div>
                        </div>
                        <div class="third">
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="date" id="invDueDate">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parts Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">üîß Parts</h3>
                        <button type="button" class="btn btn-primary" onclick="addInvoicePart()">
                            <i class="fas fa-plus"></i> Add Part
                        </button>
                    </div>
                    <div id="invoiceParts" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>
                    </div>
                </div>

                <!-- Labor Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">‚è±Ô∏è Labor</h3>
                        <button type="button" class="btn btn-primary" onclick="addInvoiceLabor()">
                            <i class="fas fa-plus"></i> Add Labor
                        </button>
                    </div>
                    <div id="invoiceLabor" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>
                    </div>
                </div>

                <!-- Running Total -->
                <div style="background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; text-align: center;">üí∞ Invoice Total</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Parts Subtotal</div>
                            <div style="font-size: 18px; font-weight: bold;" id="invPartsSubtotal">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Labor Subtotal</div>
                            <div style="font-size: 18px; font-weight: bold;" id="invLaborSubtotal">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;" id="invTaxLabel">Parts Tax (7%)</div>
                            <div style="font-size: 18px; font-weight: bold;" id="invPartsTax">$0.00</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px;">
                            <div style="font-size: 12px; opacity: 0.9;">Grand Total</div>
                            <div style="font-size: 24px; font-weight: bold;" id="invGrandTotal">$0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Payment Method</label>
                    <select id="invPaymentMethod">
                        <option value="">Select payment method...</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Check">Check</option>
                        <option value="Finance">Finance</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Notes</label>
                    <textarea id="invNotes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>

                <!-- Buttons -->
                <div class="row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeInvoiceModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success" style="flex: 1; margin-left: 10px;">
                        <i class="fas fa-check"></i> Save Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content alex-modal">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-plus"></i> New Appointment</h2>
                <button class="close-btn" onclick="closeAppointmentModal()">&times;</button>
            </div>
            
            <form id="appointmentForm" onsubmit="saveAppointment(event)">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="apptCustomerName" required>
                </div>

                <div class="form-group">
                    <label>Customer Phone *</label>
                    <input type="tel" id="apptCustomerPhone" required>
                </div>

                <div class="form-group">
                    <label>Customer Email</label>
                    <input type="email" id="apptCustomerEmail">
                </div>

                <div class="form-group">
                    <label>Vehicle *</label>
                    <input type="text" id="apptVehicle" placeholder="e.g., 2019 Toyota Camry" required>
                </div>

                <div class="row">
                    <div class="half">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="apptDate" required>
                        </div>
                    </div>
                    <div class="half">
                        <div class="form-group">
                            <label>Time *</label>
                            <input type="time" id="apptTime" required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Service Needed *</label>
                    <select id="apptService" required>
                        <option value="">Select a service...</option>
                        <option value="Oil Change">Oil Change</option>
                        <option value="Brake Service">Brake Service</option>
                        <option value="Tire Rotation">Tire Rotation</option>
                        <option value="Engine Diagnostic">Engine Diagnostic</option>
                        <option value="AC Service">AC Service</option>
                        <option value="Battery Replacement">Battery Replacement</option>
                        <option value="Transmission Service">Transmission Service</option>
                        <option value="General Inspection">General Inspection</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Service Details</label>
                    <textarea id="apptNotes" rows="3" placeholder="Describe the issue or service needed..."></textarea>
                </div>

                <div class="row" style="margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeAppointmentModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="margin-left: 10px;">
                        <i class="fas fa-check"></i> Save Appointment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Screen navigation
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId).classList.add('active');
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.closest('.nav-btn').classList.add('active');
            }
            
            // Load data for specific screens
            if (screenId === 'estimatesScreen') {
                loadEstimates();
            }
            if (screenId === 'invoicesScreen') {
                loadInvoices();
            }
            if (screenId === 'appointmentsScreen') {
                loadAppointments();
            }
            if (screenId === 'techFlowScreen') {
                loadTechWorkflow();
            }
        }

        // Estimate Modal Functions
        function openEstimateModal() {
            document.getElementById('estimateModal').classList.add('active');
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('estDate').value = today;
            
            // Initialize empty parts and labor sections
            document.getElementById('estimateParts').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>';
            document.getElementById('estimateLabor').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>';
            calculateEstimateTotal();
        }

        function closeEstimateModal() {
            document.getElementById('estimateModal').classList.remove('active');
            document.getElementById('estimateForm').reset();
        }

        function addEstimatePart() {
            const container = document.getElementById('estimateParts');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const partDiv = document.createElement('div');
            partDiv.className = 'item-row';
            partDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
            partDiv.innerHTML = `
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Description</label>
                    <input type="text" class="part-desc" placeholder="Part name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Quantity</label>
                    <input type="number" class="part-qty" placeholder="1" value="1" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Price</label>
                    <input type="number" class="part-price" placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Total</label>
                    <div class="part-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$0.00</div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeEstimatePart(this)" style="padding: 8px 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(partDiv);
            calculateEstimateTotal();
        }

        function addEstimateLabor() {
            const container = document.getElementById('estimateLabor');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const laborDiv = document.createElement('div');
            laborDiv.className = 'item-row';
            laborDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
            laborDiv.innerHTML = `
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Description</label>
                    <input type="text" class="labor-desc" placeholder="Labor description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Hours</label>
                    <input type="number" class="labor-hours" placeholder="1.0" min="0" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Rate</label>
                    <input type="number" class="labor-rate" placeholder="100.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Total</label>
                    <div class="labor-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$0.00</div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeEstimateLabor(this)" style="padding: 8px 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(laborDiv);
            calculateEstimateTotal();
        }

        function removeEstimatePart(btn) {
            btn.closest('.item-row').remove();
            const container = document.getElementById('estimateParts');
            if (container.querySelectorAll('.item-row').length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>';
            }
            calculateEstimateTotal();
        }

        function removeEstimateLabor(btn) {
            btn.closest('.item-row').remove();
            const container = document.getElementById('estimateLabor');
            if (container.querySelectorAll('.item-row').length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>';
            }
            calculateEstimateTotal();
        }

        function calculateEstimateTotal() {
            let partsSubtotal = 0;
            let laborSubtotal = 0;

            // Get tax rate from settings (default to 7% if not set)
            const shopSettings = JSON.parse(localStorage.getItem('shopSettings') || '{}');
            const taxRate = (parseFloat(shopSettings.taxRate) || 7) / 100;

            // Calculate parts total
            document.querySelectorAll('#estimateParts .item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.part-qty').value) || 0;
                const price = parseFloat(row.querySelector('.part-price').value) || 0;
                const total = qty * price;
                row.querySelector('.part-total').textContent = '$' + total.toFixed(2);
                partsSubtotal += total;
            });

            // Calculate labor total
            document.querySelectorAll('#estimateLabor .item-row').forEach(row => {
                const hours = parseFloat(row.querySelector('.labor-hours').value) || 0;
                const rate = parseFloat(row.querySelector('.labor-rate').value) || 0;
                const total = hours * rate;
                row.querySelector('.labor-total').textContent = '$' + total.toFixed(2);
                laborSubtotal += total;
            });

            // Calculate tax (tax rate on parts only)
            const partsTax = partsSubtotal * taxRate;
            const grandTotal = partsSubtotal + laborSubtotal + partsTax;

            // Update tax label
            const taxPercent = (taxRate * 100).toFixed(1);
            const taxLabelElement = document.getElementById('estTaxLabel');
            if (taxLabelElement) {
                taxLabelElement.textContent = `Parts Tax (${taxPercent === '0.0' ? '0%' : taxPercent + '%'})`;
            }

            // Update display
            document.getElementById('estPartsSubtotal').textContent = '$' + partsSubtotal.toFixed(2);
            document.getElementById('estLaborSubtotal').textContent = '$' + laborSubtotal.toFixed(2);
            document.getElementById('estPartsTax').textContent = '$' + partsTax.toFixed(2);
            document.getElementById('estGrandTotal').textContent = '$' + grandTotal.toFixed(2);

            return { partsSubtotal, laborSubtotal, partsTax, grandTotal };
        }

        // Invoice Modal Functions
        function openInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('active');
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invDate').value = today;
            
            // Initialize empty parts and labor sections
            document.getElementById('invoiceParts').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>';
            document.getElementById('invoiceLabor').innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>';
            calculateInvoiceTotal();
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.remove('active');
            document.getElementById('invoiceForm').reset();
        }

        function addInvoicePart() {
            const container = document.getElementById('invoiceParts');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const partDiv = document.createElement('div');
            partDiv.className = 'item-row';
            partDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
            partDiv.innerHTML = `
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Description</label>
                    <input type="text" class="inv-part-desc" placeholder="Part name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Quantity</label>
                    <input type="number" class="inv-part-qty" placeholder="1" value="1" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Price</label>
                    <input type="number" class="inv-part-price" placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Total</label>
                    <div class="inv-part-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$0.00</div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeInvoicePart(this)" style="padding: 8px 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(partDiv);
            calculateInvoiceTotal();
        }

        function addInvoiceLabor() {
            const container = document.getElementById('invoiceLabor');
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const laborDiv = document.createElement('div');
            laborDiv.className = 'item-row';
            laborDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
            laborDiv.innerHTML = `
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Description</label>
                    <input type="text" class="inv-labor-desc" placeholder="Labor description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Hours</label>
                    <input type="number" class="inv-labor-hours" placeholder="1.0" min="0" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Rate</label>
                    <input type="number" class="inv-labor-rate" placeholder="100.00" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                </div>
                <div>
                    <label style="font-size: 11px; font-weight: bold;">Total</label>
                    <div class="inv-labor-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$0.00</div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeInvoiceLabor(this)" style="padding: 8px 12px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(laborDiv);
            calculateInvoiceTotal();
        }

        function removeInvoicePart(btn) {
            btn.closest('.item-row').remove();
            const container = document.getElementById('invoiceParts');
            if (container.querySelectorAll('.item-row').length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No parts added yet</p>';
            }
            calculateInvoiceTotal();
        }

        function removeInvoiceLabor(btn) {
            btn.closest('.item-row').remove();
            const container = document.getElementById('invoiceLabor');
            if (container.querySelectorAll('.item-row').length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No labor added yet</p>';
            }
            calculateInvoiceTotal();
        }

        function calculateInvoiceTotal() {
            let partsSubtotal = 0;
            let laborSubtotal = 0;

            // Get tax rate from settings (default to 7% if not set)
            const shopSettings = JSON.parse(localStorage.getItem('shopSettings') || '{}');
            const taxRate = (parseFloat(shopSettings.taxRate) || 7) / 100;

            // Calculate parts total
            document.querySelectorAll('#invoiceParts .item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.inv-part-qty').value) || 0;
                const price = parseFloat(row.querySelector('.inv-part-price').value) || 0;
                const total = qty * price;
                row.querySelector('.inv-part-total').textContent = '$' + total.toFixed(2);
                partsSubtotal += total;
            });

            // Calculate labor total
            document.querySelectorAll('#invoiceLabor .item-row').forEach(row => {
                const hours = parseFloat(row.querySelector('.inv-labor-hours').value) || 0;
                const rate = parseFloat(row.querySelector('.inv-labor-rate').value) || 0;
                const total = hours * rate;
                row.querySelector('.inv-labor-total').textContent = '$' + total.toFixed(2);
                laborSubtotal += total;
            });

            // Calculate tax (tax rate on parts only)
            const partsTax = partsSubtotal * taxRate;
            const grandTotal = partsSubtotal + laborSubtotal + partsTax;

            // Update tax label
            const taxPercent = (taxRate * 100).toFixed(1);
            const taxLabelElement = document.getElementById('invTaxLabel');
            if (taxLabelElement) {
                taxLabelElement.textContent = `Parts Tax (${taxPercent === '0.0' ? '0%' : taxPercent + '%'})`;
            }

            // Update display
            document.getElementById('invPartsSubtotal').textContent = '$' + partsSubtotal.toFixed(2);
            document.getElementById('invLaborSubtotal').textContent = '$' + laborSubtotal.toFixed(2);
            document.getElementById('invPartsTax').textContent = '$' + partsTax.toFixed(2);
            document.getElementById('invGrandTotal').textContent = '$' + grandTotal.toFixed(2);

            return { partsSubtotal, laborSubtotal, partsTax, grandTotal };
        }

        // Save Estimate
        async function saveEstimate(event) {
            event.preventDefault();
            
            const totals = calculateEstimateTotal();
            
            // Collect parts
            const parts = [];
            document.querySelectorAll('#estimateParts .item-row').forEach(row => {
                const desc = row.querySelector('.part-desc').value;
                const qty = parseFloat(row.querySelector('.part-qty').value) || 0;
                const price = parseFloat(row.querySelector('.part-price').value) || 0;
                if (desc) {
                    parts.push({ type: 'part', description: desc, quantity: qty, price: price, total: qty * price });
                }
            });
            
            // Collect labor
            const labor = [];
            document.querySelectorAll('#estimateLabor .item-row').forEach(row => {
                const desc = row.querySelector('.labor-desc').value;
                const hours = parseFloat(row.querySelector('.labor-hours').value) || 0;
                const rate = parseFloat(row.querySelector('.labor-rate').value) || 0;
                if (desc) {
                    labor.push({ type: 'labor', description: desc, hours: hours, rate: rate, total: hours * rate });
                }
            });
            
            const lineItems = [...parts, ...labor];
            
            const estimate = {
                customerName: document.getElementById('estCustomerName').value,
                customerPhone: document.getElementById('estCustomerPhone').value,
                customerEmail: document.getElementById('estCustomerEmail').value,
                vehicle: document.getElementById('estVehicle').value,
                date: document.getElementById('estDate').value,
                lineItems: lineItems,
                partsSubtotal: totals.partsSubtotal,
                laborSubtotal: totals.laborSubtotal,
                partsTax: totals.partsTax,
                total: totals.grandTotal,
                notes: document.getElementById('estNotes').value,
                status: 'Pending'
            };
            
            // Save to localStorage
            let estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            estimate.id = 'EST-' + (estimates.length + 1).toString().padStart(4, '0');
            estimates.push(estimate);
            localStorage.setItem('estimates', JSON.stringify(estimates));
            
            alert('‚úÖ Estimate saved successfully!');
            closeEstimateModal();
            loadEstimates();
        }

        // Save Invoice
        async function saveInvoice(event) {
            event.preventDefault();
            
            const totals = calculateInvoiceTotal();
            
            // Collect parts
            const parts = [];
            document.querySelectorAll('#invoiceParts .item-row').forEach(row => {
                const desc = row.querySelector('.inv-part-desc').value;
                const qty = parseFloat(row.querySelector('.inv-part-qty').value) || 0;
                const price = parseFloat(row.querySelector('.inv-part-price').value) || 0;
                if (desc) {
                    parts.push({ type: 'part', description: desc, quantity: qty, price: price, total: qty * price });
                }
            });
            
            // Collect labor
            const labor = [];
            document.querySelectorAll('#invoiceLabor .item-row').forEach(row => {
                const desc = row.querySelector('.inv-labor-desc').value;
                const hours = parseFloat(row.querySelector('.inv-labor-hours').value) || 0;
                const rate = parseFloat(row.querySelector('.inv-labor-rate').value) || 0;
                if (desc) {
                    labor.push({ type: 'labor', description: desc, hours: hours, rate: rate, total: hours * rate });
                }
            });
            
            const lineItems = [...parts, ...labor];
            
            const invoice = {
                customerName: document.getElementById('invCustomerName').value,
                customerPhone: document.getElementById('invCustomerPhone').value,
                customerEmail: document.getElementById('invCustomerEmail').value,
                vehicle: document.getElementById('invVehicle').value,
                date: document.getElementById('invDate').value,
                dueDate: document.getElementById('invDueDate').value,
                lineItems: lineItems,
                partsSubtotal: totals.partsSubtotal,
                laborSubtotal: totals.laborSubtotal,
                partsTax: totals.partsTax,
                total: totals.grandTotal,
                paymentMethod: document.getElementById('invPaymentMethod').value,
                notes: document.getElementById('invNotes').value,
                status: 'Unpaid'
            };
            
            // Save to localStorage
            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoice.id = 'INV-' + (invoices.length + 1).toString().padStart(4, '0');
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            alert('‚úÖ Invoice saved successfully!');
            closeInvoiceModal();
            loadInvoices();
        }

        // Load Estimates
        function loadEstimates() {
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            const tbody = document.getElementById('estimatesTable');
            
            // Update stats
            const pending = estimates.filter(e => e.status === 'Pending').length;
            const approved = estimates.filter(e => e.status === 'Approved').length;
            const totalValue = estimates.reduce((sum, e) => sum + e.total, 0);
            
            document.getElementById('estTotalCount').textContent = estimates.length;
            document.getElementById('estPendingCount').textContent = pending;
            document.getElementById('estApprovedCount').textContent = approved;
            document.getElementById('estTotalValue').textContent = `$${totalValue.toFixed(2)}`;
            
            if (estimates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <p>No estimates found</p>
                            <p style="font-size: 12px;">Click "New Estimate" to create your first estimate</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = estimates.map(est => `
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 600; color: #667eea;">${est.id}</td>
                    <td style="padding: 12px; color: #555;">${new Date(est.date).toLocaleDateString()}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${est.customerName}</div>
                        <div style="font-size: 11px; color: #888;">${est.customerPhone}</div>
                    </td>
                    <td style="padding: 12px;">${est.vehicle}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #2ecc71;">$${est.total.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            est.status === 'Approved' ? 'background: #d4edda; color: #155724;' :
                            est.status === 'Pending' ? 'background: #fff3cd; color: #856404;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${est.status}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="viewEstimate('${est.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="convertToInvoice('${est.id}')" title="Convert to Invoice">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="printEstimate('${est.id}')" title="Print">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" onclick="deleteEstimate('${est.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load Invoices
        function loadInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const tbody = document.getElementById('invoicesTable');
            
            // Update stats
            const unpaid = invoices.filter(i => i.status === 'Unpaid' || i.status === 'Partial').length;
            const paid = invoices.filter(i => i.status === 'Paid').length;
            const totalRevenue = invoices.reduce((sum, i) => sum + (i.status === 'Paid' ? i.total : 0), 0);
            
            document.getElementById('invTotalCount').textContent = invoices.length;
            document.getElementById('invUnpaidCount').textContent = unpaid;
            document.getElementById('invPaidCount').textContent = paid;
            document.getElementById('invTotalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            
            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-file-invoice" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <p>No invoices found</p>
                            <p style="font-size: 12px;">Click "New Invoice" to create your first invoice</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = invoices.map(inv => `
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 600; color: #667eea;">${inv.id}</td>
                    <td style="padding: 12px; color: #555;">${new Date(inv.date).toLocaleDateString()}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${inv.customerName}</div>
                        <div style="font-size: 11px; color: #888;">${inv.customerPhone}</div>
                    </td>
                    <td style="padding: 12px;">${inv.vehicle}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #2ecc71;">$${inv.total.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            inv.status === 'Paid' ? 'background: #d4edda; color: #155724;' :
                            inv.status === 'Partial' ? 'background: #e2e3e5; color: #383d41;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${inv.status}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="viewInvoice('${inv.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="markAsPaid('${inv.id}')" title="Mark as Paid" ${inv.status === 'Paid' ? 'disabled style="opacity: 0.5;"' : ''}>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="printInvoice('${inv.id}')" title="Print">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" onclick="deleteInvoice('${inv.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Convert Estimate to Invoice
        function convertToInvoice(estimateId) {
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            const estimate = estimates.find(e => e.id === estimateId);
            
            if (!estimate) {
                alert('Estimate not found');
                return;
            }
            
            // Open invoice modal with estimate data
            openInvoiceModal();
            document.getElementById('invCustomerName').value = estimate.customerName;
            document.getElementById('invCustomerPhone').value = estimate.customerPhone;
            document.getElementById('invCustomerEmail').value = estimate.customerEmail || '';
            document.getElementById('invVehicle').value = estimate.vehicle;
            
            // Populate line items
            const container = document.getElementById('invoiceLineItems');
            container.innerHTML = '<h3>Line Items</h3>';
            
            estimate.lineItems.forEach(item => {
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.innerHTML = `
                    <div class="row">
                        <div class="half">
                            <input type="text" placeholder="Description" class="line-item-desc" value="${item.description}">
                        </div>
                        <div class="third">
                            <input type="number" placeholder="Hours" class="line-item-qty" value="${item.quantity}" step="0.5">
                        </div>
                        <div class="third">
                            <input type="number" placeholder="Rate" class="line-item-rate" value="${item.rate}">
                        </div>
                    </div>
                    <div class="line-item-total">$${item.total.toFixed(2)}</div>
                    <button type="button" class="btn btn-danger" onclick="this.closest('.line-item').remove()" style="margin-top: 5px; padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                `;
                container.appendChild(newItem);
            });
            
            calculateInvoiceTotal();
        }

        // Delete Estimate
        function deleteEstimate(estimateId) {
            if (!confirm('Are you sure you want to delete this estimate?')) return;
            
            let estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            estimates = estimates.filter(e => e.id !== estimateId);
            localStorage.setItem('estimates', JSON.stringify(estimates));
            
            alert('‚úÖ Estimate deleted successfully!');
            loadEstimates();
        }

        // Delete Invoice
        function deleteInvoice(invoiceId) {
            if (!confirm('Are you sure you want to delete this invoice?')) return;
            
            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices = invoices.filter(i => i.id !== invoiceId);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            alert('‚úÖ Invoice deleted successfully!');
            loadInvoices();
        }

        // Print Invoice
        function printInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found');
                return;
            }
            
            // Create a simple print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Invoice ${invoice.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #2c3e50; }
                        .info { margin-bottom: 20px; }
                        .info p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f8f9fa; }
                        .total { text-align: right; font-size: 18px; font-weight: bold; margin-top: 20px; }
                    </style>
</head>
                <body>
                    <div class="header">
                        <h1>üöó VHICL Pro Auto Shop</h1>
                        <p>Invoice #${invoice.id}</p>
                    </div>
                    <div class="info">
                        <p><strong>Customer:</strong> ${invoice.customerName}</p>
                        <p><strong>Phone:</strong> ${invoice.customerPhone}</p>
                        <p><strong>Vehicle:</strong> ${invoice.vehicle}</p>
                        <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                        ${invoice.dueDate ? `<p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>` : ''}
                    </div>
                    <table>
                        <tr><th>Description</th><th>Hours</th><th>Rate</th><th>Total</th></tr>
                        ${invoice.lineItems.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>$${item.rate.toFixed(2)}</td>
                                <td>$${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <div class="total">
                        <p>Subtotal: $${invoice.subtotal.toFixed(2)}</p>
                        <p>Tax: $${invoice.tax.toFixed(2)}</p>
                        <p>Total: $${invoice.total.toFixed(2)}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Search functions
        function searchEstimates() {
            loadEstimates();
            const searchTerm = document.getElementById('searchEstimates').value.toLowerCase();
            const statusFilter = document.getElementById('filterEstimatesByStatus').value;
            const dateFilter = document.getElementById('filterEstimatesByDate').value;
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            
            const filtered = estimates.filter(est => {
                const matchesSearch = !searchTerm || 
                    est.customerName.toLowerCase().includes(searchTerm) ||
                    est.vehicle.toLowerCase().includes(searchTerm) ||
                    est.id.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || est.status === statusFilter;
                
                const estDate = new Date(est.date);
                const today = new Date();
                const matchesDate = dateFilter === 'all' ||
                    (dateFilter === 'today' && estDate.toDateString() === today.toDateString()) ||
                    (dateFilter === 'week' && isThisWeek(estDate)) ||
                    (dateFilter === 'month' && estDate.getMonth() === today.getMonth() && estDate.getFullYear() === today.getFullYear()) ||
                    (dateFilter === 'year' && estDate.getFullYear() === today.getFullYear());
                
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            renderFilteredEstimates(filtered);
        }

        function filterEstimatesByStatus() {
            searchEstimates();
        }

        function filterEstimatesByDate() {
            searchEstimates();
        }

        function renderFilteredEstimates(estimates) {
            const tbody = document.getElementById('estimatesTable');
            
            if (estimates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <p>No estimates match your filters</p>
                            <p style="font-size: 12px;">Try adjusting your search or filter criteria</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = estimates.map(est => `
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 600; color: #667eea;">${est.id}</td>
                    <td style="padding: 12px; color: #555;">${new Date(est.date).toLocaleDateString()}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${est.customerName}</div>
                        <div style="font-size: 11px; color: #888;">${est.customerPhone}</div>
                    </td>
                    <td style="padding: 12px;">${est.vehicle}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #2ecc71;">$${est.total.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            est.status === 'Approved' ? 'background: #d4edda; color: #155724;' :
                            est.status === 'Pending' ? 'background: #fff3cd; color: #856404;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${est.status}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="viewEstimate('${est.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="convertToInvoice('${est.id}')" title="Convert to Invoice">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="printEstimate('${est.id}')" title="Print">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" onclick="deleteEstimate('${est.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function searchInvoices() {
            loadInvoices();
            const searchTerm = document.getElementById('searchInvoices').value.toLowerCase();
            const statusFilter = document.getElementById('filterInvoicesByStatus').value;
            const dateFilter = document.getElementById('filterInvoicesByDate').value;
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            
            const filtered = invoices.filter(inv => {
                const matchesSearch = !searchTerm || 
                    inv.customerName.toLowerCase().includes(searchTerm) ||
                    inv.vehicle.toLowerCase().includes(searchTerm) ||
                    inv.id.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || inv.status === statusFilter;
                
                const invDate = new Date(inv.date);
                const today = new Date();
                const matchesDate = dateFilter === 'all' ||
                    (dateFilter === 'today' && invDate.toDateString() === today.toDateString()) ||
                    (dateFilter === 'week' && isThisWeek(invDate)) ||
                    (dateFilter === 'month' && invDate.getMonth() === today.getMonth() && invDate.getFullYear() === today.getFullYear()) ||
                    (dateFilter === 'year' && invDate.getFullYear() === today.getFullYear());
                
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            renderFilteredInvoices(filtered);
        }

        function filterInvoicesByStatus() {
            searchInvoices();
        }

        function filterInvoicesByDate() {
            searchInvoices();
        }

        function renderFilteredInvoices(invoices) {
            const tbody = document.getElementById('invoicesTable');
            
            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <p>No invoices match your filters</p>
                            <p style="font-size: 12px;">Try adjusting your search or filter criteria</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = invoices.map(inv => `
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px; font-weight: 600; color: #667eea;">${inv.id}</td>
                    <td style="padding: 12px; color: #555;">${new Date(inv.date).toLocaleDateString()}</td>
                    <td style="padding: 12px;">
                        <div style="font-weight: 500;">${inv.customerName}</div>
                        <div style="font-size: 11px; color: #888;">${inv.customerPhone}</div>
                    </td>
                    <td style="padding: 12px;">${inv.vehicle}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #2ecc71;">$${inv.total.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            inv.status === 'Paid' ? 'background: #d4edda; color: #155724;' :
                            inv.status === 'Partial' ? 'background: #e2e3e5; color: #383d41;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${inv.status}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="viewInvoice('${inv.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="markAsPaid('${inv.id}')" title="Mark as Paid" ${inv.status === 'Paid' ? 'disabled style="opacity: 0.5;"' : ''}>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-info" style="padding: 6px 12px; font-size: 11px; margin-right: 5px;" onclick="printInvoice('${inv.id}')" title="Print">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 11px;" onclick="deleteInvoice('${inv.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function isThisWeek(date) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(sunday.getDate() + 6);
            return date >= monday && date <= sunday;
        }

        function viewEstimate(estimateId) {
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            const estimate = estimates.find(e => e.id === estimateId);
            
            if (!estimate) {
                alert('Estimate not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>üìã Estimate Details - ${estimate.id}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #667eea;">Customer Information</h4>
                            <p><strong>Name:</strong> ${estimate.customerName}</p>
                            <p><strong>Phone:</strong> ${estimate.customerPhone}</p>
                            ${estimate.customerEmail ? `<p><strong>Email:</strong> ${estimate.customerEmail}</p>` : ''}
                            <p><strong>Vehicle:</strong> ${estimate.vehicle}</p>
                        </div>
                        
                        <h4 style="margin-bottom: 15px;">Line Items</h4>
                        <table style="width: 100%; margin-bottom: 20px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 10px; text-align: left;">Description</th>
                                    <th style="padding: 10px; text-align: right;">Hours</th>
                                    <th style="padding: 10px; text-align: right;">Rate</th>
                                    <th style="padding: 10px; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${estimate.lineItems.map(item => `
                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 10px;">${item.description}</td>
                                        <td style="padding: 10px; text-align: right;">${item.hours}</td>
                                        <td style="padding: 10px; text-align: right;">$${item.rate.toFixed(2)}</td>
                                        <td style="padding: 10px; text-align: right;">$${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="text-align: right; font-size: 18px; font-weight: bold; color: #2ecc71; margin-bottom: 20px;">
                            Total: $${estimate.total.toFixed(2)}
                        </div>
                        
                        <p><strong>Status:</strong> <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            estimate.status === 'Approved' ? 'background: #d4edda; color: #155724;' :
                            estimate.status === 'Pending' ? 'background: #fff3cd; color: #856404;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${estimate.status}</span></p>
                        
                        <p><strong>Date:</strong> ${new Date(estimate.date).toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function viewInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>üìÑ Invoice Details - ${invoice.id}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #667eea;">Customer Information</h4>
                            <p><strong>Name:</strong> ${invoice.customerName}</p>
                            <p><strong>Phone:</strong> ${invoice.customerPhone}</p>
                            ${invoice.customerEmail ? `<p><strong>Email:</strong> ${invoice.customerEmail}</p>` : ''}
                            <p><strong>Vehicle:</strong> ${invoice.vehicle}</p>
                        </div>
                        
                        <h4 style="margin-bottom: 15px;">Line Items</h4>
                        <table style="width: 100%; margin-bottom: 20px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 10px; text-align: left;">Description</th>
                                    <th style="padding: 10px; text-align: right;">Hours</th>
                                    <th style="padding: 10px; text-align: right;">Rate</th>
                                    <th style="padding: 10px; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.lineItems.map(item => `
                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 10px;">${item.description}</td>
                                        <td style="padding: 10px; text-align: right;">${item.hours}</td>
                                        <td style="padding: 10px; text-align: right;">$${item.rate.toFixed(2)}</td>
                                        <td style="padding: 10px; text-align: right;">$${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="text-align: right; margin-bottom: 20px;">
                            <div style="margin-bottom: 5px;">Subtotal: $${invoice.subtotal.toFixed(2)}</div>
                            <div style="margin-bottom: 5px;">Tax (${(invoice.taxRate * 100).toFixed(0)}%): $${invoice.tax.toFixed(2)}</div>
                            <div style="font-size: 18px; font-weight: bold; color: #2ecc71;">Total: $${invoice.total.toFixed(2)}</div>
                        </div>
                        
                        <p><strong>Status:</strong> <span style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; ${
                            invoice.status === 'Paid' ? 'background: #d4edda; color: #155724;' :
                            invoice.status === 'Partial' ? 'background: #e2e3e5; color: #383d41;' :
                            'background: #f8d7da; color: #721c24;'
                        }">${invoice.status}</span></p>
                        
                        ${invoice.paymentMethod ? `<p><strong>Payment Method:</strong> ${invoice.paymentMethod}</p>` : ''}
                        
                        <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function markAsPaid(invoiceId) {
            if (!confirm('Mark this invoice as paid?')) return;
            
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            
            if (!invoice) {
                alert('Invoice not found');
                return;
            }
            
            invoice.status = 'Paid';
            invoice.paidDate = new Date().toISOString();
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            loadInvoices();
            alert('Invoice marked as paid!');
        }

        function printEstimate(estimateId) {
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            const estimate = estimates.find(e => e.id === estimateId);
            
            if (!estimate) {
                alert('Estimate not found');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Estimate ${estimate.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
                        .header h1 { color: #667eea; margin: 0; }
                        .info { margin-bottom: 30px; }
                        .info h3 { color: #667eea; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background: #667eea; color: white; padding: 12px; text-align: left; }
                        td { padding: 12px; border-bottom: 1px solid #ddd; }
                        .total { text-align: right; font-size: 24px; font-weight: bold; color: #2ecc71; margin-top: 20px; }
                        .status { text-align: center; padding: 10px; border-radius: 5px; font-weight: bold; }
                        .status.approved { background: #d4edda; color: #155724; }
                        .status.pending { background: #fff3cd; color: #856404; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìã ESTIMATE</h1>
                        <p style="color: #7f8c8d;">${new Date(estimate.date).toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info">
                        <h3>Customer Information</h3>
                        <p><strong>Name:</strong> ${estimate.customerName}</p>
                        <p><strong>Phone:</strong> ${estimate.customerPhone}</p>
                        ${estimate.customerEmail ? `<p><strong>Email:</strong> ${estimate.customerEmail}</p>` : ''}
                        <p><strong>Vehicle:</strong> ${estimate.vehicle}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="text-align: right;">Hours</th>
                                <th style="text-align: right;">Rate</th>
                                <th style="text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estimate.lineItems.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td style="text-align: right;">${item.hours}</td>
                                    <td style="text-align: right;">$${item.rate.toFixed(2)}</td>
                                    <td style="text-align: right;">$${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">Total: $${estimate.total.toFixed(2)}</div>
                    
                    <div class="status ${estimate.status.toLowerCase()}">
                        Status: ${estimate.status}
                    </div>
                    
                    <p style="text-align: center; color: #7f8c8d; margin-top: 40px; font-size: 12px;">
                        Thank you for your business!
                    </p>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Appointment Modal Functions
        function openAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('active');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('apptDate').value = today;
        }

        function closeAppointmentModal() {
            const modal = document.getElementById('appointmentModal');
            if (modal) {
                modal.classList.remove('active');
                document.getElementById('appointmentForm').reset();
            }
        }

        // Save Appointment
        async function saveAppointment(event) {
            event.preventDefault();
            
            const appointment = {
                customerName: document.getElementById('apptCustomerName').value,
                customerPhone: document.getElementById('apptCustomerPhone').value,
                customerEmail: document.getElementById('apptCustomerEmail').value,
                vehicle: document.getElementById('apptVehicle').value,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                service: document.getElementById('apptService').value,
                notes: document.getElementById('apptNotes').value,
                status: 'Scheduled'
            };
            
            let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            appointment.id = appointments.length + 1;
            appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            alert('‚úÖ Appointment saved successfully!');
            closeAppointmentModal();
            loadAppointments();
        }

        // Load Appointments
        function loadAppointments() {
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const tbody = document.getElementById('appointmentsTable');
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7f8c8d;">No appointments found</td></tr>';
                return;
            }
            
            tbody.innerHTML = appointments.map(apt => `
                <tr>
                    <td>
                        <strong>${new Date(apt.date).toLocaleDateString()}</strong><br>
                        <small>${apt.time}</small>
                    </td>
                    <td>${apt.customerName}</td>
                    <td>${apt.vehicle}</td>
                    <td>${apt.service}</td>
                    <td><span class="status-badge ${apt.status === 'Scheduled' ? 'success' : 'warning'}">${apt.status}</span></td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteAppointment('${apt.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteAppointment(id) {
            if (!confirm('Are you sure you want to delete this appointment?')) return;
            
            let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            appointments = appointments.filter(a => a.id !== id);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            alert('‚úÖ Appointment deleted successfully!');
            loadAppointments();
        }

        function searchAppointments() {
            const searchTerm = document.getElementById('searchAppointments').value.toLowerCase();
            const rows = document.querySelectorAll('#appointmentsTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterAppointments() {
            const filter = document.getElementById('filterAppointments').value;
            alert('Filter by ' + filter + ' - coming soon');
        }

        // Tech Workflow
        async function loadTechWorkflow() {
            try {
                const response = await fetch('/api/tech/stats');
                const stats = await response.json();
                
                document.getElementById('techActiveJobs').textContent = stats.activeJobs;
                document.getElementById('techCompletedToday').textContent = stats.completedToday;
                document.getElementById('techTotalHours').textContent = stats.totalHours.toFixed(1);
                document.getElementById('techRating').textContent = stats.rating;
                
                loadTechActiveJobs();
                loadTechCompletedJobs();
            } catch (error) {
                console.error('Error loading tech workflow:', error);
            }
        }

        async function loadTechActiveJobs() {
            try {
                const response = await fetch('/api/tech/jobs/active');
                const data = await response.json();
                
                const tbody = document.getElementById('techActiveJobsTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">No active jobs</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(job => `
                    <tr>
                        <td><strong>${job.id}</strong></td>
                        <td>${job.customerName || 'N/A'}</td>
                        <td>${job.vehicle || 'N/A'}</td>
                        <td>${job.service || 'N/A'}</td>
                        <td><span class="status-badge warning">Bay ${job.bay || 'TBD'}</span></td>
                        <td>${job.status === 'In Progress' ? '50%' : '0%'}</td>
                        <td>
                            <button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading active jobs:', error);
            }
        }

        async function loadTechCompletedJobs() {
            try {
                const response = await fetch('/api/tech/jobs/completed');
                const data = await response.json();
                
                const tbody = document.getElementById('techCompletedJobsTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7f8c8d;">No completed jobs today</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(job => `
                    <tr>
                        <td><strong>${job.id}</strong></td>
                        <td>${job.customerName || 'N/A'}</td>
                        <td>${job.vehicle || 'N/A'}</td>
                        <td>${job.service || 'N/A'}</td>
                        <td>${job.hoursSpent || 0} hrs</td>
                        <td>${new Date(job.completedAt).toLocaleTimeString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading completed jobs:', error);
            }
        }

        // Settings
        function saveSettings() {
            const settings = {
                shopName: document.getElementById('settingShopName').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                address: document.getElementById('settingAddress').value,
                laborRate: parseFloat(document.getElementById('settingLaborRate').value),
                taxRate: parseFloat(document.getElementById('settingTaxRate').value), // Store as percentage (e.g., 7 for 7%)
                diagnosticFee: parseFloat(document.getElementById('settingDiagnosticFee').value),
                vapiServerUrl: document.getElementById('settingServerUrl').value
            };
            
            localStorage.setItem('shopSettings', JSON.stringify(settings));
            
            alert('‚úÖ Settings saved successfully!');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('shopSettings') || '{}');
            
            if (settings.shopName) document.getElementById('settingShopName').value = settings.shopName;
            if (settings.phone) document.getElementById('settingPhone').value = settings.phone;
            if (settings.email) document.getElementById('settingEmail').value = settings.email;
            if (settings.address) document.getElementById('settingAddress').value = settings.address;
            if (settings.laborRate) document.getElementById('settingLaborRate').value = settings.laborRate;
            if (settings.taxRate !== undefined) document.getElementById('settingTaxRate').value = settings.taxRate;
            if (settings.diagnosticFee) document.getElementById('settingDiagnosticFee').value = settings.diagnosticFee;
            if (settings.vapiServerUrl) document.getElementById('settingServerUrl').value = settings.vapiServerUrl;
            
            // Update tax labels in modals
            const taxRate = (parseFloat(settings.taxRate) || 7);
            updateTaxLabels(taxRate);
        }

        function updateTaxLabels(taxRate) {
            const taxPercent = taxRate.toFixed(1);
            const taxLabel = taxPercent === '0.0' ? '0%' : taxPercent + '%';
            
            const estTaxLabel = document.getElementById('estTaxLabel');
            if (estTaxLabel) estTaxLabel.textContent = `Parts Tax (${taxLabel})`;
            
            const invTaxLabel = document.getElementById('invTaxLabel');
            if (invTaxLabel) invTaxLabel.textContent = `Parts Tax (${taxLabel})`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings(); // Load shop settings first
            loadAppointments();
            loadTechWorkflow();
            loadEstimates();
            loadInvoices();
            loadALEXConfig();
            loadPartsStores();
            loadAnalyticsData();

            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        });

        // ==================== ALEX / NEXPART FUNCTIONS ====================

        function loadALEXConfig() {
            // Load services we don't do
            const servicesWeDontDo = JSON.parse(localStorage.getItem('servicesWeDontDo') || '[]');
            const container = document.getElementById('servicesWeDontDo');
            if (container) {
                container.innerHTML = servicesWeDontDo.map((service, index) => `
                    <span style="display: inline-block; background: #f44336; color: white; padding: 5px 10px; margin: 5px; border-radius: 15px; cursor: pointer;" onclick="removeServiceNotOffered(${index})">
                        ${service} ‚úï
                    </span>
                `).join('');
            }

            // Load lookup history
            loadALEXActivityLog();
        }

        function addServiceNotOffered() {
            const input = document.getElementById('newServiceNotOffered');
            const service = input.value.trim();
            if (!service) return;

            const servicesWeDontDo = JSON.parse(localStorage.getItem('servicesWeDontDo') || '[]');
            if (!servicesWeDontDo.includes(service)) {
                servicesWeDontDo.push(service);
                localStorage.setItem('servicesWeDontDo', JSON.stringify(servicesWeDontDo));
                loadALEXConfig();
                input.value = '';
            }
        }

        function removeServiceNotOffered(index) {
            const servicesWeDontDo = JSON.parse(localStorage.getItem('servicesWeDontDo') || '[]');
            servicesWeDontDo.splice(index, 1);
            localStorage.setItem('servicesWeDontDo', JSON.stringify(servicesWeDontDo));
            loadALEXConfig();
        }

        function loadALEXActivityLog() {
            const history = JSON.parse(localStorage.getItem('alexLookupHistory') || '[]');
            const container = document.getElementById('alexActivityLog');
            if (container) {
                if (history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No lookups yet</p>';
                } else {
                    container.innerHTML = history.slice(0, 20).map(item => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <div style="font-weight: bold;">${item.type} - ${item.query}</div>
                            <div style="color: #666; font-size: 12px;">${item.timestamp} - ${item.result}</div>
                        </div>
                    `).join('');
                }
            }

            // Update stats
            const today = new Date().toDateString();
            const todayLookups = history.filter(h => new Date(h.timestamp).toDateString() === today);
            const partsLookups = todayLookups.filter(h => h.type === 'Parts Lookup');
            const laborLookups = todayLookups.filter(h => h.type === 'Labor Lookup');
            const vinDecodes = history.filter(h => h.type === 'VIN Decode');
            const plateLookups = history.filter(h => h.type === 'Plate Lookup');

            document.getElementById('alexLookupsToday').textContent = partsLookups.length;
            document.getElementById('alexLaborLookups').textContent = laborLookups.length;
            document.getElementById('alexPartsFound').textContent = history.filter(h => h.type === 'Parts Lookup').length;
            document.getElementById('alexVINDecodes').textContent = vinDecodes.length;
            document.getElementById('alexPlateLookups').textContent = plateLookups.length;
        }

        function addALEXActivity(type, query, result) {
            const history = JSON.parse(localStorage.getItem('alexLookupHistory') || '[]');
            history.unshift({
                type,
                query,
                result,
                timestamp: new Date().toLocaleString()
            });
            localStorage.setItem('alexLookupHistory', JSON.stringify(history.slice(0, 100))); // Keep last 100
            loadALEXActivityLog();
        }

        // ==================== NEXPART MODALS ====================

        function openPartsLookupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>üîß Parts Lookup - Nexpart</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Vehicle Description / Tag Number:</label>
                            <input type="text" id="vehicleTagInput" placeholder="e.g., Red Toyota Camry - ABC123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Part to Look Up:</label>
                            <input type="text" id="partToLookupInput" placeholder="e.g., Brake Pads, Oil Filter, Alternator" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Search By (Optional):</label>
                            <select id="partsSearchType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="togglePartsSearchFields()">
                                <option value="description">Part Description</option>
                                <option value="partNumber">Part Number</option>
                                <option value="vehicle">Vehicle (Make/Model/Year)</option>
                            </select>
                        </div>

                        <div id="partNumberField" style="margin-bottom: 15px; display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Part Number:</label>
                            <input type="text" id="partNumberInput" placeholder="e.g., 513123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div id="descriptionField" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Part Description:</label>
                            <input type="text" id="partDescriptionInput" placeholder="e.g., Brake Pads" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>

                        <div id="vehicleFields" style="margin-bottom: 15px; display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Year:</label>
                                    <input type="number" id="vehicleYearInput" placeholder="2022" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Make:</label>
                                    <input type="text" id="vehicleMakeInput" placeholder="Toyota" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Model:</label>
                                    <input type="text" id="vehicleModelInput" placeholder="Camry" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary" style="width: 100%;" onclick="searchNexpartParts()">üîç Search Nexpart</button>
                    </div>
                    <div id="partsResults" class="modal-results"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function togglePartsSearchFields() {
            const searchType = document.getElementById('partsSearchType').value;
            document.getElementById('partNumberField').style.display = searchType === 'partNumber' ? 'block' : 'none';
            document.getElementById('descriptionField').style.display = searchType === 'description' ? 'block' : 'none';
            document.getElementById('vehicleFields').style.display = searchType === 'vehicle' ? 'block' : 'none';
        }

        async function searchNexpartParts() {
            const searchType = document.getElementById('partsSearchType').value;
            const resultsContainer = document.getElementById('partsResults');
            const vehicleTag = document.getElementById('vehicleTagInput').value.trim();
            const partToLookup = document.getElementById('partToLookupInput').value.trim();
            
            if (!partToLookup) {
                alert('Please enter a part to look up');
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Searching Nexpart...</div>';

            let searchParams = {};
            let queryStr = '';

            if (searchType === 'partNumber') {
                const partNumber = document.getElementById('partNumberInput').value.trim();
                if (!partNumber) {
                    alert('Please enter a part number');
                    return;
                }
                searchParams = { partNumber };
                queryStr = `Part #${partNumber}`;
            } else {
                // Use the "Part to Look Up" field for description search
                const description = partToLookup;
                searchParams = { description };
                queryStr = description;
            }

            try {
                const response = await fetch('/api/parts/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(searchParams)
                });

                const data = await response.json();

                if (data.success && data.parts && data.parts.length > 0) {
                    const vehicleTagDisplay = vehicleTag ? `<div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px;"><strong>üöó Vehicle:</strong> ${vehicleTag}</div>` : '';
                    
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px;">
                            ${vehicleTagDisplay}
                            <h4>üì¶ Found ${data.parts.length} parts for "${queryStr}"</h4>
                            ${data.parts.map(part => `
                                <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                                    <div style="font-weight: bold; margin-bottom: 5px;">${part.number || 'N/A'} - ${part.description}</div>
                                    <div style="color: #2ecc71; font-weight: bold; font-size: 18px;">$${(part.price || 0).toFixed(2)}</div>
                                    <div style="color: #666; font-size: 12px;">Availability: ${part.availability || 'Unknown'}</div>
                                    <button class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="addPartToInvoice('${part.number}', '${part.description}', ${part.price})">‚ûï Add to Invoice</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    addALEXActivity('Parts Lookup', queryStr, `Found ${data.parts.length} parts`);
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #f44336;">
                            ${vehicleTag ? `<div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px;"><strong>üöó Vehicle:</strong> ${vehicleTag}</div>` : ''}
                            ‚ùå No parts found for "${queryStr}"
                        </div>
                    `;
                    addALEXActivity('Parts Lookup', queryStr, 'No results');
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336;">
                        ‚ùå Error searching parts: ${error.message}
                    </div>
                `;
                addALEXActivity('Parts Lookup', queryStr, 'Error');
            }
        }

        function addPartToInvoice(number, description, price) {
            const currentTab = document.querySelector('.nav-btn.active').textContent.trim();
            
            if (currentTab === 'Estimates') {
                const container = document.getElementById('estimateParts');
                if (container.querySelector('p')) {
                    container.innerHTML = '';
                }
                
                const partDiv = document.createElement('div');
                partDiv.className = 'item-row';
                partDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
                partDiv.innerHTML = `
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Description</label>
                        <input type="text" class="part-desc" value="${number} - ${description}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Quantity</label>
                        <input type="number" class="part-qty" value="1" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Price</label>
                        <input type="number" class="part-price" value="${price.toFixed(2)}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateEstimateTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Total</label>
                        <div class="part-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$${price.toFixed(2)}</div>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeEstimatePart(this)" style="padding: 8px 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(partDiv);
                calculateEstimateTotal();
                
                // Close the parts lookup modal
                document.querySelector('.modal.active .close-btn').click();
            } else if (currentTab === 'Invoices') {
                const container = document.getElementById('invoiceParts');
                if (container.querySelector('p')) {
                    container.innerHTML = '';
                }
                
                const partDiv = document.createElement('div');
                partDiv.className = 'item-row';
                partDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; padding: 10px; border-bottom: 1px solid #eee;';
                partDiv.innerHTML = `
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Description</label>
                        <input type="text" class="inv-part-desc" value="${number} - ${description}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Quantity</label>
                        <input type="number" class="inv-part-qty" value="1" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Price</label>
                        <input type="number" class="inv-part-price" value="${price.toFixed(2)}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="calculateInvoiceTotal()">
                    </div>
                    <div>
                        <label style="font-size: 11px; font-weight: bold;">Total</label>
                        <div class="inv-part-total" style="padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center; font-weight: bold;">$${price.toFixed(2)}</div>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeInvoicePart(this)" style="padding: 8px 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(partDiv);
                calculateInvoiceTotal();
                
                // Close the parts lookup modal
                document.querySelector('.modal.active .close-btn').click();
                document.getElementById('invoiceLineItems').appendChild(newItem);
                updateInvoiceTotals();
            }

            alert(`‚úÖ Added ${number} - ${description} ($${price.toFixed(2)})`);
            document.querySelector('.modal').remove();
        }

        function openLaborLookupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>‚è±Ô∏è Labor Lookup - Nexpart</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Vehicle Year:</label>
                            <input type="number" id="laborYearInput" placeholder="2022" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Make:</label>
                            <input type="text" id="laborMakeInput" placeholder="Toyota" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Model:</label>
                            <input type="text" id="laborModelInput" placeholder="Camry" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Operation/Service:</label>
                            <input type="text" id="laborOperationInput" placeholder="e.g., Brake Pad Replacement" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="searchNexpartLabor()">‚è±Ô∏è Get Labor Time</button>
                    </div>
                    <div id="laborResults" class="modal-results"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function searchNexpartLabor() {
            const year = document.getElementById('laborYearInput').value.trim();
            const make = document.getElementById('laborMakeInput').value.trim();
            const model = document.getElementById('laborModelInput').value.trim();
            const operation = document.getElementById('laborOperationInput').value.trim();
            const resultsContainer = document.getElementById('laborResults');

            if (!year || !make || !model || !operation) {
                alert('Please fill in all fields');
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Looking up labor time...</div>';

            try {
                const response = await fetch('/api/labor/estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicle: { year, make, model },
                        operation
                    })
                });

                const data = await response.json();
                const shopSettings = JSON.parse(localStorage.getItem('shopSettings') || '{}');
                const laborRate = shopSettings.laborRate || 100;

                if (data.success && data.estimate) {
                    const hours = data.estimate.hours || 0;
                    const cost = hours * laborRate;

                    resultsContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>‚è±Ô∏è Labor Time Found</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${hours.toFixed(1)} Hours</div>
                                <div style="color: #666;">at $${laborRate.toFixed(2)}/hr = <strong>$${cost.toFixed(2)}</strong></div>
                            </div>
                            <button class="btn btn-primary" style="width: 100%;" onclick="addLaborToInvoice('${operation}', ${hours}, ${cost})">‚ûï Add to Invoice</button>
                        </div>
                    `;
                    addALEXActivity('Labor Lookup', `${year} ${make} ${model} - ${operation}`, `${hours.toFixed(1)} hours`);
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #f44336;">
                            ‚ùå Labor time not found. Try a different operation name.
                        </div>
                    `;
                    addALEXActivity('Labor Lookup', `${year} ${make} ${model} - ${operation}`, 'Not found');
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336;">
                        ‚ùå Error looking up labor: ${error.message}
                    </div>
                `;
                addALEXActivity('Labor Lookup', `${year} ${make} ${model} - ${operation}`, 'Error');
            }
        }

        function addLaborToInvoice(description, hours, cost) {
            const currentTab = document.querySelector('.nav-btn.active').textContent.trim();
            
            if (currentTab === 'Estimates') {
                const lineItems = document.querySelectorAll('#estimateLineItems .line-item');
                const newItem = createLineItem();
                newItem.querySelector('.item-description').value = description;
                newItem.querySelector('.item-hours').value = hours.toFixed(1);
                newItem.querySelector('.item-rate').value = (cost / hours).toFixed(2);
                newItem.querySelector('.item-amount').value = cost.toFixed(2);
                document.getElementById('estimateLineItems').appendChild(newItem);
                updateEstimateTotals();
            } else if (currentTab === 'Invoices') {
                const lineItems = document.querySelectorAll('#invoiceLineItems .line-item');
                const newItem = createLineItem();
                newItem.querySelector('.item-description').value = description;
                newItem.querySelector('.item-hours').value = hours.toFixed(1);
                newItem.querySelector('.item-rate').value = (cost / hours).toFixed(2);
                newItem.querySelector('.item-amount').value = cost.toFixed(2);
                document.getElementById('invoiceLineItems').appendChild(newItem);
                updateInvoiceTotals();
            }

            alert(`‚úÖ Added ${description} (${hours.toFixed(1)} hrs) - $${cost.toFixed(2)}`);
            document.querySelector('.modal').remove();
        }

        function openVINDecoderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>üöó VIN Decoder - Nexpart ACES</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">VIN (17 characters):</label>
                            <input type="text" id="vinInput" placeholder="e.g., 2T1BURHE0HC123456" maxlength="17" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-transform: uppercase;">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="decodeVIN()">üöó Decode VIN</button>
                    </div>
                    <div id="vinResults" class="modal-results"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function decodeVIN() {
            const vin = document.getElementById('vinInput').value.trim().toUpperCase();
            const resultsContainer = document.getElementById('vinResults');

            if (vin.length !== 17) {
                alert('Please enter a valid 17-character VIN');
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Decoding VIN...</div>';

            try {
                const response = await fetch(`/api/vin/decode/${vin}`);
                const data = await response.json();

                if (data.success && data.vehicle) {
                    const v = data.vehicle;
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>üöó Vehicle Decoded</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <div><strong>Make:</strong> ${v.make || 'N/A'}</div>
                                <div><strong>Model:</strong> ${v.model || 'N/A'}</div>
                                <div><strong>Year:</strong> ${v.year || 'N/A'}</div>
                                <div><strong>Trim:</strong> ${v.trim || 'N/A'}</div>
                                <div><strong>Engine:</strong> ${v.engine || 'N/A'}</div>
                                <div><strong>Transmission:</strong> ${v.transmission || 'N/A'}</div>
                                <div><strong>Drive Type:</strong> ${v.driveType || 'N/A'}</div>
                                <div><strong>Body Style:</strong> ${v.bodyStyle || 'N/A'}</div>
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="fillVehicleFromVIN('${v.make}', '${v.model}', '${v.year}')">‚ûï Use This Vehicle</button>
                        </div>
                    `;
                    addALEXActivity('VIN Decode', vin, `${v.year} ${v.make} ${v.model}`);
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #f44336;">
                            ‚ùå VIN not found. Please check the VIN and try again.
                        </div>
                    `;
                    addALEXActivity('VIN Decode', vin, 'Not found');
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336;">
                        ‚ùå Error decoding VIN: ${error.message}
                    </div>
                `;
                addALEXActivity('VIN Decode', vin, 'Error');
            }
        }

        function fillVehicleFromVIN(make, model, year) {
            alert(`‚úÖ Vehicle set: ${year} ${make} ${model}`);
            document.querySelector('.modal').remove();
            // You could auto-fill form fields if needed
        }

        function openLicensePlateModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>ü™™ License Plate ‚Üí VIN - Nexpart</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">License Plate Number:</label>
                            <input type="text" id="plateInput" placeholder="e.g., ABC1234" maxlength="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-transform: uppercase;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">State:</label>
                            <select id="plateStateInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Select State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="lookupLicensePlate()">ü™™ Get VIN from Plate</button>
                    </div>
                    <div id="plateResults" class="modal-results"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function lookupLicensePlate() {
            const plate = document.getElementById('plateInput').value.trim().toUpperCase();
            const state = document.getElementById('plateStateInput').value;
            const resultsContainer = document.getElementById('plateResults');

            if (!plate) {
                alert('Please enter a license plate number');
                return;
            }

            if (!state) {
                alert('Please select a state');
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Looking up VIN from license plate...</div>';

            try {
                const response = await fetch(`/api/license-plate/lookup/${plate}/${state}`);
                const data = await response.json();

                if (data.success && data.vehicle) {
                    const v = data.vehicle;
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>ü™™ License Plate Found</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="font-size: 18px; font-weight: bold; color: #2ecc71;">${plate} (${state})</div>
                                <div style="color: #666;">VIN: <strong>${v.vin}</strong></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div><strong>Make:</strong> ${v.make || 'N/A'}</div>
                                <div><strong>Model:</strong> ${v.model || 'N/A'}</div>
                                <div><strong>Year:</strong> ${v.year || 'N/A'}</div>
                                <div><strong>Color:</strong> ${v.color || 'N/A'}</div>
                                <div><strong>Body Style:</strong> ${v.bodyStyle || 'N/A'}</div>
                                <div><strong>Engine:</strong> ${v.engine || 'N/A'}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="btn btn-primary" onclick="decodeVINFromPlate('${v.vin}')">üîç Decode VIN</button>
                                <button class="btn btn-success" onclick="fillVehicleFromPlate('${v.make}', '${v.model}', '${v.year}')">‚ûï Use Vehicle</button>
                            </div>
                        </div>
                    `;
                    addALEXActivity('Plate Lookup', `${plate} (${state})`, `Found: ${v.year} ${v.make} ${v.model}`);
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #f44336;">
                            ‚ùå License plate not found. Please check the plate number and state.
                        </div>
                    `;
                    addALEXActivity('Plate Lookup', `${plate} (${state})`, 'Not found');
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336;">
                        ‚ùå Error looking up license plate: ${error.message}
                    </div>
                `;
                addALEXActivity('Plate Lookup', `${plate} (${state})`, 'Error');
            }
        }

        function decodeVINFromPlate(vin) {
            document.querySelector('.modal').remove();
            openVINDecoderModal();
            document.getElementById('vinInput').value = vin;
            decodeVIN();
        }

        function fillVehicleFromPlate(make, model, year) {
            alert(`‚úÖ Vehicle set: ${year} ${make} ${model}`);
            document.querySelector('.modal').remove();
            // You could auto-fill form fields if needed
        }

        function openVehiclePartsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>üìã Vehicle Parts - Nexpart</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Year:</label>
                                <input type="number" id="vpYearInput" placeholder="2022" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Make:</label>
                                <input type="text" id="vpMakeInput" placeholder="Toyota" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Model:</label>
                                <input type="text" id="vpModelInput" placeholder="Camry" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="getVehicleParts()">üìã Get Compatible Parts</button>
                    </div>
                    <div id="vehiclePartsResults" class="modal-results"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function getVehicleParts() {
            const year = document.getElementById('vpYearInput').value.trim();
            const make = document.getElementById('vpMakeInput').value.trim();
            const model = document.getElementById('vpModelInput').value.trim();
            const resultsContainer = document.getElementById('vehiclePartsResults');

            if (!year || !make || !model) {
                alert('Please enter vehicle year, make, and model');
                return;
            }

            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">‚è≥ Loading compatible parts...</div>';

            try {
                const response = await fetch(`/api/vehicles/compatible/${year}/${make}/${model}`);
                const data = await response.json();

                if (data.success && data.parts && data.parts.length > 0) {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <h4>üì¶ Found ${data.parts.length} compatible parts</h4>
                            ${data.parts.slice(0, 20).map(part => `
                                <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-radius: 5px;">
                                    <div style="font-weight: bold;">${part.partNumber || 'N/A'}</div>
                                    <div style="color: #666;">${part.description}</div>
                                    <button class="btn btn-sm btn-primary" style="margin-top: 5px;" onclick="addPartToInvoice('${part.partNumber}', '${part.description}', ${part.price || 0})">‚ûï Add</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    addALEXActivity('Vehicle Parts', `${year} ${make} ${model}`, `Found ${data.parts.length} parts`);
                } else {
                    resultsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #f44336;">
                            ‚ùå No compatible parts found
                        </div>
                    `;
                    addALEXActivity('Vehicle Parts', `${year} ${make} ${model}`, 'No results');
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #f44336;">
                        ‚ùå Error loading parts: ${error.message}
                    </div>
                `;
                addALEXActivity('Vehicle Parts', `${year} ${make} ${model}`, 'Error');
            }
        }

        function refreshALEX() {
            loadALEXActivityLog();
        }

        // ==================== PARTS STORES FUNCTIONS ====================

        function loadPartsStores() {
            const stores = JSON.parse(localStorage.getItem('partsStores') || '[]');
            const tbody = document.getElementById('storesTableBody');
            
            if (stores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999; padding: 30px;">
                            No parts stores added yet. Click "Add Store" to get started.
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = stores.map(store => `
                    <tr>
                        <td>
                            <div style="font-weight: bold;">${store.name}</div>
                            <div style="font-size: 12px; color: #666;">${store.type || 'Auto Parts'}</div>
                        </td>
                        <td>
                            <div>${store.city}, ${store.state}</div>
                            <div style="font-size: 12px; color: #666;">${store.distance || 'N/A'} miles</div>
                        </td>
                        <td>
                            <a href="tel:${store.phone}" style="color: #2ecc71;">${store.phone}</a>
                        </td>
                        <td>${store.contact || 'N/A'}</td>
                        <td>
                            ${store.rating ? `
                                <span style="color: #f39c12;">‚òÖ</span> ${store.rating}
                            ` : 'N/A'}
                        </td>
                        <td>${store.orders || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editStore('${store.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStore('${store.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Update stats
            document.getElementById('totalStores').textContent = stores.length;
            document.getElementById('activeStoresThisWeek').textContent = stores.filter(s => (s.orders || 0) > 0).length;
            const avgRating = stores.reduce((sum, s) => sum + (s.rating || 0), 0) / (stores.length || 1);
            document.getElementById('avgStoreRating').textContent = avgRating.toFixed(1);
            document.getElementById('totalStoreOrders').textContent = stores.reduce((sum, s) => sum + (s.orders || 0), 0);
        }

        function openAddStoreModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>‚ûï Add Parts Store</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Store Name *</label>
                            <input type="text" id="storeName" placeholder="e.g., AutoZone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type</label>
                            <select id="storeType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="Auto Parts">Auto Parts</option>
                                <option value="Dealership">Dealership</option>
                                <option value="Salvage Yard">Salvage Yard</option>
                                <option value="Specialty">Specialty</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">City *</label>
                                <input type="text" id="storeCity" placeholder="e.g., Palo Alto" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">State *</label>
                                <select id="storeState" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="">Select State</option>
                                    <option value="CA" selected>California</option>
                                    <option value="TX">Texas</option>
                                    <option value="FL">Florida</option>
                                    <option value="NY">New York</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Phone</label>
                                <input type="tel" id="storePhone" placeholder="(555) 123-4567" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Distance (miles)</label>
                                <input type="number" id="storeDistance" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Contact Person</label>
                            <input type="text" id="storeContact" placeholder="e.g., John Smith" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Rating (1-5)</label>
                            <input type="number" id="storeRating" min="1" max="5" step="0.1" placeholder="5.0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="saveStore()">‚ûï Save Store</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveStore() {
            const name = document.getElementById('storeName').value.trim();
            const type = document.getElementById('storeType').value;
            const city = document.getElementById('storeCity').value.trim();
            const state = document.getElementById('storeState').value;
            const phone = document.getElementById('storePhone').value.trim();
            const distance = document.getElementById('storeDistance').value;
            const contact = document.getElementById('storeContact').value.trim();
            const rating = document.getElementById('storeRating').value;

            if (!name || !city || !state) {
                alert('Please fill in required fields');
                return;
            }

            const stores = JSON.parse(localStorage.getItem('partsStores') || '[]');
            const store = {
                id: Date.now().toString(),
                name,
                type,
                city,
                state,
                phone,
                distance: distance || 0,
                contact,
                rating: rating || 0,
                orders: 0,
                createdAt: new Date().toISOString()
            };

            stores.push(store);
            localStorage.setItem('partsStores', JSON.stringify(stores));

            alert('‚úÖ Store added successfully!');
            document.querySelector('.modal').remove();
            loadPartsStores();
        }

        function editStore(storeId) {
            const stores = JSON.parse(localStorage.getItem('partsStores') || '[]');
            const store = stores.find(s => s.id === storeId);
            
            if (!store) {
                alert('Store not found');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content alex-modal">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Edit Store: ${store.name}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Store Name *</label>
                            <input type="text" id="editStoreName" value="${store.name}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type</label>
                            <select id="editStoreType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="Auto Parts" ${store.type === 'Auto Parts' ? 'selected' : ''}>Auto Parts</option>
                                <option value="Dealership" ${store.type === 'Dealership' ? 'selected' : ''}>Dealership</option>
                                <option value="Salvage Yard" ${store.type === 'Salvage Yard' ? 'selected' : ''}>Salvage Yard</option>
                                <option value="Specialty" ${store.type === 'Specialty' ? 'selected' : ''}>Specialty</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">City *</label>
                                <input type="text" id="editStoreCity" value="${store.city}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">State *</label>
                                <select id="editStoreState" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="CA" ${store.state === 'CA' ? 'selected' : ''}>California</option>
                                    <option value="TX" ${store.state === 'TX' ? 'selected' : ''}>Texas</option>
                                    <option value="FL" ${store.state === 'FL' ? 'selected' : ''}>Florida</option>
                                    <option value="NY" ${store.state === 'NY' ? 'selected' : ''}>New York</option>
                                    <option value="Other" ${store.state === 'Other' || !['CA','TX','FL','NY'].includes(store.state) ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Phone</label>
                                <input type="tel" id="editStorePhone" value="${store.phone || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Distance (miles)</label>
                                <input type="number" id="editStoreDistance" value="${store.distance || 0}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Contact Person</label>
                            <input type="text" id="editStoreContact" value="${store.contact || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Rating (1-5)</label>
                            <input type="number" id="editStoreRating" min="1" max="5" step="0.1" value="${store.rating || 0}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button class="btn btn-primary" style="width: 100%;" onclick="updateStore('${store.id}')">üíæ Update Store</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateStore(storeId) {
            const stores = JSON.parse(localStorage.getItem('partsStores') || '[]');
            const index = stores.findIndex(s => s.id === storeId);
            
            if (index === -1) {
                alert('Store not found');
                return;
            }

            stores[index] = {
                ...stores[index],
                name: document.getElementById('editStoreName').value.trim(),
                type: document.getElementById('editStoreType').value,
                city: document.getElementById('editStoreCity').value.trim(),
                state: document.getElementById('editStoreState').value,
                phone: document.getElementById('editStorePhone').value.trim(),
                distance: document.getElementById('editStoreDistance').value,
                contact: document.getElementById('editStoreContact').value.trim(),
                rating: document.getElementById('editStoreRating').value,
                updatedAt: new Date().toISOString()
            };

            localStorage.setItem('partsStores', JSON.stringify(stores));

            alert('‚úÖ Store updated successfully!');
            document.querySelector('.modal').remove();
            loadPartsStores();
        }

        function deleteStore(storeId) {
            if (!confirm('Are you sure you want to delete this store?')) return;

            let stores = JSON.parse(localStorage.getItem('partsStores') || '[]');
            stores = stores.filter(s => s.id !== storeId);
            localStorage.setItem('partsStores', JSON.stringify(stores));

            alert('‚úÖ Store deleted successfully!');
            loadPartsStores();
        }

        function filterStores() {
            const searchTerm = document.getElementById('searchStores').value.toLowerCase();
            const rows = document.querySelectorAll('#storesTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // ==================== ANALYTICS FUNCTIONS ====================

        function loadAnalyticsData() {
            const period = document.getElementById('analyticsPeriod').value;
            
            // Get data from localStorage
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const estimates = JSON.parse(localStorage.getItem('estimates') || '[]');
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');

            // Filter by period
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.setHours(0,0,0,0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                case 'quarter':
                    startDate = new Date(now.setMonth(now.getMonth() - 3));
                    break;
                case 'year':
                    startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    break;
            }

            const filteredInvoices = invoices.filter(inv => new Date(inv.date) >= startDate);
            const filteredEstimates = estimates.filter(est => new Date(est.date) >= startDate);
            const filteredAppointments = appointments.filter(apt => new Date(apt.date) >= startDate);

            // Calculate metrics
            const totalRevenue = filteredInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const totalJobs = filteredInvoices.length + filteredEstimates.length;
            const completedAppointments = filteredAppointments.filter(apt => apt.status === 'completed').length;
            
            // Update KPI cards
            document.getElementById('analyticsRevenue').textContent = '$' + totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('analyticsJobs').textContent = totalJobs;
            document.getElementById('analyticsAppointments').textContent = completedAppointments;
            document.getElementById('analyticsRating').textContent = '4.8'; // Mock rating

            // Update change indicators
            const lastPeriodRevenue = totalRevenue * 0.85; // Mock last period
            const revenueChange = ((totalRevenue - lastPeriodRevenue) / lastPeriodRevenue * 100).toFixed(1);
            document.getElementById('revenueChange').textContent = `${revenueChange >= 0 ? '+' : ''}${revenueChange}% vs last period`;
            document.getElementById('revenueChange').style.color = revenueChange >= 0 ? '#2ecc71' : '#e74c3c';

            const lastPeriodJobs = totalJobs * 0.9; // Mock last period
            const jobsChange = ((totalJobs - lastPeriodJobs) / lastPeriodJobs * 100).toFixed(1);
            document.getElementById('jobsChange').textContent = `${jobsChange >= 0 ? '+' : ''}${jobsChange}% vs last period`;
            document.getElementById('jobsChange').style.color = jobsChange >= 0 ? '#2ecc71' : '#e74c3c';

            const lastPeriodAppointments = completedAppointments * 0.85;
            const appointmentsChange = ((completedAppointments - lastPeriodAppointments) / lastPeriodAppointments * 100).toFixed(1);
            document.getElementById('appointmentsChange').textContent = `${appointmentsChange >= 0 ? '+' : ''}${appointmentsChange}% vs last period`;
            document.getElementById('appointmentsChange').style.color = appointmentsChange >= 0 ? '#2ecc71' : '#e74c3c';

            // Render charts
            renderRevenueChart(filteredInvoices);
            renderJobsChart(filteredInvoices);
            renderTopServices(filteredInvoices);
            renderTopParts(filteredInvoices);
            renderTechPerformance(filteredInvoices);
            renderRecentActivity(filteredInvoices, filteredEstimates, filteredAppointments);
        }

        function renderRevenueChart(invoices) {
            const canvas = document.getElementById('revenueCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;

            // Generate data points
            const days = 7;
            const data = [];
            for (let i = 0; i < days; i++) {
                data.push({
                    label: i === 0 ? 'Today' : `${i}d ago`,
                    value: Math.random() * 5000 + 2000
                });
            }

            // Draw simple bar chart
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = chartWidth / data.length - 10;
            const maxValue = Math.max(...data.map(d => d.value));

            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = padding + index * (barWidth + 10);
                const y = canvas.height - padding - barHeight;

                // Draw bar
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw label
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.label, x + barWidth / 2, canvas.height - 10);

                // Draw value
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.fillText('$' + Math.floor(item.value), x + barWidth / 2, y - 5);
            });

            // Draw axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
        }

        function renderJobsChart(invoices) {
            const canvas = document.getElementById('jobsCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;

            // Mock service types data
            const data = [
                { label: 'Brakes', value: 35, color: '#667eea' },
                { label: 'Oil Change', value: 25, color: '#f093fb' },
                { label: 'Engine', value: 20, color: '#4facfe' },
                { label: 'Suspension', value: 12, color: '#43e97b' },
                { label: 'Other', value: 8, color: '#f5576c' }
            ];

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 60;

            let startAngle = 0;
            data.forEach(item => {
                const sliceAngle = (item.value / 100) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();

                // Draw label
                const labelAngle = startAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = labelX > centerX ? 'left' : 'right';
                ctx.fillText(`${item.label} (${item.value}%)`, labelX, labelY);

                startAngle += sliceAngle;
            });

            // Draw legend
            const legendX = 10;
            const legendY = canvas.height - 20;
            data.forEach((item, index) => {
                ctx.fillStyle = item.color;
                ctx.fillRect(legendX + index * 60, legendY, 15, 15);
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(item.label, legendX + index * 60 + 20, legendY + 12);
            });
        }

        function renderTopServices(invoices) {
            const services = {};
            invoices.forEach(inv => {
                inv.lineItems.forEach(item => {
                    const service = item.description.split(' - ')[0];
                    services[service] = (services[service] || 0) + 1;
                });
            });

            const sorted = Object.entries(services)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('topServices');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No data yet</p>';
            } else {
                const maxCount = sorted[0][1];
                container.innerHTML = sorted.map(([service, count], index) => `
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold;">${index + 1}. ${service}</span>
                            <span>${count} jobs</span>
                        </div>
                        <div style="background: #f0f0f0; border-radius: 5px; height: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${(count / maxCount) * 100}%;"></div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderTopParts(invoices) {
            const parts = {};
            invoices.forEach(inv => {
                inv.lineItems.forEach(item => {
                    if (item.description.includes(' - ') && item.description.match(/^[A-Z0-9]+/)) {
                        const partNumber = item.description.match(/^[A-Z0-9]+/)[0];
                        parts[partNumber] = (parts[partNumber] || 0) + 1;
                    }
                });
            });

            const sorted = Object.entries(parts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const container = document.getElementById('topParts');
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No data yet</p>';
            } else {
                container.innerHTML = sorted.map(([part, count], index) => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee;">
                        <span>${index + 1}. ${part}</span>
                        <span style="font-weight: bold; color: #2ecc71;">${count}x</span>
                    </div>
                `).join('');
            }
        }

        function renderTechPerformance(invoices) {
            // Mock tech performance data
            const techs = [
                { name: 'Tech 1', jobs: 15, rating: 4.8, avgTime: 2.5 },
                { name: 'Tech 2', jobs: 12, rating: 4.9, avgTime: 2.8 },
                { name: 'Tech 3', jobs: 10, rating: 4.7, avgTime: 3.0 }
            ];

            const container = document.getElementById('techPerformance');
            container.innerHTML = techs.map((tech, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 35px; height: 35px; background: ${['#667eea', '#f093fb', '#4facfe'][index]}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${index + 1}
                        </div>
                        <div>
                            <div style="font-weight: bold;">${tech.name}</div>
                            <div style="font-size: 12px; color: #666;">${tech.jobs} jobs</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #f39c12; font-weight: bold;">‚òÖ ${tech.rating}</div>
                        <div style="font-size: 12px; color: #666;">${tech.avgTime}h avg</div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentActivity(invoices, estimates, appointments) {
            const activities = [];

            // Add invoice activities
            invoices.forEach(inv => {
                activities.push({
                    type: 'Invoice',
                    description: `Created invoice for ${inv.customerName}`,
                    date: inv.date,
                    amount: inv.total
                });
            });

            // Add estimate activities
            estimates.forEach(est => {
                activities.push({
                    type: 'Estimate',
                    description: `Created estimate for ${est.customerName}`,
                    date: est.date,
                    amount: est.total
                });
            });

            // Add appointment activities
            appointments.forEach(apt => {
                activities.push({
                    type: 'Appointment',
                    description: `${apt.status.charAt(0).toUpperCase() + apt.status.slice(1)}: ${apt.customerName}`,
                    date: apt.date
                });
            });

            // Sort by date and get recent
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recent = activities.slice(0, 10);

            const container = document.getElementById('analyticsRecentActivity');
            if (recent.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No activity yet</p>';
            } else {
                container.innerHTML = recent.map(activity => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${activity.type === 'Invoice' ? '#2ecc71' : activity.type === 'Estimate' ? '#3498db' : '#f39c12'};"></div>
                            <div>
                                <div style="font-weight: bold;">${activity.type}</div>
                                <div style="font-size: 12px; color: #666;">${activity.description}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            ${activity.amount ? `<div style="font-weight: bold;">$${activity.amount.toFixed(2)}</div>` : ''}
                            <div style="font-size: 12px; color: #666;">${new Date(activity.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
    </script>
</body>
</html>
