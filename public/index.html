<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHICL Pro - Auto Shop Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .navbar {
            background: #0a2540;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-brand i {
            color: #00d4ff;
        }

        .nav-links {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0a2540;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card.revenue {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-label {
            opacity: 0.9;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #00d4ff;
            color: #0a2540;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #00a8cc;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #43e97b;
            color: white;
        }

        .btn-danger {
            background: #f5576c;
            color: white;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #0a2540;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #0a2540;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #0a2540;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .inventory-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .inventory-item-name {
            font-weight: bold;
            color: #0a2540;
            margin-bottom: 0.5rem;
        }

        .inventory-item-details {
            font-size: 0.9rem;
            color: #666;
        }

        .inventory-item-value {
            font-weight: bold;
            color: #43e97b;
            margin-top: 0.5rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .api-status {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }

        .api-status.connected {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-status.disconnected {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-status .status-icon {
            margin-right: 0.5rem;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-car"></i>
            VHICL Pro
        </div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="showScreen('dashboard')">üè† Dashboard</button>
            <button class="nav-btn" onclick="showScreen('customers')">üë• Customers</button>
            <button class="nav-btn" onclick="showScreen('appointments')">üìÖ Appointments</button>
            <button class="nav-btn" onclick="showScreen('maintenance')">üîß Maintenance</button>
            <button class="nav-btn" onclick="showScreen('techflow')">üî¨ TechFlow</button>
            <button class="nav-btn" onclick="window.open('tech-management.html', '_blank')">üë∑ Tech Mgmt</button>
            <button class="nav-btn" onclick="window.open('vehicle-dropoff-manager.html', '_blank')">üöó Drop-offs</button>
            <button class="nav-btn" onclick="showScreen('estimates')">üìã Estimates</button>
            <button class="nav-btn" onclick="showScreen('invoices')">üí∞ Invoices</button>
            <button class="nav-btn" onclick="showScreen('towing')">üöó Towing</button>
            <button class="nav-btn" onclick="showScreen('inventory')">üì¶ Inventory</button>
            <button class="nav-btn" onclick="showScreen('vapi')">üìû VAPI</button>
            <button class="nav-btn" onclick="showScreen('analytics')">üìä Analytics</button>
            <button class="nav-btn" onclick="showScreen('settings')">‚öôÔ∏è Settings</button>
            <div id="apiIndicator" style="display: none; align-items: center; gap: 5px; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                <i class="fas fa-circle"></i> <span id="apiIndicatorText">API</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Dashboard Screen -->
        <div id="dashboard" class="screen active">
            <h1 style="color: white; margin-bottom: 1.5rem;">üè† Dashboard</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Revenue</div>
                    <div class="stat-value">$1,234</div>
                    <div class="stat-label"><i class="fas fa-arrow-up"></i> +12% from yesterday</div>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value">8</div>
                    <div class="stat-label"><i class="fas fa-check"></i> 6 completed</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Appointments</div>
                    <div class="stat-value">5</div>
                    <div class="stat-label"><i class="fas fa-clock"></i> 2 today</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Pending Estimates</div>
                    <div class="stat-value">3</div>
                    <div class="stat-label"><i class="fas fa-file-alt"></i> awaiting approval</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="showScreen('appointments')">
                        <i class="fas fa-calendar-plus"></i> New Appointment
                    </button>
                    <button class="btn btn-primary" onclick="showScreen('customers')">
                        <i class="fas fa-user-plus"></i> Add Customer
                    </button>
                    <button class="btn btn-primary" onclick="showScreen('estimates')">
                        <i class="fas fa-file-invoice"></i> Create Estimate
                    </button>
                    <button class="btn btn-primary" onclick="showScreen('towing')">
                        <i class="fas fa-truck"></i> Request Tow
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Activity</h2>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>10:30 AM</td>
                            <td>Oil Change - John Smith</td>
                            <td><span class="status-badge status-completed">Completed</span></td>
                        </tr>
                        <tr>
                            <td>9:15 AM</td>
                            <td>Brake Repair - Jane Doe</td>
                            <td><span class="status-badge status-pending">In Progress</span></td>
                        </tr>
                        <tr>
                            <td>8:00 AM</td>
                            <td>New Appointment - Bob Wilson</td>
                            <td><span class="status-badge status-approved">Scheduled</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customers Screen -->
        <div id="customers" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üë• Customers & Vehicles</h1>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Customer List</h2>
                    <button class="btn btn-primary" onclick="openCustomerModal()">
                        <i class="fas fa-plus"></i> Add Customer
                    </button>
                </div>
                <div id="customerList" class="loading">Loading customers...</div>
            </div>
        </div>

        <!-- Appointments Screen -->
        <div id="appointments" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üìÖ Appointments</h1>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Appointment Calendar</h2>
                    <button class="btn btn-primary" onclick="openAppointmentModal()">
                        <i class="fas fa-plus"></i> New Appointment
                    </button>
                </div>
                <div id="appointmentList" class="loading">Loading appointments...</div>
            </div>
        </div>

        <!-- Estimates Screen -->
        <div id="estimates" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üìã Estimates</h1>
            
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">‚ö†Ô∏è Pending Shop Approval</h2>
                    <small style="color: #666;">These estimates need shop review before Alex calls customer</small>
                </div>
                <div id="pendingApprovalList" class="loading">Loading pending estimates...</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Estimate List</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openEstimateModal()">
                            <i class="fas fa-plus"></i> New Estimate
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="openAlexModal()">
                            <i class="fas fa-robot"></i> Generate with ALEX AI
                        </button>
                    </div>
                </div>
                <div id="estimateList" class="loading">Loading estimates...</div>
            </div>
        </div>

        <!-- Invoices Screen -->
        <div id="invoices" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üí∞ Invoices</h1>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Invoice List</h2>
                    <button class="btn btn-primary" onclick="openInvoiceModal()">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
                <div id="invoiceList" class="loading">Loading invoices...</div>
            </div>
        </div>

        <!-- Towing Screen -->
        <div id="towing" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üöó Towing</h1>
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-label">Pending Requests</div>
                    <div class="stat-value" id="pendingTowing">2</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Assigned</div>
                    <div class="stat-value" id="assignedTowing">1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Arrived</div>
                    <div class="stat-value" id="arrivedTowing">0</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Towing Requests</h2>
                    <button class="btn btn-primary" onclick="openTowingModal()">
                        <i class="fas fa-plus"></i> New Request
                    </button>
                </div>
                <div id="towingList" class="loading">Loading towing requests...</div>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üì¶ Inventory Management</h1>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value" id="totalInventoryItems">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Current Value</div>
                    <div class="stat-value" id="inventoryValue">$0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Low Stock Items</div>
                    <div class="stat-value" id="lowStockItems">0</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Parts Inventory</h2>
                    <button class="btn btn-primary" onclick="openInventoryModal()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                <div id="inventoryList" class="loading">Loading inventory...</div>
            </div>
        </div>

        <!-- Analytics Screen -->
        <div id="analytics" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üìä Analytics Dashboard</h1>
            <div class="stats-grid">
                <div class="stat-card revenue">
                    <div class="stat-label">Revenue This Month</div>
                    <div class="stat-value">$15,234</div>
                    <div class="stat-label"><i class="fas fa-arrow-up"></i> +8% from last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Jobs</div>
                    <div class="stat-value">45</div>
                    <div class="stat-label"><i class="fas fa-wrench"></i> This month</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Average Job Value</div>
                    <div class="stat-value">$338</div>
                    <div class="stat-label"><i class="fas fa-chart-line"></i> +12% from last month</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Total Customers</div>
                    <div class="stat-value">128</div>
                    <div class="stat-label"><i class="fas fa-users"></i> Active accounts</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Revenue by Service Type</h2>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div style="flex: 1; min-width: 200px; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-weight: bold; color: #0a2540;">Brake Service</div>
                        <div style="font-size: 1.5rem; color: #00d4ff;">$4,200</div>
                        <div style="font-size: 0.8rem; color: #666;">28% of revenue</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-weight: bold; color: #0a2540;">Oil Changes</div>
                        <div style="font-size: 1.5rem; color: #00d4ff;">$2,100</div>
                        <div style="font-size: 0.8rem; color: #666;">14% of revenue</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-weight: bold; color: #0a2540;">Suspension Work</div>
                        <div style="font-size: 1.5rem; color: #00d4ff;">$3,400</div>
                        <div style="font-size: 0.8rem; color: #666;">22% of revenue</div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                        <div style="font-weight: bold; color: #0a2540;">Engine Repairs</div>
                        <div style="font-size: 1.5rem; color: #00d4ff;">$5,534</div>
                        <div style="font-size: 0.8rem; color: #666;">36% of revenue</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Top Technicians</h2>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Technician</th>
                            <th>Jobs Completed</th>
                            <th>Revenue Generated</th>
                            <th>Average Job Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Mike Johnson</td>
                            <td>15</td>
                            <td>$5,200</td>
                            <td>2.3 hours</td>
                        </tr>
                        <tr>
                            <td>Sarah Williams</td>
                            <td>12</td>
                            <td>$4,100</td>
                            <td>2.1 hours</td>
                        </tr>
                        <tr>
                            <td>Tom Davis</td>
                            <td>18</td>
                            <td>$5,934</td>
                            <td>2.5 hours</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Maintenance Screen -->
        <div id="maintenance" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üîß Maintenance Listings</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Active Vehicles</div>
                    <div class="stat-value">8</div>
                    <div class="stat-label"><i class="fas fa-car"></i> In the shop</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Completed Today</div>
                    <div class="stat-value">3</div>
                    <div class="stat-label"><i class="fas fa-check"></i> Ready for pickup</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">2</div>
                    <div class="stat-label"><i class="fas fa-clock"></i> Waiting for parts</div>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-label">Revenue Today</div>
                    <div class="stat-value">$1,234</div>
                    <div class="stat-label"><i class="fas fa-dollar-sign"></i> From maintenance</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Active Maintenance Jobs</h2>
                    <button class="btn btn-primary" onclick="openMaintenanceModal()">
                        <i class="fas fa-plus"></i> Add Vehicle
                    </button>
                </div>
                <div id="maintenanceList" class="loading">Loading maintenance jobs...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Maintenance History</h2>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Service</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="maintenanceHistory">
                        <tr>
                            <td>2025-01-15</td>
                            <td>2018 Honda Accord</td>
                            <td>Brake Service</td>
                            <td>$345</td>
                            <td><span class="status-badge status-paid">Completed</span></td>
                        </tr>
                        <tr>
                            <td>2025-01-14</td>
                            <td>2020 Toyota Camry</td>
                            <td>Oil Change</td>
                            <td>$65</td>
                            <td><span class="status-badge status-paid">Completed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TechFlow Screen -->
        <div id="techflow" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üî¨ TechFlow - Technician Workboard</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Active Jobs</div>
                    <div class="stat-value">5</div>
                    <div class="stat-label"><i class="fas fa-wrench"></i> In progress</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Completed Today</div>
                    <div class="stat-value">3</div>
                    <div class="stat-label"><i class="fas fa-check"></i> Ready for review</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Bay Utilization</div>
                    <div class="stat-value">83%</div>
                    <div class="stat-label"><i class="fas fa-car"></i> 5 of 6 bays occupied</div>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-label">Tech Hours Today</div>
                    <div class="stat-value">24.5</div>
                    <div class="stat-label"><i class="fas fa-clock"></i> Hours logged</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Bay Balancing</h2>
                    <button class="btn btn-primary" onclick="autoBalanceBays()">
                        <i class="fas fa-balance-scale"></i> Auto-Balance Bays
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #d4edda; border-radius: 8px; text-align: center;">
                        <h3>Bay 1</h3>
                        <p>2018 Honda Accord</p>
                        <p>Brake Service - 2.5 hrs</p>
                        <span class="status-badge status-approved">Optimal</span>
                    </div>
                    <div style="padding: 1rem; background: #d4edda; border-radius: 8px; text-align: center;">
                        <h3>Bay 2</h3>
                        <p>2020 Toyota Camry</p>
                        <p>Oil Change - 0.5 hrs</p>
                        <span class="status-badge status-approved">Optimal</span>
                    </div>
                    <div style="padding: 1rem; background: #fff3cd; border-radius: 8px; text-align: center;">
                        <h3>Bay 3</h3>
                        <p>2019 Ford F-150</p>
                        <p>Transmission - 6.0 hrs</p>
                        <span class="status-badge status-scheduled">Heavy Load</span>
                    </div>
                    <div style="padding: 1rem; background: #d4edda; border-radius: 8px; text-align: center;">
                        <h3>Bay 4</h3>
                        <p>2021 Nissan Altima</p>
                        <p>A/C Service - 1.5 hrs</p>
                        <span class="status-badge status-approved">Optimal</span>
                    </div>
                    <div style="padding: 1rem; background: #fff3cd; border-radius: 8px; text-align: center;">
                        <h3>Bay 5</h3>
                        <p>2017 Chevy Silverado</p>
                        <p>Engine Rebuild - 8.0 hrs</p>
                        <span class="status-badge status-scheduled">Heavy Load</span>
                    </div>
                    <div style="padding: 1rem; background: #f8d7da; border-radius: 8px; text-align: center;">
                        <h3>Bay 6</h3>
                        <p>Available</p>
                        <p>Ready for assignment</p>
                        <span class="status-badge status-pending">Empty</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Technician Work Queue</h2>
                </div>
                <div id="techWorkQueue">
                    <div class="card" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>2018 Honda Accord</h3>
                                <p style="color: #666;">Mike Johnson | Bay 1</p>
                                <p style="color: #666;">Brake Service - 2.5 hrs</p>
                            </div>
                            <div>
                                <span class="status-badge status-in-progress">In Progress</span>
                                <button class="btn btn-success" onclick="completeJob(1)">Complete</button>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>2020 Toyota Camry</h3>
                                <p style="color: #666;">Sarah Williams | Bay 2</p>
                                <p style="color: #666;">Oil Change - 0.5 hrs</p>
                            </div>
                            <div>
                                <span class="status-badge status-in-progress">In Progress</span>
                                <button class="btn btn-success" onclick="completeJob(2)">Complete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAPI Screen -->
        <div id="vapi" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">üìû VAPI Phone System</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Calls Today</div>
                    <div class="stat-value">12</div>
                    <div class="stat-label"><i class="fas fa-phone"></i> Total calls</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Connected</div>
                    <div class="stat-value">10</div>
                    <div class="stat-label"><i class="fas fa-check"></i> Successful</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Avg Duration</div>
                    <div class="stat-value">3:45</div>
                    <div class="stat-label"><i class="fas fa-clock"></i> Minutes</div>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-label">Cost This Month</div>
                    <div class="stat-value">$45.20</div>
                    <div class="stat-label"><i class="fas fa-dollar-sign"></i> Phone costs</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üé§ VAPI Scripts</h2>
                    <button class="btn btn-primary" onclick="openVapiScriptModal()">
                        <i class="fas fa-plus"></i> New Script
                    </button>
                </div>
                <div id="vapiScriptsList" class="loading">Loading scripts...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìû Quick Call Actions</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="makeVapiCall('parts')">
                        <i class="fas fa-box"></i> Call Parts Store
                    </button>
                    <button class="btn btn-primary" onclick="makeVapiCall('customer')">
                        <i class="fas fa-user"></i> Call Customer
                    </button>
                    <button class="btn btn-primary" onclick="makeVapiCall('tow')">
                        <i class="fas fa-truck"></i> Call Tow Provider
                    </button>
                    <button class="btn btn-success" onclick="sendInvoiceEmail()">
                        <i class="fas fa-envelope"></i> Email Invoice
                    </button>
                    <button class="btn btn-primary" onclick="makeVapiCall('reminder')">
                        <i class="fas fa-bell"></i> Send Reminder
                    </button>
                    <button class="btn btn-primary" onclick="makeVapiCall('survey')">
                        <i class="fas fa-star"></i> Survey Call
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Call History</h2>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Number</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="callHistory">
                        <tr>
                            <td>10:30 AM</td>
                            <td>Parts Store</td>
                            <td>(555) 123-4567</td>
                            <td>2:15</td>
                            <td><span class="status-badge status-approved">Completed</span></td>
                        </tr>
                        <tr>
                            <td>9:45 AM</td>
                            <td>Customer</td>
                            <td>(555) 987-6543</td>
                            <td>1:30</td>
                            <td><span class="status-badge status-approved">Completed</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settings" class="screen">
            <h1 style="color: white; margin-bottom: 1.5rem;">‚öôÔ∏è Shop Settings</h1>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Pricing & Markup Settings</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label>Labor Rate ($/hour)</label>
                        <input type="number" id="laborRate" value="100" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Diagnostic Fee ($)</label>
                        <input type="number" id="diagnosticFee" value="85" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Environmental Fee ($)</label>
                        <input type="number" id="envFee" value="15" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Parts Markup (%)</label>
                        <input type="number" id="partsMarkup" value="30" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>Sales Tax (%)</label>
                        <input type="number" id="salesTax" value="7" min="0" max="15" step="0.1">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="usePartsMatrix">
                        Use Parts Markup Matrix
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>

            <div class="card" id="partsMatrixCard" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">Parts Markup Matrix</h2>
                </div>
                <p style="color: #666; margin-bottom: 1rem;">Configure different markup percentages based on part price ranges:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label>Under $50</label>
                        <input type="number" id="markup50" value="50" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>$50 - $100</label>
                        <input type="number" id="markup100" value="40" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>$100 - $500</label>
                        <input type="number" id="markup500" value="30" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>$500 - $1000</label>
                        <input type="number" id="markup1000" value="25" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>Over $1000</label>
                        <input type="number" id="markupOver1000" value="20" min="0" max="100" step="1">
                    </div>
                </div>
            </div>

            <!-- VAPI Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìû VAPI Configuration</h2>
                    <span class="status-badge" id="vapiBadge" style="background: #f8d7da; color: #721c24;">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>VAPI API Key</label>
                    <input type="password" id="vapiApiKey" placeholder="Enter your VAPI API key">
                    <small style="color: #666;">Your VAPI authentication key</small>
                </div>
                <div class="form-group">
                    <label>VAPI Phone Number</label>
                    <input type="tel" id="vapiPhoneNumber" placeholder="+1 (555) 123-4567">
                    <small style="color: #666;">The phone number VAPI uses to make calls</small>
                </div>
                <div class="form-group">
                    <label>Default Voice</label>
                    <select id="vapiVoice">
                        <option value="alex" selected>Alex (AI Assistant)</option>
                        <option value="rachel">Rachel (Female)</option>
                        <option value="drew">Drew (Male)</option>
                        <option value="cleo">Cleo (Female)</option>
                        <option value="adam">Adam (Male)</option>
                        <option value="emily">Emily (Female)</option>
                        <option value="callum">Callum (Male)</option>
                        <option value="jess">Jess (Female)</option>
                        <option value="joseph">Joseph (Male)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="vapiEnabled">
                        <strong>Enable VAPI Phone Integration</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Enable automated phone calls for parts ordering, customer notifications, etc.
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="vapiRecordCalls" checked>
                        <strong>Record Calls</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Record all VAPI calls for quality assurance
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveVapiSettings()">
                        <i class="fas fa-save"></i> Save VAPI Settings
                    </button>
                    <button class="btn btn-success" onclick="testVapiConnection()">
                        <i class="fas fa-phone"></i> Test Call
                    </button>
                </div>
            </div>

            <!-- Shop Services & Parts Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîß Shop Services & Local Parts</h2>
                </div>
                
                <div class="form-group">
                    <label>Services Not Performed (one per line)</label>
                    <textarea id="servicesNotPerformed" rows="6" placeholder="Engine rebuild&#10;Transmission rebuild&#10;Body work&#10;Painting&#10;Glass replacement"></textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        List services your shop does NOT perform. These will be excluded from ALEX estimates and recommendations.
                    </small>
                </div>

                <div class="form-group">
                    <label>Local Parts Numbers Reference</label>
                    <textarea id="localPartsNumbers" rows="8" placeholder="Part Name | OEM Number | Local Part Number | Supplier&#10;Brake Pads (Front) | 45022-SE0-A01 | BP-001-F | AutoZone&#10;Oil Filter | 15400-PLM-A01 | OF-005 | O'Reilly&#10;Air Filter | 17220-5VA-A01 | AF-012 | NAPA"></textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Map OEM part numbers to your local supplier's part numbers. Format: Part Name | OEM Number | Local Part Number | Supplier
                    </small>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveShopServicesSettings()">
                        <i class="fas fa-save"></i> Save Services & Parts
                    </button>
                </div>
            </div>

            <!-- Twilio Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üì± Twilio Configuration</h2>
                    <span class="status-badge" id="twilioBadge" style="background: #f8d7da; color: #721c24;">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>Account SID</label>
                    <input type="text" id="twilioAccountSid" placeholder="ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                    <small style="color: #666;">Your Twilio Account SID</small>
                </div>
                <div class="form-group">
                    <label>Auth Token</label>
                    <input type="password" id="twilioAuthToken" placeholder="Your Twilio Auth Token">
                    <small style="color: #666;">Your Twilio authentication token</small>
                </div>
                <div class="form-group">
                    <label>Twilio Phone Number</label>
                    <input type="tel" id="twilioPhoneNumber" placeholder="+1 (555) 123-4567">
                    <small style="color: #666;">Your Twilio phone number for SMS</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="twilioEnabled">
                        <strong>Enable Twilio SMS Integration</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Send SMS notifications for appointments, reminders, and updates
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="twilioAutoReminders" checked>
                        <strong>Send Automatic Appointment Reminders</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Automatically send SMS reminders 24 hours before appointments
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveTwilioSettings()">
                        <i class="fas fa-save"></i> Save Twilio Settings
                    </button>
                    <button class="btn btn-success" onclick="testTwilioSMS()">
                        <i class="fas fa-sms"></i> Test SMS
                    </button>
                </div>
            </div>

            <!-- PayPal Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üí≥ PayPal Configuration</h2>
                    <span class="status-badge" id="paypalBadge" style="background: #f8d7da; color: #721c24;">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="paypalClientId" placeholder="Your PayPal Client ID">
                    <small style="color: #666;">Your PayPal REST API Client ID</small>
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <input type="password" id="paypalClientSecret" placeholder="Your PayPal Client Secret">
                    <small style="color: #666;">Your PayPal REST API Client Secret</small>
                </div>
                <div class="form-group">
                    <label>Environment</label>
                    <select id="paypalEnvironment">
                        <option value="sandbox">Sandbox (Testing)</option>
                        <option value="live">Live (Production)</option>
                    </select>
                    <small style="color: #666;">Use Sandbox for testing, Live for real payments</small>
                </div>
                <div class="form-group">
                    <label>PayPal Email</label>
                    <input type="email" id="paypalEmail" placeholder="payments@yourshop.com">
                    <small style="color: #666;">Email address for receiving PayPal payments</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="paypalEnabled">
                        <strong>Enable PayPal Payments</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Allow customers to pay invoices via PayPal
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="paypalAlexBilling" checked>
                        <strong>ALEX Auto-Billing</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        ALEX will automatically email invoices with PayPal payment links
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="savePaypalSettings()">
                        <i class="fas fa-save"></i> Save PayPal Settings
                    </button>
                    <button class="btn btn-success" onclick="testPaypalConnection()">
                        <i class="fas fa-credit-card"></i> Test Connection
                    </button>
                </div>
            </div>

            <!-- SendGrid Configuration -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìß SendGrid Configuration</h2>
                    <span class="status-badge" id="sendgridBadge" style="background: #f8d7da; color: #721c24;">Disconnected</span>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="sendgridApiKey" placeholder="SG.xxxxxxxxxxxxxx">
                    <small style="color: #666;">Your SendGrid API key</small>
                </div>
                <div class="form-group">
                    <label>From Email</label>
                    <input type="email" id="sendgridFromEmail" placeholder="noreply@yourshop.com">
                    <small style="color: #666;">Email address that sends emails</small>
                </div>
                <div class="form-group">
                    <label>From Name</label>
                    <input type="text" id="sendgridFromName" placeholder="VHICL Pro Auto Shop">
                    <small style="color: #666;">Display name for sent emails</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sendgridEnabled">
                        <strong>Enable SendGrid Email</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        Send invoices, estimates, and notifications via email
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sendgridAlexEmail" checked>
                        <strong>ALEX Email Invoices</strong>
                    </label>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">
                        ALEX will automatically email completed invoices with PayPal links
                    </small>
                </div>
                <div class="form-group">
                    <label>Email Template</label>
                    <select id="sendgridTemplate">
                        <option value="default">Default Template</option>
                        <option value="professional">Professional</option>
                        <option value="friendly">Friendly</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveSendgridSettings()">
                        <i class="fas fa-save"></i> Save SendGrid Settings
                    </button>
                    <button class="btn btn-success" onclick="testSendgridEmail()">
                        <i class="fas fa-envelope"></i> Test Email
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Shop Information</h2>
                </div>
                <div class="form-group">
                    <label>Shop Name</label>
                    <input type="text" id="shopName" value="VHICL Pro Auto Shop">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="shopPhone" value="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="shopEmail" value="info@vhiclpro.com">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="shopAddress" value="123 Main St, Anytown, USA">
                </div>
            </div>
        </div>
    </div>

    <!-- ALEX Estimate Result Modal -->
    <div id="alexEstimateModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> ALEX AI Estimate</h2>
                <button class="close-btn" onclick="closeModal('alexEstimateModal')">&times;</button>
            </div>
            <div id="alexEstimateContent"></div>
        </div>
    </div>

    <!-- ALEX Input Modal -->
    <div id="alexInputModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> Generate ALEX Estimate</h2>
                <button class="close-btn" onclick="closeModal('alexInputModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Vehicle Information</label>
                <input type="text" id="alexVehicle" placeholder="e.g., 2018 Honda Accord">
            </div>
            <div class="form-group">
                <label>VIN (Optional)</label>
                <input type="text" id="alexVin" placeholder="Enter VIN for accurate results">
            </div>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="alexCustomer" placeholder="Customer name">
            </div>
            <div class="form-group">
                <label>Services Needed</label>
                <input type="text" id="alexServices" placeholder="e.g., oil-change, brake-pads, alignment">
                <small style="color: #666;">Separate with commas or select a template below</small>
            </div>
            <div style="margin: 1rem 0;">
                <h4 style="color: #0a2540; margin-bottom: 0.5rem;">Quick Templates</h4>
                <div id="alexTemplates" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="generateAlexEstimate()">
                <i class="fas fa-magic"></i> Generate with ALEX AI
            </button>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Maintenance Job</h2>
                <button class="close-btn" onclick="closeModal('maintenanceModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="maintenanceCustomer" placeholder="Customer name">
            </div>
            <div class="form-group">
                <label>Vehicle</label>
                <input type="text" id="maintenanceVehicle" placeholder="e.g., 2018 Honda Accord">
            </div>
            <div class="form-group">
                <label>VIN</label>
                <input type="text" id="maintenanceVin" placeholder="17-digit VIN">
            </div>
            <div class="form-group">
                <label>Service Type</label>
                <select id="maintenanceService">
                    <option value="Oil Change">Oil Change</option>
                    <option value="Brake Service">Brake Service</option>
                    <option value="Suspension Work">Suspension Work</option>
                    <option value="Engine Repair">Engine Repair</option>
                    <option value="Transmission">Transmission</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="maintenancePriority">
                    <option value="Normal">Normal</option>
                    <option value="High">High</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bay Assignment</label>
                <select id="maintenanceBay">
                    <option value="Bay 1">Bay 1</option>
                    <option value="Bay 2">Bay 2</option>
                    <option value="Bay 3">Bay 3</option>
                    <option value="Bay 4">Bay 4</option>
                </select>
            </div>
            <div class="form-group">
                <label>Technician</label>
                <select id="maintenanceTechnician">
                    <option value="Mike Johnson">Mike Johnson</option>
                    <option value="Sarah Williams">Sarah Williams</option>
                    <option value="Tom Davis">Tom Davis</option>
                    <option value="Unassigned">Unassigned</option>
                </select>
            </div>
            <div class="form-group">
                <label>Estimated Cost ($)</label>
                <input type="number" id="maintenanceCost" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="maintenanceNotes" rows="3" placeholder="Any special instructions or notes..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveMaintenanceJob()">Add Job</button>
        </div>
    </div>

    <!-- VAPI Script Modal -->
    <div id="vapiScriptModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="vapiScriptModalTitle">Create VAPI Script</h2>
                <button class="close-btn" onclick="closeModal('vapiScriptModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Script Name</label>
                <input type="text" id="vapiScriptName" placeholder="e.g., Parts Store Call">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="vapiScriptDescription" placeholder="What this script is for">
            </div>
            <div class="form-group">
                <label>Voice</label>
                <select id="vapiScriptVoice">
                    <option value="alex">Alex (Male Service Advisor)</option>
                    <option value="rachel">Rachel (Female)</option>
                    <option value="drew">Drew (Male)</option>
                    <option value="cleo">Cleo (Female)</option>
                    <option value="adam">Adam (Male)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Script Text</label>
                <textarea id="vapiScriptText" rows="6" placeholder="Enter the script text here. Use placeholders like [CUSTOMER_NAME], [SHOP_NAME], etc."></textarea>
                <small style="color: #666;">
                    Available placeholders: [SHOP_NAME], [CUSTOMER_NAME], [VEHICLE], [SERVICE], [DATE], [TIME], [AMOUNT], [LOCATION]
                </small>
            </div>
            <button class="btn btn-primary" onclick="saveVapiScript()">Save Script</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Customer</h2>
                <button class="close-btn" onclick="closeModal('customerModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="customerName">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="customerPhone">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="customerEmail">
            </div>
            <div class="form-group">
                <label>Vehicle Year</label>
                <input type="number" id="vehicleYear" min="1990" max="2030">
            </div>
            <div class="form-group">
                <label>Vehicle Make</label>
                <input type="text" id="vehicleMake">
            </div>
            <div class="form-group">
                <label>Vehicle Model</label>
                <input type="text" id="vehicleModel">
            </div>
            <div class="form-group">
                <label>License Plate</label>
                <input type="text" id="licensePlate">
            </div>
            <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
        </div>
    </div>

    <div id="estimateModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Create New Estimate</h2>
                <button class="close-btn" onclick="closeModal('estimateModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Customer</label>
                <select id="estimateCustomerSelect">
                    <option value="">Select Customer</option>
                </select>
            </div>
            <div class="form-group">
                <label>Vehicle</label>
                <input type="text" id="estimateVehicle" placeholder="e.g., 2018 Honda Accord">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="estimateDescription" rows="3" placeholder="Describe the work needed..."></textarea>
            </div>
            
            <h3>Parts</h3>
            <div id="estimatePartsList"></div>
            <button class="btn btn-secondary" onclick="addEstimatePart()">Add Part</button>
            
            <h3 style="margin-top: 1rem;">Labor</h3>
            <div id="estimateLaborList"></div>
            <button class="btn btn-secondary" onclick="addEstimateLabor()">Add Labor</button>
            
            <div style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                <h3>Total: $<span id="estimateTotal">0.00</span></h3>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
                <label>Status</label>
                <select id="estimateStatus">
                    <option value="Draft">Draft</option>
                    <option value="Sent">Sent</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            
            <button class="btn btn-primary" onclick="saveEstimate()">Save Estimate</button>
        </div>
    </div>

    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Appointment</h2>
                <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Customer</label>
                <select id="appointmentCustomer"></select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="appointmentDate">
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="time" id="appointmentTime">
            </div>
            <div class="form-group">
                <label>Service Type</label>
                <select id="serviceType">
                    <option value="Oil Change">Oil Change</option>
                    <option value="Brake Service">Brake Service</option>
                    <option value="Suspension">Suspension</option>
                    <option value="Engine Repair">Engine Repair</option>
                    <option value="Diagnostic">Diagnostic</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="appointmentNotes" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveAppointment()">Schedule Appointment</button>
        </div>
    </div>

    <div id="towingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Towing Request</h2>
                <button class="close-btn" onclick="closeModal('towingModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="towingCustomer">
            </div>
            <div class="form-group">
                <label>Customer Phone</label>
                <input type="tel" id="towingPhone">
            </div>
            <div class="form-group">
                <label>Pickup Location</label>
                <textarea id="towingLocation" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>Vehicle Details</label>
                <input type="text" id="towingVehicle" placeholder="2018 Honda Accord - Red">
            </div>
            <div class="form-group">
                <label>License Plate</label>
                <input type="text" id="towingPlate">
            </div>
            <div class="form-group">
                <label>Destination</label>
                <select id="towingDestination">
                    <option value="shop">Our Shop</option>
                    <option value="other">Other Location</option>
                </select>
            </div>
            <div class="form-group">
                <label>Key Location</label>
                <select id="keyLocation">
                    <option value="with-customer">With Customer</option>
                    <option value="in-vehicle">In Vehicle</option>
                    <option value="drop-box">Drop Box</option>
                </select>
            </div>
            <div class="form-group">
                <label>Customer Will Meet Driver</label>
                <select id="meetDriver">
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveTowingRequest()">Submit Request</button>
        </div>
    </div>

    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Inventory Item</h2>
                <button class="close-btn" onclick="closeModal('inventoryModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Part Name</label>
                <input type="text" id="inventoryName">
            </div>
            <div class="form-group">
                <label>Part Number</label>
                <input type="text" id="inventoryPartNumber">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="inventoryCategory">
                    <option value="Brakes">Brakes</option>
                    <option value="Engine">Engine</option>
                    <option value="Suspension">Suspension</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Fluids">Fluids</option>
                    <option value="Filters">Filters</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="inventoryQuantity" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Cost ($)</label>
                <input type="number" id="inventoryCost" value="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Sell Price ($)</label>
                <input type="number" id="inventoryPrice" value="0" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Reorder Point</label>
                <input type="number" id="inventoryReorderPoint" value="2" min="1">
            </div>
            <button class="btn btn-primary" onclick="saveInventoryItem()">Add Item</button>
        </div>
    </div>

    <script>
        // ============ GLOBAL VARIABLES ============
        let customers = [];
        let appointments = [];
        let estimates = [];
        let invoices = [];
        let towingRequests = [];
        let inventory = [];
        let settings = {};

        // ============ SHOW SCREEN FUNCTION ============
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            event.target.classList.add('active');
        }

        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage
            loadFromStorage();
            
            // Load settings
            loadSettings();
            
            // Initialize sample data if empty
            if (customers.length === 0) initSampleCustomers();
            if (inventory.length === 0) initSampleInventory();
            if (towingRequests.length === 0) initSampleTowing();
            if (estimates.length === 0) initSampleEstimates();
            if (invoices.length === 0) initSampleInvoices();
            if (maintenanceJobs.length === 0) initSampleMaintenance();
            if (vapiScripts.length === 0) initSampleVapiScripts();
            
            // Render all screens
            renderCustomers();
            renderAppointments();
            renderEstimates();
            renderPendingApprovalEstimates();
            renderInvoices();
            renderTowing();
            renderInventory();
            renderMaintenanceList();
            renderMaintenanceHistory();
            renderVapiScripts();
        });

        // ============ STORAGE FUNCTIONS ============
        function loadFromStorage() {
            try {
                customers = JSON.parse(localStorage.getItem('vhicl_customers') || '[]');
                appointments = JSON.parse(localStorage.getItem('vhicl_appointments') || '[]');
                estimates = JSON.parse(localStorage.getItem('vhicl_estimates') || '[]');
                invoices = JSON.parse(localStorage.getItem('vhicl_invoices') || '[]');
                towingRequests = JSON.parse(localStorage.getItem('vhicl_towing') || '[]');
                inventory = JSON.parse(localStorage.getItem('vhicl_inventory') || '[]');
                maintenanceJobs = JSON.parse(localStorage.getItem('vhicl_maintenance') || '[]');
                maintenanceHistory = JSON.parse(localStorage.getItem('vhicl_maintenance_history') || '[]');
                vapiScripts = JSON.parse(localStorage.getItem('vhicl_vapi_scripts') || '[]');
                settings = JSON.parse(localStorage.getItem('vhicl_settings') || '{}');
            } catch (error) {
                console.error('Error loading from storage:', error);
            }
        }

        function saveToStorage() {
            localStorage.setItem('vhicl_customers', JSON.stringify(customers));
            localStorage.setItem('vhicl_appointments', JSON.stringify(appointments));
            localStorage.setItem('vhicl_estimates', JSON.stringify(estimates));
            localStorage.setItem('vhicl_invoices', JSON.stringify(invoices));
            localStorage.setItem('vhicl_towing', JSON.stringify(towingRequests));
            localStorage.setItem('vhicl_inventory', JSON.stringify(inventory));
            localStorage.setItem('vhicl_maintenance', JSON.stringify(maintenanceJobs));
            localStorage.setItem('vhicl_maintenance_history', JSON.stringify(maintenanceHistory));
            localStorage.setItem('vhicl_vapi_scripts', JSON.stringify(vapiScripts));
        }

        // ============ SETTINGS FUNCTIONS ============
        function loadSettings() {
            // Load from localStorage or use defaults
            const savedSettings = JSON.parse(localStorage.getItem('vhicl_settings') || '{}');
            
            settings = {
                laborRate: savedSettings.laborRate || 100,
                diagnosticFee: savedSettings.diagnosticFee || 85,
                envFee: savedSettings.envFee || 15,
                partsMarkup: savedSettings.partsMarkup || 30,
                salesTax: savedSettings.salesTax || 7,
                usePartsMatrix: savedSettings.usePartsMatrix || false,
                markup50: savedSettings.markup50 || 50,
                markup100: savedSettings.markup100 || 40,
                markup500: savedSettings.markup500 || 30,
                markup1000: savedSettings.markup1000 || 25,
                markupOver1000: savedSettings.markupOver1000 || 20,
                shopName: savedSettings.shopName || 'VHICL Pro Auto Shop',
                shopPhone: savedSettings.shopPhone || '(555) 123-4567',
                shopEmail: savedSettings.shopEmail || 'info@vhiclpro.com',
                shopAddress: savedSettings.shopAddress || '123 Main St, Anytown, USA',
                // API Settings
                apiEndpoint: savedSettings.apiEndpoint || 'https://api.techflow.io/v1',
                apiKey: savedSettings.apiKey || '',
                apiVersion: savedSettings.apiVersion || 'v1',
                apiEnvironment: savedSettings.apiEnvironment || 'development',
                apiEnabled: savedSettings.apiEnabled || false,
                apiTimeout: savedSettings.apiTimeout || 30,
                apiRetries: savedSettings.apiRetries || 3,
                apiRateLimit: savedSettings.apiRateLimit || 60
            };
            
            // Populate form fields (with null checks)
            const laborRateEl = document.getElementById('laborRate');
            if (laborRateEl) laborRateEl.value = settings.laborRate;
            
            const diagnosticFeeEl = document.getElementById('diagnosticFee');
            if (diagnosticFeeEl) diagnosticFeeEl.value = settings.diagnosticFee;
            
            const envFeeEl = document.getElementById('envFee');
            if (envFeeEl) envFeeEl.value = settings.envFee;
            
            const partsMarkupEl = document.getElementById('partsMarkup');
            if (partsMarkupEl) partsMarkupEl.value = settings.partsMarkup;
            
            const salesTaxEl = document.getElementById('salesTax');
            if (salesTaxEl) salesTaxEl.value = settings.salesTax;
            
            const usePartsMatrixEl = document.getElementById('usePartsMatrix');
            if (usePartsMatrixEl) usePartsMatrixEl.checked = settings.usePartsMatrix;
            
            const markup50El = document.getElementById('markup50');
            if (markup50El) markup50El.value = settings.markup50;
            
            const markup100El = document.getElementById('markup100');
            if (markup100El) markup100El.value = settings.markup100;
            
            const markup500El = document.getElementById('markup500');
            if (markup500El) markup500El.value = settings.markup500;
            
            const markup1000El = document.getElementById('markup1000');
            if (markup1000El) markup1000El.value = settings.markup1000;
            
            const markupOver1000El = document.getElementById('markupOver1000');
            if (markupOver1000El) markupOver1000El.value = settings.markupOver1000;
            
            const shopNameEl = document.getElementById('shopName');
            if (shopNameEl) shopNameEl.value = settings.shopName;
            
            const shopPhoneEl = document.getElementById('shopPhone');
            if (shopPhoneEl) shopPhoneEl.value = settings.shopPhone;
            
            const shopEmailEl = document.getElementById('shopEmail');
            if (shopEmailEl) shopEmailEl.value = settings.shopEmail;
            
            const shopAddressEl = document.getElementById('shopAddress');
            if (shopAddressEl) shopAddressEl.value = settings.shopAddress;
            
            // Populate API settings (with null checks)
            const apiEndpointEl = document.getElementById('apiEndpoint');
            if (apiEndpointEl) apiEndpointEl.value = settings.apiEndpoint;
            
            const apiKeyEl = document.getElementById('apiKey');
            if (apiKeyEl) apiKeyEl.value = settings.apiKey;
            
            const apiVersionEl = document.getElementById('apiVersion');
            if (apiVersionEl) apiVersionEl.value = settings.apiVersion;
            
            const apiEnvironmentEl = document.getElementById('apiEnvironment');
            if (apiEnvironmentEl) apiEnvironmentEl.value = settings.apiEnvironment;
            
            const apiEnabledEl = document.getElementById('apiEnabled');
            if (apiEnabledEl) apiEnabledEl.checked = settings.apiEnabled;
            
            const apiTimeoutEl = document.getElementById('apiTimeout');
            if (apiTimeoutEl) apiTimeoutEl.value = settings.apiTimeout;
            
            const apiRetriesEl = document.getElementById('apiRetries');
            if (apiRetriesEl) apiRetriesEl.value = settings.apiRetries;
            
            const apiRateLimitEl = document.getElementById('apiRateLimit');
            if (apiRateLimitEl) apiRateLimitEl.value = settings.apiRateLimit;
            
            // Populate VAPI settings (with null checks)
            const vapiApiKeyEl = document.getElementById('vapiApiKey');
            if (vapiApiKeyEl) vapiApiKeyEl.value = settings.vapiApiKey || '';
            
            const vapiPhoneNumberEl = document.getElementById('vapiPhoneNumber');
            if (vapiPhoneNumberEl) vapiPhoneNumberEl.value = settings.vapiPhoneNumber || '';
            
            const vapiVoiceEl = document.getElementById('vapiVoice');
            if (vapiVoiceEl) vapiVoiceEl.value = settings.vapiVoice || 'alex';
            
            const vapiEnabledEl = document.getElementById('vapiEnabled');
            if (vapiEnabledEl) vapiEnabledEl.checked = settings.vapiEnabled || false;
            
            const vapiRecordCallsEl = document.getElementById('vapiRecordCalls');
            if (vapiRecordCallsEl) vapiRecordCallsEl.checked = settings.vapiRecordCalls !== false;
            
            // Populate shop services and local parts settings
            const servicesNotPerformedEl = document.getElementById('servicesNotPerformed');
            if (servicesNotPerformedEl && settings.servicesNotPerformed) {
                servicesNotPerformedEl.value = settings.servicesNotPerformed.join('\n');
            }
            
            const localPartsNumbersEl = document.getElementById('localPartsNumbers');
            if (localPartsNumbersEl && settings.localPartsNumbers) {
                localPartsNumbersEl.value = settings.localPartsNumbers
                    .map(part => `${part.partName} | ${part.oemNumber} | ${part.localPartNumber} | ${part.supplier}`)
                    .join('\n');
            }
            
            // Populate Twilio settings
            const twilioAccountSidEl = document.getElementById('twilioAccountSid');
            if (twilioAccountSidEl) twilioAccountSidEl.value = settings.twilioAccountSid || '';
            const twilioAuthTokenEl = document.getElementById('twilioAuthToken');
            if (twilioAuthTokenEl) twilioAuthTokenEl.value = settings.twilioAuthToken || '';
            const twilioPhoneNumberEl = document.getElementById('twilioPhoneNumber');
            if (twilioPhoneNumberEl) twilioPhoneNumberEl.value = settings.twilioPhoneNumber || '';
            const twilioEnabledEl = document.getElementById('twilioEnabled');
            if (twilioEnabledEl) twilioEnabledEl.checked = settings.twilioEnabled || false;
            const twilioAutoRemindersEl = document.getElementById('twilioAutoReminders');
            if (twilioAutoRemindersEl) twilioAutoRemindersEl.checked = settings.twilioAutoReminders !== false;
            
            // Populate PayPal settings
            const paypalClientIdEl = document.getElementById('paypalClientId');
            if (paypalClientIdEl) paypalClientIdEl.value = settings.paypalClientId || '';
            const paypalClientSecretEl = document.getElementById('paypalClientSecret');
            if (paypalClientSecretEl) paypalClientSecretEl.value = settings.paypalClientSecret || '';
            const paypalEnvironmentEl = document.getElementById('paypalEnvironment');
            if (paypalEnvironmentEl) paypalEnvironmentEl.value = settings.paypalEnvironment || 'sandbox';
            const paypalEmailEl = document.getElementById('paypalEmail');
            if (paypalEmailEl) paypalEmailEl.value = settings.paypalEmail || '';
            const paypalEnabledEl = document.getElementById('paypalEnabled');
            if (paypalEnabledEl) paypalEnabledEl.checked = settings.paypalEnabled || false;
            const paypalAlexBillingEl = document.getElementById('paypalAlexBilling');
            if (paypalAlexBillingEl) paypalAlexBillingEl.checked = settings.paypalAlexBilling !== false;
            
            // Populate SendGrid settings
            const sendgridApiKeyEl = document.getElementById('sendgridApiKey');
            if (sendgridApiKeyEl) sendgridApiKeyEl.value = settings.sendgridApiKey || '';
            const sendgridFromEmailEl = document.getElementById('sendgridFromEmail');
            if (sendgridFromEmailEl) sendgridFromEmailEl.value = settings.sendgridFromEmail || '';
            const sendgridFromNameEl = document.getElementById('sendgridFromName');
            if (sendgridFromNameEl) sendgridFromNameEl.value = settings.sendgridFromName || 'VHICL Pro Auto Shop';
            const sendgridEnabledEl = document.getElementById('sendgridEnabled');
            if (sendgridEnabledEl) sendgridEnabledEl.checked = settings.sendgridEnabled || false;
            const sendgridAlexEmailEl = document.getElementById('sendgridAlexEmail');
            if (sendgridAlexEmailEl) sendgridAlexEmailEl.checked = settings.sendgridAlexEmail !== false;
            const sendgridTemplateEl = document.getElementById('sendgridTemplate');
            if (sendgridTemplateEl) sendgridTemplateEl.value = settings.sendgridTemplate || 'default';
            
            // Update badges
            updateApiBadge();
            updateIntegrationBadges();
            
            // Show/hide parts matrix
            togglePartsMatrix();
        }

        function saveSettings() {
            settings = {
                laborRate: parseFloat(document.getElementById('laborRate').value) || 100,
                diagnosticFee: parseFloat(document.getElementById('diagnosticFee').value) || 85,
                envFee: parseFloat(document.getElementById('envFee').value) || 15,
                partsMarkup: parseFloat(document.getElementById('partsMarkup').value) || 30,
                salesTax: parseFloat(document.getElementById('salesTax').value) || 7,
                usePartsMatrix: document.getElementById('usePartsMatrix').checked,
                markup50: parseFloat(document.getElementById('markup50').value) || 50,
                markup100: parseFloat(document.getElementById('markup100').value) || 40,
                markup500: parseFloat(document.getElementById('markup500').value) || 30,
                markup1000: parseFloat(document.getElementById('markup1000').value) || 25,
                markupOver1000: parseFloat(document.getElementById('markupOver1000').value) || 20,
                shopName: document.getElementById('shopName').value,
                shopPhone: document.getElementById('shopPhone').value,
                shopEmail: document.getElementById('shopEmail').value,
                shopAddress: document.getElementById('shopAddress').value
            };
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        function saveApiSettings() {
            const apiEndpointEl = document.getElementById('apiEndpoint');
            const apiKeyEl = document.getElementById('apiKey');
            const apiVersionEl = document.getElementById('apiVersion');
            const apiEnvironmentEl = document.getElementById('apiEnvironment');
            const apiEnabledEl = document.getElementById('apiEnabled');
            const apiTimeoutEl = document.getElementById('apiTimeout');
            const apiRetriesEl = document.getElementById('apiRetries');
            const apiRateLimitEl = document.getElementById('apiRateLimit');
            
            if (apiEndpointEl) settings.apiEndpoint = apiEndpointEl.value;
            if (apiKeyEl) settings.apiKey = apiKeyEl.value;
            if (apiVersionEl) settings.apiVersion = apiVersionEl.value;
            if (apiEnvironmentEl) settings.apiEnvironment = apiEnvironmentEl.value;
            if (apiEnabledEl) settings.apiEnabled = apiEnabledEl.checked;
            if (apiTimeoutEl) settings.apiTimeout = parseInt(apiTimeoutEl.value) || 30;
            if (apiRetriesEl) settings.apiRetries = parseInt(apiRetriesEl.value) || 3;
            if (apiRateLimitEl) settings.apiRateLimit = parseInt(apiRateLimitEl.value) || 60;
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            updateApiBadge();
            alert('API settings saved successfully!');
        }

        function resetApiSettings() {
            if (confirm('Are you sure you want to reset all API settings to defaults?')) {
                settings.apiEndpoint = 'https://api.techflow.io/v1';
                settings.apiKey = '';
                settings.apiVersion = 'v2';
                settings.apiEnvironment = 'development';
                settings.apiEnabled = false;
                settings.apiTimeout = 30;
                settings.apiRetries = 3;
                settings.apiRateLimit = 60;
                
                document.getElementById('apiEndpoint').value = settings.apiEndpoint;
                document.getElementById('apiKey').value = settings.apiKey;
                document.getElementById('apiVersion').value = settings.apiVersion;
                document.getElementById('apiEnvironment').value = settings.apiEnvironment;
                document.getElementById('apiEnabled').checked = settings.apiEnabled;
                document.getElementById('apiTimeout').value = settings.apiTimeout;
                document.getElementById('apiRetries').value = settings.apiRetries;
                document.getElementById('apiRateLimit').value = settings.apiRateLimit;
                
                localStorage.setItem('vhicl_settings', JSON.stringify(settings));
                updateApiBadge();
                document.getElementById('apiStatus').className = 'api-status';
                document.getElementById('apiStatus').innerHTML = '';
                
                alert('API settings have been reset to defaults.');
            }
        }

        function updateApiBadge() {
            const badge = document.getElementById('apiBadge');
            const indicator = document.getElementById('apiIndicator');
            const indicatorText = document.getElementById('apiIndicatorText');
            
            if (!badge) return;
            
            if (settings.apiEnabled && settings.apiKey) {
                badge.style.background = '#d4edda';
                badge.style.color = '#155724';
                badge.textContent = 'Connected';
                
                // Show navbar indicator
                if (indicator) {
                    indicator.style.display = 'flex';
                    indicator.style.background = 'rgba(67, 233, 123, 0.2)';
                    indicator.style.color = '#43e97b';
                }
                if (indicatorText) {
                    indicatorText.textContent = 'API Connected';
                }
            } else {
                badge.style.background = '#f8d7da';
                badge.style.color = '#721c24';
                badge.textContent = 'Disconnected';
                
                // Hide navbar indicator
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }
        }

        function testApiConnection() {
            const apiEndpointEl = document.getElementById('apiEndpoint');
            const apiKeyEl = document.getElementById('apiKey');
            const apiEnabledEl = document.getElementById('apiEnabled');
            
            if (!apiEndpointEl || !apiKeyEl || !apiEnabledEl) {
                console.error('Required API elements not found');
                return;
            }
            
            const endpoint = apiEndpointEl.value;
            const apiKey = apiKeyEl.value;
            const isEnabled = apiEnabledEl.checked;
            
            if (!endpoint || !apiKey) {
                alert('Please enter both API endpoint and API key');
                return;
            }
            
            // Show loading indicator
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            btn.disabled = true;
            
            const statusDiv = document.getElementById('apiStatus');
            if (statusDiv) {
                statusDiv.className = 'api-status';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin status-icon"></i> Testing connection...';
                statusDiv.style.display = 'block';
            }
            
            // Simulate API test (in production, this would be a real fetch)
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (isEnabled) {
                    statusDiv.className = 'api-status connected';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle status-icon"></i><strong>Connected</strong><br>Endpoint: ' + endpoint + '<br>Environment: ' + settings.apiEnvironment;
                    
                    // Update settings to reflect enabled state
                    settings.apiEnabled = true;
                    settings.apiKey = apiKey;
                    settings.apiEndpoint = endpoint;
                    updateApiBadge();
                    
                    alert('‚úÖ API Connection Test Successful!\n\nEndpoint: ' + endpoint + '\nEnvironment: ' + settings.apiEnvironment + '\nVersion: ' + settings.apiVersion);
                } else {
                    statusDiv.className = 'api-status disconnected';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle status-icon"></i><strong>Disconnected</strong><br>API integration is disabled. Enable it to use Techflow features.';
                    alert('‚ö†Ô∏è API integration is disabled. Enable it to use Techflow features.');
                }
            }, 2000);
        }

        function togglePartsMatrix() {
            const checkbox = document.getElementById('usePartsMatrix');
            const matrixCard = document.getElementById('partsMatrixCard');
            if (matrixCard) {
                matrixCard.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        document.getElementById('usePartsMatrix')?.addEventListener('change', togglePartsMatrix);

        // ============ MODAL FUNCTIONS ============
        function openCustomerModal() {
            document.getElementById('customerModal').classList.add('active');
            populateCustomerDropdown();
        }

        function openAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('active');
            populateCustomerDropdown();
        }

        function openTowingModal() {
            document.getElementById('towingModal').classList.add('active');
        }

        function openInventoryModal() {
            document.getElementById('inventoryModal').classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                
                // Reset estimate form if closing estimate modal
                if (modalId === 'estimateModal') {
                    window.editingEstimateId = null;
                    estimateParts = [];
                    estimateLabor = [];
                    
                    // Reset button text
                    const submitBtn = document.querySelector('#estimateModal .btn-primary');
                    if (submitBtn) {
                        submitBtn.textContent = 'Create Estimate';
                    }
                    
                    // Clear form fields
                    const vehicleInput = document.getElementById('estimateVehicle');
                    const descInput = document.getElementById('estimateDescription');
                    const statusSelect = document.getElementById('estimateStatus');
                    
                    if (vehicleInput) vehicleInput.value = '';
                    if (descInput) descInput.value = '';
                    if (statusSelect) statusSelect.value = 'Draft';
                    
                    // Clear parts and labor lists
                    renderEstimateParts();
                    renderEstimateLabor();
                    updateEstimateTotal();
                }
            }
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // ============ CUSTOMER FUNCTIONS ============
        function populateCustomerDropdown() {
            const select = document.getElementById('appointmentCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer.id}">${customer.name}</option>`;
            });
        }

        function saveCustomer() {
            const customer = {
                id: Date.now(),
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                vehicles: [{
                    year: document.getElementById('vehicleYear').value,
                    make: document.getElementById('vehicleMake').value,
                    model: document.getElementById('vehicleModel').value,
                    plate: document.getElementById('licensePlate').value
                }]
            };
            
            customers.push(customer);
            saveToStorage();
            renderCustomers();
            closeModal('customerModal');
            
            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
        }

        function renderCustomers() {
            const list = document.getElementById('customerList');
            if (customers.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No customers yet. Add your first customer!</p>';
                return;
            }
            
            list.innerHTML = customers.map(customer => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${customer.name}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-phone"></i> ${customer.phone}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-envelope"></i> ${customer.email}</p>
                            ${customer.vehicles.map(v => `
                                <p style="color: #00d4ff; margin: 0.25rem 0; font-size: 0.9rem;">
                                    <i class="fas fa-car"></i> ${v.year} ${v.make} ${v.model} (${v.plate})
                                </p>
                            `).join('')}
                        </div>
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                customers = customers.filter(c => c.id !== id);
                saveToStorage();
                renderCustomers();
            }
        }

        function initSampleCustomers() {
            customers = [
                {
                    id: 1,
                    name: 'John Smith',
                    phone: '(555) 111-2222',
                    email: 'john@example.com',
                    vehicles: [
                        { year: 2018, make: 'Honda', model: 'Accord', plate: 'ABC123' }
                    ]
                },
                {
                    id: 2,
                    name: 'Jane Doe',
                    phone: '(555) 333-4444',
                    email: 'jane@example.com',
                    vehicles: [
                        { year: 2020, make: 'Toyota', model: 'Camry', plate: 'XYZ789' }
                    ]
                }
            ];
            saveToStorage();
        }

        // ============ APPOINTMENT FUNCTIONS ============
        function saveAppointment() {
            const appointment = {
                id: Date.now(),
                customerId: document.getElementById('appointmentCustomer').value,
                customerName: customers.find(c => c.id == document.getElementById('appointmentCustomer').value)?.name || 'Unknown',
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                serviceType: document.getElementById('serviceType').value,
                notes: document.getElementById('appointmentNotes').value,
                status: 'Scheduled'
            };
            
            appointments.push(appointment);
            saveToStorage();
            renderAppointments();
            closeModal('appointmentModal');
        }

        function renderAppointments() {
            const list = document.getElementById('appointmentList');
            if (appointments.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No appointments scheduled yet.</p>';
                return;
            }
            
            list.innerHTML = appointments.map(apt => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${apt.customerName}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-calendar"></i> ${apt.date} at ${apt.time}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-wrench"></i> ${apt.serviceType}</p>
                            ${apt.notes ? `<p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-comment"></i> ${apt.notes}</p>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-badge status-approved">${apt.status}</span>
                            <button class="btn btn-danger" onclick="deleteAppointment(${apt.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteAppointment(id) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                appointments = appointments.filter(a => a.id !== id);
                saveToStorage();
                renderAppointments();
            }
        }

        // ============ ESTIMATE FUNCTIONS ============
        let estimateParts = [];
        let estimateLabor = [];

        function openEstimateModal() {
            // Clear edit mode
            window.editingEstimateId = null;
            
            // Reset parts and labor
            estimateParts = [];
            estimateLabor = [];
            updateEstimateTotal();
            
            // Populate customer select
            const customerSelect = document.getElementById('estimateCustomerSelect');
            if (customerSelect) {
                customerSelect.innerHTML = '<option value="">Select Customer</option>' +
                    customers.map(c => `<option value="${c.id}">${c.name} - ${c.vehicle}</option>`).join('');
            }
            
            // Clear form fields
            const vehicleInput = document.getElementById('estimateVehicle');
            const descInput = document.getElementById('estimateDescription');
            const statusSelect = document.getElementById('estimateStatus');
            const partsList = document.getElementById('estimatePartsList');
            const laborList = document.getElementById('estimateLaborList');
            
            if (vehicleInput) vehicleInput.value = '';
            if (descInput) descInput.value = '';
            if (statusSelect) statusSelect.value = 'Draft';
            if (partsList) partsList.innerHTML = '';
            if (laborList) laborList.innerHTML = '';
            
            // Open modal
            const modal = document.getElementById('estimateModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function addEstimatePart() {
            const name = prompt('Part name:');
            if (!name) return;
            const price = parseFloat(prompt('Part price:', '0')) || 0;
            const quantity = parseInt(prompt('Quantity:', '1')) || 1;
            
            estimateParts.push({ name, price, quantity });
            renderEstimateParts();
            updateEstimateTotal();
        }

        function addEstimateLabor() {
            const description = prompt('Labor description:');
            if (!description) return;
            const hours = parseFloat(prompt('Hours:', '1')) || 1;
            const rate = parseFloat(prompt('Hourly rate:', '100')) || 100;
            
            estimateLabor.push({ description, hours, rate, total: hours * rate });
            renderEstimateLabor();
            updateEstimateTotal();
        }

        function renderEstimateParts() {
            const partsList = document.getElementById('estimatePartsList');
            if (!partsList) return;
            
            // Ensure estimateParts is an array
            if (!Array.isArray(estimateParts)) {
                estimateParts = [];
            }
            
            if (estimateParts.length === 0) {
                partsList.innerHTML = '<p style="color: #666;">No parts added yet</p>';
                return;
            }
            
            partsList.innerHTML = estimateParts.map((part, index) => `
                <div style="padding: 0.5rem; background: #f5f5f5; margin: 0.5rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${part.name || 'Part'}</strong><br>
                        <small>Qty: ${part.quantity || 0} x $${(part.price || 0).toFixed(2)}</small>
                    </div>
                    <div>
                        <strong>$${((part.quantity || 0) * (part.price || 0)).toFixed(2)}</strong>
                        <button class="btn btn-danger" style="margin-left: 0.5rem;" onclick="removeEstimatePart(${index})">X</button>
                    </div>
                </div>
            `).join('');
        }

        function renderEstimateLabor() {
            const laborList = document.getElementById('estimateLaborList');
            if (!laborList) return;
            
            // Ensure estimateLabor is an array
            if (!Array.isArray(estimateLabor)) {
                estimateLabor = [];
            }
            
            if (estimateLabor.length === 0) {
                laborList.innerHTML = '<p style="color: #666;">No labor added yet</p>';
                return;
            }
            
            laborList.innerHTML = estimateLabor.map((item, index) => `
                <div style="padding: 0.5rem; background: #f5f5f5; margin: 0.5rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${item.description || 'Labor'}</strong><br>
                        <small>${item.hours || 0} hrs x $${(item.rate || 0).toFixed(2)}/hr</small>
                    </div>
                    <div>
                        <strong>$${(item.total || 0).toFixed(2)}</strong>
                        <button class="btn btn-danger" style="margin-left: 0.5rem;" onclick="removeEstimateLabor(${index})">X</button>
                    </div>
                </div>
            `).join('');
        }

        function removeEstimatePart(index) {
            estimateParts.splice(index, 1);
            renderEstimateParts();
            updateEstimateTotal();
        }

        function removeEstimateLabor(index) {
            estimateLabor.splice(index, 1);
            renderEstimateLabor();
            updateEstimateTotal();
        }

        function updateEstimateTotal() {
            const totalEl = document.getElementById('estimateTotal');
            if (!totalEl) return;
            
            // Ensure arrays are properly initialized
            if (!Array.isArray(estimateParts)) {
                estimateParts = [];
            }
            if (!Array.isArray(estimateLabor)) {
                estimateLabor = [];
            }
            
            // Calculate parts total with safety checks
            const partsTotal = estimateParts.reduce((sum, part) => {
                const qty = part.quantity || 0;
                const price = part.price || 0;
                return sum + (qty * price);
            }, 0);
            
            // Calculate labor total with safety checks
            const laborTotal = estimateLabor.reduce((sum, item) => {
                return sum + (item.total || 0);
            }, 0);
            
            const total = partsTotal + laborTotal;
            
            totalEl.textContent = total.toFixed(2);
        }

        function saveEstimate() {
            const customerId = document.getElementById('estimateCustomerSelect').value;
            const vehicle = document.getElementById('estimateVehicle').value.trim();
            const description = document.getElementById('estimateDescription').value.trim();
            const status = document.getElementById('estimateStatus').value;
            
            if (!customerId || !vehicle) {
                alert('Please select a customer and enter vehicle information');
                return;
            }
            
            const customer = customers.find(c => c.id === parseInt(customerId));
            const partsTotal = estimateParts.reduce((sum, part) => sum + (part.quantity * part.price), 0);
            const laborTotal = estimateLabor.reduce((sum, item) => sum + item.total, 0);
            
            // Check if editing existing estimate
            if (window.editingEstimateId) {
                // Update existing estimate
                const index = estimates.findIndex(e => e.id === window.editingEstimateId);
                if (index !== -1) {
                    estimates[index] = {
                        ...estimates[index],
                        customerName: customer ? customer.name : 'Unknown',
                        customerId: customerId,
                        vehicle: vehicle,
                        description: description,
                        parts: estimateParts,
                        labor: estimateLabor,
                        total: partsTotal + laborTotal,
                        status: status
                    };
                }
                
                // Clear edit mode
                window.editingEstimateId = null;
                
                saveToStorage();
                renderEstimates();
                renderPendingApprovalEstimates();
                closeModal('estimateModal');
                alert('Estimate updated successfully!');
            } else {
                // Create new estimate
                const estimate = {
                    id: Date.now(),
                    customerName: customer ? customer.name : 'Unknown',
                    customerId: customerId,
                    vehicle: vehicle,
                    description: description,
                    date: new Date().toISOString().split('T')[0],
                    parts: estimateParts,
                    labor: estimateLabor,
                    total: partsTotal + laborTotal,
                    status: 'Draft'  // Always start as Draft for shop approval
                };
                
                estimates.push(estimate);
                saveToStorage();
                renderEstimates();
                renderPendingApprovalEstimates();
                closeModal('estimateModal');
                alert('Estimate saved and submitted for shop approval!\n\nShop manager will review and approve before Alex calls the customer.');
            }
        }

        function initSampleEstimates() {
            estimates = [
                {
                    id: 1,
                    customerName: 'John Smith',
                    vehicle: '2018 Honda Accord',
                    date: '2025-01-15',
                    status: 'Approved',
                    parts: [
                        { name: 'Brake Pads (Front)', price: 85, quantity: 1 },
                        { name: 'Rotors (Front)', price: 120, quantity: 2 }
                    ],
                    labor: { hours: 2, rate: 100 },
                    total: 405
                },
                {
                    id: 2,
                    customerName: 'Jane Doe',
                    vehicle: '2020 Toyota Camry',
                    date: '2025-01-16',
                    status: 'Pending',
                    parts: [
                        { name: 'Oil Filter', price: 15, quantity: 1 },
                        { name: 'Synthetic Oil (5qt)', price: 45, quantity: 1 }
                    ],
                    labor: { hours: 0.5, rate: 100 },
                    total: 60
                }
            ];
            saveToStorage();
        }

        function renderEstimates() {
            const list = document.getElementById('estimateList');
            if (!list) return;
            
            if (estimates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No estimates yet.</p>';
                return;
            }
            
            list.innerHTML = estimates.map(est => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${est.customerName} - ${est.vehicle}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-calendar"></i> ${est.date}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-car"></i> ${est.vehicle}</p>
                            <p style="font-weight: bold; color: #0a2540; margin-top: 0.5rem;">Total: $${est.total.toFixed(2)}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-badge status-${est.status.toLowerCase()}">${est.status}</span>
                            <button class="btn" style="background: #667eea; color: white;" onclick="editEstimate(${est.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-primary" onclick="convertToInvoice(${est.id})">
                                <i class="fas fa-file-invoice"></i> Convert
                            </button>
                            <button class="btn btn-danger" onclick="deleteEstimate(${est.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function convertToInvoice(estimateId) {
            const estimate = estimates.find(e => e.id === estimateId);
            if (!estimate) return;
            
            const invoice = {
                id: Date.now(),
                customerName: estimate.customerName,
                vehicle: estimate.vehicle,
                date: new Date().toISOString().split('T')[0],
                parts: estimate.parts,
                labor: estimate.labor,
                total: estimate.total,
                status: 'Unpaid'
            };
            
            invoices.push(invoice);
            estimates = estimates.filter(e => e.id !== estimateId);
            saveToStorage();
            renderEstimates();
            renderInvoices();
            alert('Estimate converted to invoice!');
        }

        function deleteEstimate(id) {
            if (confirm('Are you sure you want to delete this estimate?')) {
                estimates = estimates.filter(e => e.id !== id);
                saveToStorage();
                renderEstimates();
            }
        }

        function editEstimate(id) {
            try {
                const estimate = estimates.find(e => e.id === id);
                if (!estimate) {
                    console.error('Estimate not found:', id);
                    alert('Estimate not found');
                    return;
                }

                // Store the estimate being edited
                window.editingEstimateId = id;

                // Populate form with existing data
                const customerSelect = document.getElementById('estimateCustomerSelect');
                if (customerSelect) {
                    customerSelect.value = estimate.customerId || estimate.customerName || '';
                }
                
                const vehicleInput = document.getElementById('estimateVehicle');
                if (vehicleInput) {
                    vehicleInput.value = estimate.vehicle || '';
                }
                
                const descInput = document.getElementById('estimateDescription');
                if (descInput) {
                    descInput.value = estimate.description || '';
                }
                
                const statusSelect = document.getElementById('estimateStatus');
                if (statusSelect) {
                    statusSelect.value = estimate.status || 'Draft';
                }

                // Load parts - ensure it's an array
                estimateParts = Array.isArray(estimate.parts) ? estimate.parts : [];
                renderEstimateParts();

                // Load labor - handle both old (object) and new (array) formats
                if (estimate.labor) {
                    if (Array.isArray(estimate.labor)) {
                        // New format: array of labor items
                        estimateLabor = estimate.labor;
                    } else {
                        // Old format: object with hours and rate
                        const oldLabor = estimate.labor;
                        estimateLabor = [{
                            description: 'Labor',
                            hours: oldLabor.hours || 0,
                            rate: oldLabor.rate || 0,
                            total: (oldLabor.hours || 0) * (oldLabor.rate || 0)
                        }];
                    }
                } else {
                    estimateLabor = [];
                }
                renderEstimateLabor();

                // Update total
                updateEstimateTotal();

                // Change button text
                const submitBtn = document.querySelector('#estimateModal .btn-primary');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Estimate';
                }

                // Open modal
                const modal = document.getElementById('estimateModal');
                if (modal) {
                    modal.classList.add('active');
                }
            } catch (error) {
                console.error('Error editing estimate:', error);
                alert('Error opening estimate for editing. Please check console for details.');
            }
        }

        // ============ INVOICE FUNCTIONS ============
        function openInvoiceModal() {
            alert('Invoice creation modal will open here. For now, view sample invoices below.');
        }

        function initSampleInvoices() {
            invoices = [
                {
                    id: 1,
                    customerName: 'Bob Wilson',
                    vehicle: '2019 Ford F-150',
                    date: '2025-01-14',
                    status: 'Paid',
                    parts: [
                        { name: 'Battery', price: 150, quantity: 1 }
                    ],
                    labor: { hours: 0.5, rate: 100 },
                    total: 200
                }
            ];
            saveToStorage();
        }

        function renderInvoices() {
            const list = document.getElementById('invoiceList');
            if (invoices.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No invoices yet.</p>';
                return;
            }
            
            list.innerHTML = invoices.map(inv => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${inv.customerName} - ${inv.vehicle}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-calendar"></i> ${inv.date}</p>
                            <p style="font-weight: bold; color: #0a2540; margin-top: 0.5rem;">Total: $${inv.total.toFixed(2)}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-badge status-${inv.status.toLowerCase()}">${inv.status}</span>
                            ${inv.status === 'Unpaid' ? `
                                <button class="btn btn-success" onclick="markAsPaid(${inv.id})">
                                    <i class="fas fa-check"></i> Paid
                                </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteInvoice(${inv.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function markAsPaid(id) {
            const invoice = invoices.find(i => i.id === id);
            if (invoice) {
                invoice.status = 'Paid';
                invoice.paidDate = new Date().toISOString().split('T')[0];
                saveToStorage();
                renderInvoices();
                alert('Invoice marked as paid!');
            }
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoices = invoices.filter(i => i.id !== id);
                saveToStorage();
                renderInvoices();
            }
        }

        // ============ TOWING FUNCTIONS ============
        function initSampleTowing() {
            towingRequests = [
                {
                    id: 1,
                    customerName: 'Mike Johnson',
                    phone: '(555) 555-5555',
                    location: '123 Oak Street, Downtown',
                    vehicle: '2017 Chevrolet Silverado - Black',
                    plate: 'DEF456',
                    destination: 'shop',
                    keyLocation: 'with-customer',
                    meetDriver: 'yes',
                    status: 'Pending',
                    date: new Date().toISOString()
                },
                {
                    id: 2,
                    customerName: 'Sarah Lee',
                    phone: '(555) 666-6666',
                    location: '456 Pine Avenue, Midtown',
                    vehicle: '2019 Nissan Altima - Silver',
                    plate: 'GHI789',
                    destination: 'shop',
                    keyLocation: 'in-vehicle',
                    meetDriver: 'no',
                    status: 'Assigned',
                    date: new Date().toISOString()
                }
            ];
            saveToStorage();
        }

        function saveTowingRequest() {
            const request = {
                id: Date.now(),
                customerName: document.getElementById('towingCustomer').value,
                phone: document.getElementById('towingPhone').value,
                location: document.getElementById('towingLocation').value,
                vehicle: document.getElementById('towingVehicle').value,
                plate: document.getElementById('towingPlate').value,
                destination: document.getElementById('towingDestination').value,
                keyLocation: document.getElementById('keyLocation').value,
                meetDriver: document.getElementById('meetDriver').value,
                status: 'Pending',
                date: new Date().toISOString()
            };
            
            towingRequests.push(request);
            saveToStorage();
            renderTowing();
            closeModal('towingModal');
            alert('Towing request submitted!');
        }

        function renderTowing() {
            const list = document.getElementById('towingList');
            
            // Update stats
            const pending = towingRequests.filter(t => t.status === 'Pending').length;
            const assigned = towingRequests.filter(t => t.status === 'Assigned').length;
            const arrived = towingRequests.filter(t => t.status === 'Arrived').length;
            
            const pendingEl = document.getElementById('pendingTowing');
            const assignedEl = document.getElementById('assignedTowing');
            const arrivedEl = document.getElementById('arrivedTowing');
            
            if (pendingEl) pendingEl.textContent = pending;
            if (assignedEl) assignedEl.textContent = assigned;
            if (arrivedEl) arrivedEl.textContent = arrived;
            
            if (towingRequests.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No towing requests yet.</p>';
                return;
            }
            
            list.innerHTML = towingRequests.map(req => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${req.customerName}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-phone"></i> ${req.phone}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-map-marker-alt"></i> ${req.location}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-car"></i> ${req.vehicle} (${req.plate})</p>
                            <p style="color: #666; margin: 0.25rem 0;">
                                <i class="fas fa-key"></i> Keys: ${req.keyLocation} | 
                                <i class="fas fa-user"></i> Meet driver: ${req.meetDriver === 'yes' ? 'Yes' : 'No'}
                            </p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: end;">
                            <span class="status-badge status-${req.status.toLowerCase()}">${req.status}</span>
                            ${req.status === 'Pending' ? `
                                <button class="btn btn-primary" onclick="assignTowing(${req.id})">
                                    <i class="fas fa-truck"></i> Assign
                                </button>
                            ` : ''}
                            ${req.status === 'Assigned' ? `
                                <button class="btn btn-success" onclick="markArrived(${req.id})">
                                    <i class="fas fa-check-circle"></i> Arrived
                                </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteTowingRequest(${req.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function assignTowing(id) {
            const request = towingRequests.find(t => t.id === id);
            if (request) {
                request.status = 'Assigned';
                request.assignedAt = new Date().toISOString();
                saveToStorage();
                renderTowing();
                alert('Towing provider assigned!');
            }
        }

        function markArrived(id) {
            const request = towingRequests.find(t => t.id === id);
            if (request) {
                request.status = 'Arrived';
                request.arrivedAt = new Date().toISOString();
                saveToStorage();
                renderTowing();
                alert('Vehicle marked as arrived at the shop!');
            }
        }

        function deleteTowingRequest(id) {
            if (confirm('Are you sure you want to delete this request?')) {
                towingRequests = towingRequests.filter(t => t.id !== id);
                saveToStorage();
                renderTowing();
            }
        }

        // ============ TECHFLOW API FUNCTIONS ============
        async function decodeVin() {
            const vin = document.getElementById('vinInput').value.trim().toUpperCase();
            
            if (vin.length !== 17) {
                alert('Please enter a valid 17-digit VIN number');
                return;
            }

            const resultsDiv = document.getElementById('vinResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Decoding VIN...</div>';
            }

            try {
                // Check if Techflow API is configured
                const settings = JSON.parse(localStorage.getItem('vhicl_settings') || '{}');
                
                if (settings.apiEnabled && settings.apiEndpoint) {
                    // Use real Techflow API (simulated)
                    const response = await fetch(settings.apiEndpoint + '/vin/decode', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${settings.apiKey}`
                        },
                        body: JSON.stringify({ vin })
                    });
                    
                    // For demo, simulate response
                    const vehicleData = simulateVinDecode(vin);
                    displayVinResults(vehicleData);
                } else {
                    // Use simulated data
                    const vehicleData = simulateVinDecode(vin);
                    displayVinResults(vehicleData);
                }
            } catch (error) {
                console.error('VIN decode error:', error);
                const vehicleData = simulateVinDecode(vin);
                displayVinResults(vehicleData);
            }
        }

        function simulateVinDecode(vin) {
            // Simulate VIN decode data
            const manufacturers = ['Toyota', 'Honda', 'Ford', 'Chevrolet', 'Nissan'];
            const models = ['Camry', 'Accord', 'F-150', 'Silverado', 'Altima'];
            const years = [2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024];
            
            return {
                vin: vin,
                make: manufacturers[Math.floor(Math.random() * manufacturers.length)],
                model: models[Math.floor(Math.random() * models.length)],
                year: years[Math.floor(Math.random() * years.length)],
                trim: ['LE', 'SE', 'XLT', 'LT', 'SV'][Math.floor(Math.random() * 5)],
                engine: ['2.5L 4-Cylinder', '3.5L V6', '5.0L V8', '2.0L Turbo'][Math.floor(Math.random() * 4)],
                transmission: ['Automatic', 'CVT', '6-Speed Manual'][Math.floor(Math.random() * 3)],
                driveType: ['FWD', 'AWD', '4WD', 'RWD'][Math.floor(Math.random() * 4)],
                fuelType: ['Gasoline', 'Hybrid', 'Electric', 'Diesel'][Math.floor(Math.random() * 4)],
                color: ['White', 'Black', 'Silver', 'Blue', 'Red'][Math.floor(Math.random() * 5)],
                doors: ['4-Door Sedan', '2-Door Coupe', '4-Door SUV', '2-Door Truck'][Math.floor(Math.random() * 4)],
                msrp: `$${(20000 + Math.random() * 40000).toFixed(0)}`,
                warranty: {
                    basic: '3 years/36,000 miles',
                    powertrain: '5 years/60,000 miles',
                    corrosion: '5 years/unlimited miles'
                }
            };
        }

        function displayVinResults(data) {
            const resultsDiv = document.getElementById('vinResults');
            resultsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <strong>VIN:</strong><br>${data.vin}
                    </div>
                    <div>
                        <strong>Year/Make/Model:</strong><br>${data.year} ${data.make} ${data.model}
                    </div>
                    <div>
                        <strong>Trim:</strong><br>${data.trim}
                    </div>
                    <div>
                        <strong>Engine:</strong><br>${data.engine}
                    </div>
                    <div>
                        <strong>Transmission:</strong><br>${data.transmission}
                    </div>
                    <div>
                        <strong>Drive Type:</strong><br>${data.driveType}
                    </div>
                    <div>
                        <strong>Fuel Type:</strong><br>${data.fuelType}
                    </div>
                    <div>
                        <strong>Body Style:</strong><br>${data.doors}
                    </div>
                    <div>
                        <strong>MSRP:</strong><br>${data.msrp}
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #d4edda; border-radius: 5px;">
                    <strong><i class="fas fa-shield-alt"></i> Warranty Information:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        <li>Basic: ${data.warranty.basic}</li>
                        <li>Powertrain: ${data.warranty.powertrain}</li>
                        <li>Corrosion: ${data.warranty.corrosion}</li>
                    </ul>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="getServiceSchedule('${data.vin}')">
                        <i class="fas fa-calendar-alt"></i> Get Service Schedule
                    </button>
                    <button class="btn btn-primary" onclick="getVehicleHistory('${data.vin}')">
                        <i class="fas fa-history"></i> Get Vehicle History
                    </button>
                    <button class="btn btn-success" onclick="createVehicleCustomer('${data.year}', '${data.make}', '${data.model}', '${data.vin}')">
                        <i class="fas fa-user-plus"></i> Add as Customer
                    </button>
                </div>
            `;
        }

        async function lookupParts() {
            const vehicle = document.getElementById('partsVehicle').value;
            const partName = document.getElementById('partsSearch').value;
            const category = document.getElementById('partsCategory').value;

            if (!vehicle || !partName) {
                alert('Please enter vehicle and part information');
                return;
            }

            const resultsDiv = document.getElementById('partsResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Searching parts...</div>';
            }

            try {
                // Simulate parts search
                const parts = simulatePartsSearch(vehicle, partName, category);
                displayPartsResults(parts);
            } catch (error) {
                console.error('Parts lookup error:', error);
                const parts = simulatePartsSearch(vehicle, partName, category);
                displayPartsResults(parts);
            }
        }

        function simulatePartsSearch(vehicle, partName, category) {
            // Simulate parts data
            const partTypes = [
                { name: partName + ' - OEM', price: 85 + Math.random() * 50, brand: 'OEM', stock: 15, source: 'Techflow Database' },
                { name: partName + ' - Premium', price: 65 + Math.random() * 40, brand: 'Bosch', stock: 23, source: 'Nexpart' },
                { name: partName + ' - Standard', price: 45 + Math.random() * 30, brand: 'Duralast', stock: 45, source: 'AutoZone' },
                { name: partName + ' - Value', price: 35 + Math.random() * 20, brand: 'Wagner', stock: 32, source: 'O\'Reilly' }
            ];

            return partTypes.map(p => ({
                ...p,
                partNumber: generatePartNumber(),
                fitment: 'Fits ' + vehicle,
                warranty: '12 months / 12,000 miles'
            }));
        }

        function generatePartNumber() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let part = '';
            for (let i = 0; i < 10; i++) {
                part += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return part;
        }

        function displayPartsResults(parts) {
            const resultsDiv = document.getElementById('partsResults');
            resultsDiv.innerHTML = `
                <h3 style="color: #0a2540; margin-bottom: 1rem;">Found ${parts.length} parts</h3>
                ${parts.map((part, index) => `
                    <div class="card" style="margin-bottom: 0.5rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <h4 style="color: #0a2540; margin-bottom: 0.5rem;">${part.name}</h4>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.25rem 0;"><strong>Part #:</strong> ${part.partNumber}</p>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.25rem 0;"><strong>Brand:</strong> ${part.brand}</p>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.25rem 0;"><strong>${part.fitment}</strong></p>
                                <p style="color: #666; font-size: 0.9rem; margin: 0.25rem 0;"><strong>Warranty:</strong> ${part.warranty}</p>
                                <p style="color: #00d4ff; font-size: 0.9rem; margin: 0.25rem 0;"><strong>Source:</strong> ${part.source}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0a2540;">$${part.price.toFixed(2)}</div>
                                <p style="color: ${part.stock > 10 ? '#43e97b' : '#f5576c'}; font-weight: bold; margin: 0.5rem 0;">
                                    ${part.stock > 10 ? '‚úì In Stock' : '‚ö† Low Stock (' + part.stock + ')'}
                                </p>
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button class="btn btn-primary" onclick="orderPart('${part.partNumber}', '${part.name}', ${part.price})">
                                        <i class="fas fa-shopping-cart"></i> Order
                                    </button>
                                    <button class="btn btn-success" onclick="addToInventory('${part.name}', '${part.partNumber}', ${part.price})">
                                        <i class="fas fa-plus"></i> Add to Inventory
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        async function getServiceSchedule(vin) {
            const inputVin = vin || document.getElementById('scheduleVin').value.trim().toUpperCase();
            
            if (inputVin.length !== 17) {
                alert('Please enter a valid 17-digit VIN number');
                return;
            }

            const resultsDiv = document.getElementById('scheduleResults');
            if (resultsDiv) {
                if (!vin) resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading service schedule...</div>';
            }

            try {
                const schedule = simulateServiceSchedule(inputVin);
                displayServiceSchedule(schedule);
            } catch (error) {
                console.error('Service schedule error:', error);
                const schedule = simulateServiceSchedule(inputVin);
                displayServiceSchedule(schedule);
            }
        }

        function simulateServiceSchedule(vin) {
            return {
                vin: vin,
                schedules: [
                    {
                        interval: 'Every 5,000 miles or 6 months',
                        services: ['Oil Change', 'Oil Filter Replacement', 'Tire Rotation', 'Fluid Level Check']
                    },
                    {
                        interval: 'Every 15,000 miles or 18 months',
                        services: ['Oil Change', 'Oil Filter', 'Air Filter Replacement', 'Cabin Air Filter', 'Tire Rotation', 'Brake Inspection']
                    },
                    {
                        interval: 'Every 30,000 miles or 36 months',
                        services: ['Full Oil Service', 'Spark Plug Replacement', 'Transmission Fluid', 'Coolant Flush', 'Brake Fluid Flush', 'Fuel System Cleaning']
                    },
                    {
                        interval: 'Every 60,000 miles or 72 months',
                        services: ['Timing Belt Replacement', 'Water Pump Inspection', 'Drive Belt Replacement', 'Complete Brake Service', 'Suspension Inspection']
                    }
                ]
            };
        }

        function displayServiceSchedule(schedule) {
            const resultsDiv = document.getElementById('scheduleResults');
            resultsDiv.innerHTML = `
                <h3 style="color: #0a2540; margin-bottom: 1rem;">Manufacturer Service Schedule</h3>
                ${schedule.schedules.map((s, index) => `
                    <div class="card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid #00d4ff;">
                        <h4 style="color: #0a2540; margin-bottom: 0.5rem;">${s.interval}</h4>
                        <ul style="margin-left: 1.5rem; color: #666;">
                            ${s.services.map(service => `<li>${service}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            `;
        }

        async function getVehicleHistory(vin) {
            const inputVin = vin || document.getElementById('historyVin').value.trim().toUpperCase();
            
            if (inputVin.length !== 17) {
                alert('Please enter a valid 17-digit VIN number');
                return;
            }

            const resultsDiv = document.getElementById('historyResults');
            if (resultsDiv) {
                if (!vin) resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading vehicle history...</div>';
            }

            try {
                const history = simulateVehicleHistory(inputVin);
                displayVehicleHistory(history);
            } catch (error) {
                console.error('Vehicle history error:', error);
                const history = simulateVehicleHistory(inputVin);
                displayVehicleHistory(history);
            }
        }

        function simulateVehicleHistory(vin) {
            return {
                vin: vin,
                odometer: Math.floor(45000 + Math.random() * 50000) + ' miles',
                owners: Math.floor(1 + Math.random() * 3),
                accidents: Math.random() > 0.7 ? Math.floor(Math.random() * 2) : 0,
                titleStatus: 'Clean',
                lastReportedDate: new Date().toLocaleDateString(),
                records: [
                    { date: '2024-01-15', type: 'Service', description: 'Oil Change and Tire Rotation', mileage: '48,234' },
                    { date: '2023-08-20', type: 'Service', description: 'Brake Pad Replacement', mileage: '42,156' },
                    { date: '2023-02-10', type: 'Inspection', description: 'Annual Vehicle Inspection - Passed', mileage: '36,789' },
                    { date: '2022-11-05', type: 'Service', description: '30,000 Mile Service', mileage: '30,000' }
                ]
            };
        }

        function displayVehicleHistory(history) {
            const resultsDiv = document.getElementById('historyResults');
            resultsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0a2540;">${history.odometer}</div>
                        <div style="color: #666;">Odometer</div>
                    </div>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0a2540;">${history.owners}</div>
                        <div style="color: #666;">Previous Owners</div>
                    </div>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${history.accidents === 0 ? '#43e97b' : '#f5576c'};">${history.accidents}</div>
                        <div style="color: #666;">Accidents</div>
                    </div>
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 5px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #43e97b;">${history.titleStatus}</div>
                        <div style="color: #666;">Title Status</div>
                    </div>
                </div>
                <h3 style="color: #0a2540; margin-bottom: 1rem;">Service History</h3>
                ${history.records.map(record => `
                    <div class="card" style="margin-bottom: 0.5rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="status-badge status-${record.type.toLowerCase() === 'service' ? 'approved' : 'completed'}">${record.type}</span>
                            <strong style="margin-left: 0.5rem;">${record.description}</strong>
                        </div>
                        <div style="color: #666; text-align: right;">
                            <div>${record.date}</div>
                            <div style="font-size: 0.9rem;">${record.mileage}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function createVehicleCustomer(year, make, model, vin) {
            alert(`Customer creation form will open with pre-filled data:\n\nVehicle: ${year} ${make} ${model}\nVIN: ${vin}`);
            showScreen('customers');
        }

        function orderPart(partNumber, name, price) {
            alert(`Ordering part: ${name}\nPart #: ${partNumber}\nPrice: $${price.toFixed(2)}\n\nThis will initiate a VAPI call to the parts store.`);
        }

        function addToInventory(name, partNumber, price) {
            const item = {
                id: Date.now(),
                name: name,
                partNumber: partNumber,
                category: 'General',
                quantity: 0,
                cost: price * 0.6,
                price: price,
                reorderPoint: 5
            };
            
            inventory.push(item);
            saveToStorage();
            renderInventory();
            alert(`Added ${name} to inventory!`);
        }

        // ============ VAPI PHONE INTEGRATION ============
        function startVapiPartsCall() {
            alert('VAPI phone system will call the parts store to check availability and place orders.\n\nFeature requires VAPI configuration in Settings.');
        }

        function startVapiCustomerCall() {
            alert('VAPI phone system will call the customer with appointment reminders and status updates.\n\nFeature requires VAPI configuration in Settings.');
        }

        function startVapiTowCall() {
            alert('VAPI phone system will call the tow service to schedule pickup.\n\nFeature requires VAPI configuration in Settings.');
        }

        function configureVapi() {
            alert('VAPI configuration panel will open here.\n\nConfigure:\n- Phone numbers\n- Call scripts\n- Call scheduling\n- Voice preferences');
            showScreen('settings');
        }

        // ALEX - Add Vehicle from VIN Decode to Customer Form
        function openAlexModalWithVin(vin) {
            document.getElementById('alexInputModal').classList.add('active');
            document.getElementById('alexVin').value = vin;
            loadAlexTemplates();
            // Auto-decode VIN to populate vehicle info
            decodeVin().then(() => {
                const vinResults = document.getElementById('vinResults');
                if (vinResults.style.display !== 'none') {
                    const vehicleText = vinResults.textContent;
                    const match = vehicleText.match(/(\d{4})\s+(\w+)\s+(\w+)/);
                    if (match) {
                        document.getElementById('alexVehicle').value = `${match[1]} ${match[2]} ${match[3]}`;
                    }
                }
            });
        }

        // ============ ALEX AI FUNCTIONS ============
        async function getAlexConfig() {
            try {
                const response = await fetch('http://localhost:3001/api/alex/config');
                const data = await response.json();
                return data.config;
            } catch (error) {
                console.error('Error getting ALEX config:', error);
                return null;
            }
        }

        async function generateAlexEstimate() {
            const vehicle = document.getElementById('alexVehicle')?.value || '';
            const customer = document.getElementById('alexCustomer')?.value || '';
            const services = document.getElementById('alexServices')?.value || '';
            const vin = document.getElementById('alexVin')?.value || '';

            if (!vehicle) {
                alert('Please enter vehicle information');
                return;
            }

            try {
                const response = await fetch('http://localhost:3001/api/alex/generate-estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vehicle, customer, services, vin })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayAlexEstimate(data.estimate);
                } else {
                    alert('Error generating estimate: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error connecting to ALEX AI. Please make sure the backend is running.');
            }
        }

        function displayAlexEstimate(estimate) {
            const modal = document.getElementById('alexEstimateModal');
            const content = document.getElementById('alexEstimateContent');
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0 0 0.5rem 0;"><i class="fas fa-robot"></i> ALEX AI Estimate</h2>
                    <p style="margin: 0; opacity: 0.9;">Generated at ${new Date(estimate.timestamp).toLocaleString()}</p>
                </div>

                <div class="card">
                    <h3 style="color: #0a2540; margin-bottom: 1rem;">Vehicle Information</h3>
                    <p><strong>Vehicle:</strong> ${estimate.vehicle}</p>
                    ${estimate.vin ? `<p><strong>VIN:</strong> ${estimate.vin}</p>` : ''}
                </div>

                <div class="card">
                    <h3 style="color: #0a2540; margin-bottom: 1rem;">Services</h3>
                    ${estimate.services.map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                            <span>${s.name}</span>
                            <span>${s.hours} hrs @ $100/hr</span>
                        </div>
                    `).join('')}
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; font-weight: bold;">
                        <span>Total Labor (${estimate.laborHours} hrs)</span>
                        <span>$${(estimate.laborHours * 100).toFixed(2)}</span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color: #0a2540; margin-bottom: 1rem;">Parts</h3>
                    ${estimate.parts.map(p => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                            <span>${p.name} x ${p.quantity}</span>
                            <span>$${p.price.toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div style="display: flex; justify-content: space-between; padding: 1rem 0; font-weight: bold;">
                        <span>Total Parts</span>
                        <span>$${estimate.parts.reduce((sum, p) => sum + p.price, 0).toFixed(2)}</span>
                    </div>
                </div>

                ${estimate.recommendations.length > 0 ? `
                <div class="card" style="background: #fff3cd; border: 1px solid #ffc107;">
                    <h3 style="color: #856404; margin-bottom: 1rem;"><i class="fas fa-lightbulb"></i> ALEX Recommendations</h3>
                    <ul style="margin-left: 1.5rem; color: #856404;">
                        ${estimate.recommendations.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.5rem; font-weight: bold;">Total Estimate</span>
                        <span style="font-size: 2rem; font-weight: bold;">$${estimate.total.toFixed(2)}</span>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Includes diagnostic fee of $85.00</p>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-success" style="flex: 1;" onclick="convertAlexToEstimate()">
                        <i class="fas fa-file-alt"></i> Convert to Estimate
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="sendAlexToCustomer()">
                        <i class="fas fa-envelope"></i> Send to Customer
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function openAlexModal() {
            document.getElementById('alexInputModal').classList.add('active');
            loadAlexTemplates();
        }

        async function loadAlexTemplates() {
            try {
                const response = await fetch('http://localhost:3001/api/alex/estimate-templates');
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('alexTemplates');
                    container.innerHTML = data.templates.map(t => `
                        <div class="card" style="cursor: pointer; transition: all 0.3s;" onclick="loadAlexTemplate('${t.id}')">
                            <h4 style="color: #0a2540; margin-bottom: 0.5rem;">${t.name}</h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">${t.description}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        async function loadAlexTemplate(templateId) {
            const templates = {
                'brake-job': { services: 'brake-pads,brake-rotors', description: 'Complete brake service' },
                'oil-change': { services: 'oil-change', description: 'Full synthetic oil change' },
                'suspension': { services: 'suspension,alignment', description: 'Suspension service' },
                'tune-up': { services: 'spark-plugs,air-filter,diagnostic', description: 'Engine tune-up' }
            };
            
            const template = templates[templateId];
            if (template) {
                document.getElementById('alexServices').value = template.services;
            }
        }

        // ============ MAINTENANCE FUNCTIONS ============
        let maintenanceJobs = [];
        let maintenanceHistory = [];

        function initSampleMaintenance() {
            maintenanceJobs = [
                {
                    id: 1,
                    customerName: 'John Smith',
                    vehicle: '2018 Honda Accord',
                    vin: '1HGCM82633A004352',
                    service: 'Brake Replacement',
                    status: 'In Progress',
                    priority: 'High',
                    startDate: '2025-01-15',
                    bay: 'Bay 1',
                    technician: 'Mike Johnson',
                    cost: 345,
                    notes: 'Customer waiting, expedite'
                },
                {
                    id: 2,
                    customerName: 'Jane Doe',
                    vehicle: '2020 Toyota Camry',
                    vin: '4T1BF1FK8CU123456',
                    service: 'Oil Change + Inspection',
                    status: 'Completed',
                    priority: 'Normal',
                    startDate: '2025-01-15',
                    bay: 'Bay 2',
                    technician: 'Sarah Williams',
                    cost: 85,
                    notes: 'No issues found'
                },
                {
                    id: 3,
                    customerName: 'Bob Wilson',
                    vehicle: '2019 Ford F-150',
                    vin: '1FTEW1EP4KF123456',
                    service: 'Transmission Flush',
                    status: 'Waiting for Parts',
                    priority: 'Medium',
                    startDate: '2025-01-14',
                    bay: 'Bay 3',
                    technician: 'Tom Davis',
                    cost: 250,
                    notes: 'Waiting for transmission fluid'
                }
            ];
            saveToStorage();
        }

        function renderMaintenanceList() {
            const list = document.getElementById('maintenanceList');
            if (maintenanceJobs.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No active maintenance jobs.</p>';
                return;
            }
            
            list.innerHTML = maintenanceJobs.map(job => {
                const statusColors = {
                    'In Progress': '#00d4ff',
                    'Completed': '#43e97b',
                    'Waiting for Parts': '#f39c12',
                    'Pending': '#95a5a6'
                };
                
                return `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${statusColors[job.status] || '#666'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1; min-width: 300px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h3 style="color: #0a2540; margin: 0;">${job.customerName}</h3>
                                    <span class="status-badge" style="background: ${statusColors[job.status]}; color: white;">${job.status}</span>
                                </div>
                                <p style="color: #666; margin: 0.25rem 0;"><strong>Vehicle:</strong> ${job.vehicle}</p>
                                <p style="color: #666; margin: 0.25rem 0;"><strong>VIN:</strong> ${job.vin}</p>
                                <p style="color: #666; margin: 0.25rem 0;"><strong>Service:</strong> ${job.service}</p>
                                <p style="color: #666; margin: 0.25rem 0;"><strong>Bay:</strong> ${job.bay} | <strong>Technician:</strong> ${job.technician}</p>
                                <p style="color: #666; margin: 0.25rem 0;"><strong>Cost:</strong> $${job.cost.toFixed(2)}</p>
                                ${job.notes ? `<p style="color: #f39c12; margin: 0.25rem 0; font-style: italic;"><i class="fas fa-sticky-note"></i> ${job.notes}</p>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="completeMaintenance(${job.id})">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                <button class="btn btn-primary" onclick="updateMaintenance(${job.id})">
                                    <i class="fas fa-edit"></i> Update
                                </button>
                                <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="sendAlexBill(${job.id})">
                                    <i class="fas fa-robot"></i> ALEX Bill
                                </button>
                                <button class="btn btn-danger" onclick="deleteMaintenance(${job.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openMaintenanceModal() {
            document.getElementById('maintenanceModal').classList.add('active');
        }

        function saveMaintenanceJob() {
            const job = {
                id: Date.now(),
                customerName: document.getElementById('maintenanceCustomer').value,
                vehicle: document.getElementById('maintenanceVehicle').value,
                vin: document.getElementById('maintenanceVin').value,
                service: document.getElementById('maintenanceService').value,
                priority: document.getElementById('maintenancePriority').value,
                bay: document.getElementById('maintenanceBay').value,
                technician: document.getElementById('maintenanceTechnician').value,
                cost: parseFloat(document.getElementById('maintenanceCost').value) || 0,
                notes: document.getElementById('maintenanceNotes').value,
                status: 'Pending',
                startDate: new Date().toISOString().split('T')[0]
            };
            
            if (!job.customerName || !job.vehicle) {
                alert('Please enter customer name and vehicle');
                return;
            }
            
            maintenanceJobs.push(job);
            saveToStorage();
            renderMaintenanceList();
            closeModal('maintenanceModal');
            
            // Clear form
            document.getElementById('maintenanceCustomer').value = '';
            document.getElementById('maintenanceVehicle').value = '';
            document.getElementById('maintenanceVin').value = '';
            document.getElementById('maintenanceCost').value = '';
            document.getElementById('maintenanceNotes').value = '';
            
            alert('Maintenance job added successfully!');
        }

        function completeMaintenance(id) {
            const job = maintenanceJobs.find(j => j.id === id);
            if (job) {
                job.status = 'Completed';
                job.completedDate = new Date().toISOString().split('T')[0];
                
                // Add to history
                maintenanceHistory.push({
                    date: job.completedDate,
                    vehicle: job.vehicle,
                    service: job.service,
                    cost: job.cost,
                    status: 'Completed'
                });
                
                // Remove from active jobs
                maintenanceJobs = maintenanceJobs.filter(j => j.id !== id);
                saveToStorage();
                renderMaintenanceList();
                renderMaintenanceHistory();
                
                alert(`Job completed for ${job.customerName}!`);
            }
        }

        function updateMaintenance(id) {
            alert('Update maintenance job modal will open');
        }

        function deleteMaintenance(id) {
            if (confirm('Are you sure you want to delete this maintenance job?')) {
                maintenanceJobs = maintenanceJobs.filter(j => j.id !== id);
                saveToStorage();
                renderMaintenanceList();
            }
        }

        function renderMaintenanceHistory() {
            const history = document.getElementById('maintenanceHistory');
            if (maintenanceHistory.length === 0) {
                history.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No maintenance history yet.</td></tr>';
                return;
            }
            
            history.innerHTML = maintenanceHistory.map(h => `
                <tr>
                    <td>${h.date}</td>
                    <td>${h.vehicle}</td>
                    <td>${h.service}</td>
                    <td>$${h.cost.toFixed(2)}</td>
                    <td><span class="status-badge status-paid">${h.status}</span></td>
                </tr>
            `).join('');
        }

        // ALEX Billing via Email + PayPal
        function sendAlexBill(jobId) {
            const job = maintenanceJobs.find(j => j.id === jobId);
            if (!job) return;
            
            // Check if integrations are enabled
            const sendgridEnabled = settings.sendgridEnabled || false;
            const paypalEnabled = settings.paypalEnabled || false;
            const alexAutoBilling = settings.paypalAlexBilling || false;
            
            if (!sendgridEnabled || !paypalEnabled || !alexAutoBilling) {
                alert('Please enable SendGrid, PayPal, and ALEX Auto-Billing in Settings first.');
                showScreen('settings');
                return;
            }
            
            // Generate PayPal payment link
            const paypalLink = generatePaypalLink(job);
            
            // Create invoice email
            const emailContent = {
                to: 'customer@email.com', // Would come from customer record
                subject: `Invoice for ${job.service} - ${job.vehicle}`,
                body: `
Dear Customer,

Your vehicle is ready for pickup!

Vehicle: ${job.vehicle}
Service: ${job.service}
Total: $${job.cost.toFixed(2)}

${paypalEnabled ? `\nPay securely via PayPal: ${paypalLink}` : ''}

Thank you for choosing VHICL Pro Auto Shop!

Best regards,
ALEX AI Assistant
                `
            };
            
            // Send email via SendGrid
            alert(`ALEX is sending invoice email with PayPal link...\n\nTo: customer@email.com\nSubject: Invoice for ${job.service}\nAmount: $${job.cost.toFixed(2)}\nPayPal Link: ${paypalLink}`);
            
            // In production, this would call the backend to:
            // 1. Create PayPal payment
            // 2. Generate invoice
            // 3. Send email via SendGrid
        }

        function generatePaypalLink(job) {
            const clientId = settings.paypalClientId || '';
            const environment = settings.paypalEnvironment || 'sandbox';
            const baseUrl = environment === 'sandbox' 
                ? 'https://www.sandbox.paypal.com/cgi-bin/webscr'
                : 'https://www.paypal.com/cgi-bin/webscr';
            
            return `${baseUrl}?cmd=_xclick&business=${settings.paypalEmail}&item_name=${encodeURIComponent(job.service + ' - ' + job.vehicle)}&amount=${job.cost.toFixed(2)}&currency_code=USD`;
        }

        // ============ VAPI FUNCTIONS ============
        let vapiScripts = [];

        function initSampleVapiScripts() {
            vapiScripts = [
                {
                    id: 1,
                    name: 'Alex - Estimate Approval Call',
                    description: 'Alex calls customer with estimate for approval',
                    script: 'Hello [CUSTOMER_NAME], this is Alex from [SHOP_NAME]. I\'m calling about your [YEAR] [MAKE] [MODEL]. We\'ve completed our diagnosis and the estimated total for [SERVICE] is $[AMOUNT]. This includes parts and labor. Would you like me to proceed with the repairs? If approved, I\'ll order the parts and get your vehicle back in the work queue.',
                    voice: 'alex'
                },
                {
                    id: 2,
                    name: 'Alex - Parts Order Call',
                    description: 'Alex calls parts store to order approved parts',
                    script: 'Hello, this is Alex from [SHOP_NAME]. I need to order [PART_NAME] for a [YEAR] [MAKE] [MODEL]. The part number is [PART_NUMBER]. Can you confirm availability and delivery time?',
                    voice: 'alex'
                },
                {
                    id: 3,
                    name: 'Alex - Rejected Estimate Follow-up',
                    description: 'Alex prepares paperwork for customer pickup when estimate is rejected',
                    script: 'Hello [CUSTOMER_NAME], this is Alex from [SHOP_NAME]. I understand you\'ve decided not to proceed with the repairs at this time. I\'m preparing your vehicle for pickup. There will be a diagnostic fee of $[AMOUNT]. Would you like to schedule a pickup time?',
                    voice: 'alex'
                },
                {
                    id: 4,
                    name: 'Alex - Vehicle Ready Notification',
                    description: 'Alex calls customer when repairs are complete and informs about email invoice',
                    script: 'Hello [CUSTOMER_NAME], this is Alex from [SHOP_NAME]. Great news! Your [YEAR] [MAKE] [MODEL] is ready for pickup. All repairs have been completed successfully. I\'ve just sent you an email with the invoice for $[AMOUNT]. The invoice includes PayPal and credit card payment options for your convenience. When would you like to come pick up your vehicle?',
                    voice: 'alex'
                },
                {
                    id: 5,
                    name: 'Alex - Parts Store Call',
                    description: 'Alex calls parts store to check availability and place order',
                    script: 'Hello, this is Alex from [SHOP_NAME]. I need to check availability for [PART_NAME] for a [YEAR] [MAKE] [MODEL]. Can you tell me if it\'s in stock and the price?',
                    voice: 'alex'
                },
                {
                    id: 6,
                    name: 'Alex - Appointment Reminder',
                    description: 'Alex reminds customer about upcoming appointment',
                    script: 'Hello [CUSTOMER_NAME], this is Alex from [SHOP_NAME]. This is a reminder that your appointment for [SERVICE] on your [YEAR] [MAKE] [MODEL] is scheduled for [DATE] at [TIME]. Please call us if you need to reschedule.',
                    voice: 'alex'
                },
                {
                    id: 7,
                    name: 'Alex - Tow Dispatch',
                    description: 'Alex calls towing company to arrange pickup with all details',
                    script: 'Hello, this is Alex calling from [SHOP_NAME]. I need to arrange a tow for one of our customers. Customer Information: Name: [CUSTOMER_NAME], Phone: [CUSTOMER_PHONE], Meeting at vehicle: [CUSTOMER_MEETING_VEHICLE]. Vehicle Details: Year/Make/Model: [VEHICLE_YEAR] [VEHICLE_MAKE] [VEHICLE_MODEL], Tag/Plate Number: [VEHICLE_TAG], Color: [VEHICLE_COLOR]. Pickup Location: Address: [PICKUP_ADDRESS], Key Location: [KEY_LOCATION], Landmarks: [LANDMARKS]. Dropoff Destination: [DROP_OFF_TYPE]Address: [DROP_OFF_ADDRESS]. Additional Notes: [ADDITIONAL_NOTES]. Urgency Level: [URGENCY]. Can you confirm you can handle this tow? What is your estimated arrival time? What is the estimated cost? Thank you for your help. We appreciate your prompt service.',
                    voice: 'alex'
                },
                {
                    id: 8,
                    name: 'Alex - Survey Call',
                    description: 'Alex calls customer for feedback after service',
                    script: 'Hello [CUSTOMER_NAME], this is Alex from [SHOP_NAME]. Thank you for choosing us for your recent service on your [YEAR] [MAKE] [MODEL]. We\'d love to hear your feedback. How was your experience with our service today?',
                    voice: 'alex'
                },
                {
                    id: 9,
                    name: 'Alex - Inbound Phone (Main Greeting)',
                    description: 'Alex answers incoming calls and directs to appropriate service',
                    script: 'Thank you for calling [SHOP_NAME]. This is Alex. How can I help you today? I can assist you with scheduling an appointment, getting an estimate for repairs, arranging a tow, checking on your vehicle status, or general questions. What can I help you with?',
                    voice: 'alex'
                },
                {
                    id: 10,
                    name: 'Alex - Inbound (Towing Request)',
                    description: 'Alex handles towing requests from incoming calls',
                    script: 'I can definitely help you arrange a tow. I\'ll need some information. About You: What\'s your name? What\'s the best phone number to reach you? About Your Vehicle: What year, make, and model is it? What\'s the license plate number? What color is the vehicle? Pickup Location: Where is the vehicle located right now? Please give me the exact address. Where are the keys? Are there any nearby landmarks to help the tow truck find it? Will you be there to meet the tow truck? Destination: Do you want it towed to our shop, or somewhere else? Urgency: Is this an emergency, or can it wait? Thank you. Let me get that arranged for you right away.',
                    voice: 'alex'
                },
                {
                    id: 11,
                    name: 'Alex - Inbound (Schedule Appointment)',
                    description: 'Alex schedules appointments from incoming calls',
                    script: 'I\'d be happy to schedule an appointment for you. Let me get some details: What\'s your name? What\'s your phone number? What year, make, and model is your vehicle? What type of service do you need? Do you have any specific concerns or symptoms with the vehicle? When would you like to bring it in? Let me check our availability... I have openings on [AVAILABLE_DATES]. Which day works best for you? And what time would you prefer? Morning or afternoon? Great! I\'ve scheduled your appointment for [DATE] at [TIME]. Please arrive a few minutes early so we can get started right away. Our address is [SHOP_ADDRESS]. Is there anything else I should know about your vehicle or the service you need?',
                    voice: 'alex'
                },
                {
                    id: 12,
                    name: 'Alex - Inbound (Request Estimate)',
                    description: 'Alex handles estimate requests from incoming calls',
                    script: 'I can help you with an estimate. There are a couple of options. Option 1: Quick Estimate. If you tell me what\'s wrong, I can give you a general price range based on common repairs. Option 2: Diagnostic Estimate. For an accurate estimate, we\'ll need to diagnose the vehicle first. This costs $[DIAGNOSTIC_FEE] and takes about [DIAGNOSTIC_TIME]. For a quick estimate, I\'ll need: What year, make, and model is your vehicle? What\'s the issue or what service do you need? For a diagnostic estimate: Would you like to schedule a diagnostic appointment? Which option would you prefer?',
                    voice: 'alex'
                },
                {
                    id: 13,
                    name: 'Alex - Inbound (Check Status)',
                    description: 'Alex checks vehicle status for incoming calls',
                    script: 'I can check on your vehicle status for you. Could you tell me: Your name? Your phone number? Or your vehicle\'s license plate? [LOOKS UP RECORD]. I found your record. You have a [VEHICLE_YEAR] [VEHICLE_MAKE] [VEHICLE_MODEL]. Current Status: [VEHICLE_STATUS]. [IF_WAITING_FOR_PARTS] We\'re waiting for parts to arrive. Expected delivery is [PARTS_EXPECTED_DATE]. [IF_IN_PROGRESS] Your vehicle is currently being worked on. We expect to complete it by [EXPECTED_COMPLETION]. [IF_READY] Great news! Your vehicle is ready for pickup! [IF_NOT_STARTED] We\'re scheduled to start on [SCHEDULED_START_DATE]. Would you like me to provide more details, or is there anything else I can help you with?',
                    voice: 'alex'
                },
                {
                    id: 14,
                    name: 'Alex - Inbound (Emergency)',
                    description: 'Alex handles emergency calls',
                    script: 'I understand this is an emergency. Let me help you right away. Are you: Stranded with a broken-down vehicle? In a dangerous location? Need immediate towing? [IF_STRANDED] Are you in a safe location? If you\'re in immediate danger, please call 911 first. [IF_SAFE] Let me arrange emergency towing for you right now. I\'ll need: Your current location (address or cross streets), Your phone number, What\'s happening with the vehicle. I\'ll get a tow truck dispatched immediately. Are you able to stay with the vehicle, or do you need to go somewhere?',
                    voice: 'alex'
                },
                {
                    id: 15,
                    name: 'Alex - Inbound (Vehicle Drop-off)',
                    description: 'Alex handles customer vehicle drop-off calls, instructs key drop box',
                    script: `Thank you for calling [SHOP_NAME]. I can help you with dropping off your vehicle. Please follow these instructions:

**Key Drop Box Instructions:**
‚Ä¢ Please park your vehicle in our customer parking area
‚Ä¢ Place your keys in the secure key drop box located [DROP_BOX_LOCATION]
‚Ä¢ The drop box is clearly marked and checked regularly throughout the day

**Information I'll Need:**

**Customer Information:**
‚Ä¢ What is your full name?
‚Ä¢ What is your phone number?
‚Ä¢ What is your email address?

**Vehicle Information:**
‚Ä¢ What is the year, make, and model of your vehicle?
‚Ä¢ What is the license plate number?

**Service Information:**
‚Ä¢ What service do you need, or what issues are you experiencing?
‚Ä¢ Have you been here before, or is this your first visit?

**For Reference:**
‚Ä¢ If you have an appointment, please let me know your appointment time
‚Ä¢ If you need a ride, let me know and I can help arrange transportation

Thank you for choosing [SHOP_NAME]. We'll contact you once we've had a chance to review your vehicle. Is there anything else I can help you with?`,
                    voice: 'alex'
                }
            ];
        }

        function renderVapiScripts() {
            const list = document.getElementById('vapiScriptsList');
            if (vapiScripts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No VAPI scripts yet. Create your first script!</p>';
                return;
            }
            
            list.innerHTML = vapiScripts.map(script => `
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="color: #0a2540; margin-bottom: 0.5rem;">
                                <i class="fas fa-microphone"></i> ${script.name}
                            </h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">${script.description}</p>
                            <p style="color: #00d4ff; font-size: 0.9rem; margin: 0.25rem 0;">
                                <strong>Voice:</strong> ${script.voice}
                            </p>
                            <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 5px; margin-top: 0.5rem; font-family: monospace; font-size: 0.85rem;">
                                "${script.script.substring(0, 100)}..."
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="useVapiScript(${script.id})">
                                <i class="fas fa-phone"></i> Use
                            </button>
                            <button class="btn" style="background: #666; color: white;" onclick="editVapiScript(${script.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteVapiScript(${script.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openVapiScriptModal() {
            editingScriptId = null;
            
            // Clear form fields
            const nameInput = document.getElementById('vapiScriptName');
            const descInput = document.getElementById('vapiScriptDescription');
            const voiceSelect = document.getElementById('vapiScriptVoice');
            const textArea = document.getElementById('vapiScriptText');
            const modalTitle = document.getElementById('vapiScriptModalTitle');
            
            if (nameInput) nameInput.value = '';
            if (descInput) descInput.value = '';
            if (voiceSelect) voiceSelect.value = 'alex';
            if (textArea) textArea.value = '';
            if (modalTitle) modalTitle.textContent = 'Create VAPI Script';
            
            // Open modal
            const modal = document.getElementById('vapiScriptModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function saveVapiScript() {
            const nameInput = document.getElementById('vapiScriptName');
            const descInput = document.getElementById('vapiScriptDescription');
            const voiceSelect = document.getElementById('vapiScriptVoice');
            const textArea = document.getElementById('vapiScriptText');
            
            if (!nameInput || !textArea) {
                alert('Required form elements not found');
                return;
            }
            
            const name = nameInput.value;
            const description = descInput ? descInput.value : '';
            const voice = voiceSelect ? voiceSelect.value : 'alex';
            const scriptText = textArea.value;
            
            if (!name || !scriptText) {
                alert('Please enter script name and script text');
                return;
            }
            
            if (editingScriptId) {
                // Update existing script
                const index = vapiScripts.findIndex(s => s.id === editingScriptId);
                if (index !== -1) {
                    vapiScripts[index] = {
                        ...vapiScripts[index],
                        name: name,
                        description: description,
                        voice: voice,
                        text: scriptText
                    };
                    alert('Script updated successfully!');
                }
                editingScriptId = null;
            } else {
                // Create new script
                const script = {
                    id: Date.now(),
                    name: name,
                    description: description,
                    voice: voice,
                    text: scriptText
                };
                vapiScripts.push(script);
                alert('VAPI script saved successfully!');
            }
            
            saveToStorage();
            renderVapiScripts();
            closeModal('vapiScriptModal');
            
            // Clear form and reset title
            nameInput.value = '';
            if (descInput) descInput.value = '';
            if (voiceSelect) voiceSelect.value = 'alex';
            textArea.value = '';
            
            // Reset modal title
            const modalTitle = document.getElementById('vapiScriptModalTitle');
            if (modalTitle) modalTitle.textContent = 'Create VAPI Script';
        }

        function useVapiScript(id) {
            const script = vapiScripts.find(s => s.id === id);
            if (script) {
                alert(`Using VAPI script: ${script.name}\n\nVoice: ${script.voice}\nScript: ${script.script}`);
            }
        }

        let editingScriptId = null;

        function editVapiScript(id) {
            const script = vapiScripts.find(s => s.id === id);
            if (!script) {
                alert('Script not found');
                return;
            }
            
            editingScriptId = id;
            
            // Populate modal with script data
            const nameInput = document.getElementById('vapiScriptName');
            const descInput = document.getElementById('vapiScriptDescription');
            const voiceSelect = document.getElementById('vapiScriptVoice');
            const textArea = document.getElementById('vapiScriptText');
            const modalTitle = document.querySelector('#vapiScriptModal .card-title');
            
            if (nameInput) nameInput.value = script.name || '';
            if (descInput) descInput.value = script.description || '';
            if (voiceSelect) voiceSelect.value = script.voice || 'alex';
            if (textArea) textArea.value = script.text || '';
            
            // Change modal title
            if (modalTitle) modalTitle.textContent = 'Edit VAPI Script';
            
            // Open modal
            const modal = document.getElementById('vapiScriptModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function deleteVapiScript(id) {
            if (confirm('Are you sure you want to delete this script?')) {
                vapiScripts = vapiScripts.filter(s => s.id !== id);
                renderVapiScripts();
            }
        }

        // ============ TECHFLOW FUNCTIONS ============
        function autoBalanceBays() {
            alert('Bay balancing algorithm will optimize workload distribution across bays based on:\n- Job duration\n- Technician skills\n- Parts availability\n- Priority level\n\nThis will help maintain even bay utilization and maximize shop efficiency.');
        }

        function completeJob(jobId) {
            if (confirm('Is this job complete and ready for estimate creation?')) {
                alert(`Job ${jobId} marked as complete!\n\nTechnician can now:\n1. Create estimate\n2. Wait for shop approval\n3. Alex will call customer with approved estimate`);
            }
        }

        function renderPendingApprovalEstimates() {
            const list = document.getElementById('pendingApprovalList');
            if (!list) return;
            
            const pendingEstimates = estimates.filter(e => e.status === 'Draft');
            
            if (pendingEstimates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No estimates pending approval</p>';
                return;
            }
            
            list.innerHTML = pendingEstimates.map(est => `
                <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color: #0a2540; margin-bottom: 0.5rem;">${est.customerName} - ${est.vehicle}</h3>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-calendar"></i> ${est.date}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><i class="fas fa-car"></i> ${est.vehicle}</p>
                            <p style="font-weight: bold; color: #0a2540; margin-top: 0.5rem;">Total: $${est.total.toFixed(2)}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-badge" style="background: #ffc107; color: #000;">Pending Approval</span>
                            <button class="btn btn-success" onclick="approveEstimate(${est.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger" onclick="rejectEstimate(${est.id})">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="btn btn-secondary" onclick="viewEstimate(${est.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function approveEstimate(estimateId) {
            const estimate = estimates.find(e => e.id === estimateId);
            if (!estimate) return;
            
            if (confirm(`Approve this estimate for ${estimate.customerName}?\n\nTotal: $${estimate.total.toFixed(2)}\n\nOnce approved, Alex will call the customer.`)) {
                estimate.status = 'Approved';
                saveToStorage();
                renderEstimates();
                renderPendingApprovalEstimates();
                alert(`Estimate approved!\n\nAlex is ready to call ${estimate.customerName} with the estimate details.`);
            }
        }

        function rejectEstimate(estimateId) {
            const estimate = estimates.find(e => e.id === estimateId);
            if (!estimate) return;
            
            const reason = prompt('Reason for rejection (optional):');
            
            if (confirm(`Reject this estimate for ${estimate.customerName}?`)) {
                estimate.status = 'Rejected';
                estimate.rejectionReason = reason || '';
                saveToStorage();
                renderEstimates();
                renderPendingApprovalEstimates();
                alert(`Estimate rejected.\n\nTechnician should revise the estimate or prepare vehicle for pickup.`);
            }
        }

        function viewEstimate(estimateId) {
            const estimate = estimates.find(e => e.id === estimateId);
            if (!estimate) return;
            
            alert(`ESTIMATE DETAILS\n\nCustomer: ${estimate.customerName}\nVehicle: ${estimate.vehicle}\nDate: ${estimate.date}\n\nDescription: ${estimate.description}\n\nParts:\n${estimate.parts ? estimate.parts.map(p => `- ${p.name}: $${(p.quantity * p.price).toFixed(2)}`).join('\n') : 'No parts'}\n\nLabor:\n${estimate.labor ? estimate.labor.map(l => `- ${l.description}: $${l.total.toFixed(2)}`).join('\n') : 'No labor'}\n\nTOTAL: $${estimate.total.toFixed(2)}`);
        }

        function sendInvoiceEmail() {
            const sendgridEnabled = settings.sendgridEnabled || false;
            if (!sendgridEnabled) {
                alert('Please enable SendGrid in Settings first to send invoices via email.');
                showScreen('settings');
                return;
            }
            
            const customerEmail = prompt('Enter customer email address:');
            if (!customerEmail) return;
            
            const invoiceAmount = prompt('Enter invoice amount ($):');
            if (!invoiceAmount) return;
            
            alert(`Invoice email will be sent to: ${customerEmail}\n\nAmount: $${invoiceAmount}\n\nPayment Options:\n- PayPal\n- Credit Card\n\nInvoice will include:\n- Detailed breakdown of services\n- Total amount\n- PayPal payment link\n- Credit card payment options\n\nEmail will be sent via SendGrid using template: ${settings.sendgridTemplate || 'default'}`);
        }

        function makeVapiCall(type) {
            const vapiEnabled = settings.vapiEnabled || false;
            if (!vapiEnabled) {
                alert('Please enable VAPI in Settings first.');
                showScreen('settings');
                return;
            }
            
            const callTypes = {
                'parts': { script: 'Parts Store Call', prompt: 'Enter parts store phone number' },
                'customer': { script: 'Customer Call', prompt: 'Enter customer phone number' },
                'tow': { script: 'Tow Dispatch', prompt: 'Enter tow provider phone number' },
                'reminder': { script: 'Customer Reminder', prompt: 'Enter customer phone number' },
                'survey': { script: 'Survey Call', prompt: 'Enter customer phone number' }
            };
            
            const callInfo = callTypes[type];
            const phoneNumber = prompt(callInfo.prompt);
            
            if (phoneNumber) {
                alert(`VAPI is initiating call to ${phoneNumber}...\n\nUsing script: ${callInfo.script}\nVoice: ${settings.vapiVoice || 'alex'}\n\nIn production, this would make an actual call.`);
            }
        }

        // ============ INTEGRATION SETTINGS FUNCTIONS ============
        function saveVapiSettings() {
            settings.vapiApiKey = document.getElementById('vapiApiKey').value;
            settings.vapiPhoneNumber = document.getElementById('vapiPhoneNumber').value;
            settings.vapiVoice = document.getElementById('vapiVoice').value;
            settings.vapiEnabled = document.getElementById('vapiEnabled').checked;
            settings.vapiRecordCalls = document.getElementById('vapiRecordCalls').checked;
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            updateIntegrationBadges();
            alert('VAPI settings saved successfully!');
        }

        function saveShopServicesSettings() {
            const servicesNotPerformed = document.getElementById('servicesNotPerformed').value;
            const localPartsNumbers = document.getElementById('localPartsNumbers').value;
            
            // Parse services not performed (split by lines, remove empty lines)
            settings.servicesNotPerformed = servicesNotPerformed
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Parse local parts numbers (split by lines, then by |)
            settings.localPartsNumbers = localPartsNumbers
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    const parts = line.split('|').map(p => p.trim());
                    return {
                        partName: parts[0] || '',
                        oemNumber: parts[1] || '',
                        localPartNumber: parts[2] || '',
                        supplier: parts[3] || ''
                    };
                });
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            alert('Shop services and local parts settings saved successfully!');
        }

        function saveTwilioSettings() {
            settings.twilioAccountSid = document.getElementById('twilioAccountSid').value;
            settings.twilioAuthToken = document.getElementById('twilioAuthToken').value;
            settings.twilioPhoneNumber = document.getElementById('twilioPhoneNumber').value;
            settings.twilioEnabled = document.getElementById('twilioEnabled').checked;
            settings.twilioAutoReminders = document.getElementById('twilioAutoReminders').checked;
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            updateIntegrationBadges();
            alert('Twilio settings saved successfully!');
        }

        function savePaypalSettings() {
            settings.paypalClientId = document.getElementById('paypalClientId').value;
            settings.paypalClientSecret = document.getElementById('paypalClientSecret').value;
            settings.paypalEnvironment = document.getElementById('paypalEnvironment').value;
            settings.paypalEmail = document.getElementById('paypalEmail').value;
            settings.paypalEnabled = document.getElementById('paypalEnabled').checked;
            settings.paypalAlexBilling = document.getElementById('paypalAlexBilling').checked;
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            updateIntegrationBadges();
            alert('PayPal settings saved successfully!');
        }

        function saveSendgridSettings() {
            settings.sendgridApiKey = document.getElementById('sendgridApiKey').value;
            settings.sendgridFromEmail = document.getElementById('sendgridFromEmail').value;
            settings.sendgridFromName = document.getElementById('sendgridFromName').value;
            settings.sendgridEnabled = document.getElementById('sendgridEnabled').checked;
            settings.sendgridAlexEmail = document.getElementById('sendgridAlexEmail').checked;
            settings.sendgridTemplate = document.getElementById('sendgridTemplate').value;
            
            localStorage.setItem('vhicl_settings', JSON.stringify(settings));
            updateIntegrationBadges();
            alert('SendGrid settings saved successfully!');
        }

        function updateIntegrationBadges() {
            // Update VAPI badge
            const vapiBadge = document.getElementById('vapiBadge');
            if (settings.vapiEnabled && settings.vapiApiKey) {
                vapiBadge.style.background = '#d4edda';
                vapiBadge.style.color = '#155724';
                vapiBadge.textContent = 'Connected';
            } else {
                vapiBadge.style.background = '#f8d7da';
                vapiBadge.style.color = '#721c24';
                vapiBadge.textContent = 'Disconnected';
            }
            
            // Update Twilio badge
            const twilioBadge = document.getElementById('twilioBadge');
            if (settings.twilioEnabled && settings.twilioAccountSid && settings.twilioAuthToken) {
                twilioBadge.style.background = '#d4edda';
                twilioBadge.style.color = '#155724';
                twilioBadge.textContent = 'Connected';
            } else {
                twilioBadge.style.background = '#f8d7da';
                twilioBadge.style.color = '#721c24';
                twilioBadge.textContent = 'Disconnected';
            }
            
            // Update PayPal badge
            const paypalBadge = document.getElementById('paypalBadge');
            if (settings.paypalEnabled && settings.paypalClientId && settings.paypalClientSecret) {
                paypalBadge.style.background = '#d4edda';
                paypalBadge.style.color = '#155724';
                paypalBadge.textContent = 'Connected';
            } else {
                paypalBadge.style.background = '#f8d7da';
                paypalBadge.style.color = '#721c24';
                paypalBadge.textContent = 'Disconnected';
            }
            
            // Update SendGrid badge
            const sendgridBadge = document.getElementById('sendgridBadge');
            if (settings.sendgridEnabled && settings.sendgridApiKey) {
                sendgridBadge.style.background = '#d4edda';
                sendgridBadge.style.color = '#155724';
                sendgridBadge.textContent = 'Connected';
            } else {
                sendgridBadge.style.background = '#f8d7da';
                sendgridBadge.style.color = '#721c24';
                sendgridBadge.textContent = 'Disconnected';
            }
        }

        function testVapiConnection() {
            alert('VAPI test call will be made to verify connection...');
        }

        function testTwilioSMS() {
            const phoneNumber = prompt('Enter phone number to send test SMS:');
            if (phoneNumber) {
                alert(`Test SMS sent to ${phoneNumber}!\n\nThis would send an actual SMS via Twilio in production.`);
            }
        }

        function testPaypalConnection() {
            alert('Testing PayPal API connection...\n\nThis would verify Client ID and Secret in production.');
        }

        function testSendgridEmail() {
            const emailAddress = prompt('Enter email address to send test email:');
            if (emailAddress) {
                alert(`Test email sent to ${emailAddress}!\n\nThis would send an actual email via SendGrid in production.`);
            }
        }

        // ============ INVENTORY FUNCTIONS ============
        function initSampleInventory() {
            inventory = [
                {
                    id: 1,
                    name: 'Brake Pads (Front)',
                    partNumber: 'BP-F-001',
                    category: 'Brakes',
                    quantity: 15,
                    cost: 25,
                    price: 85,
                    reorderPoint: 5
                },
                {
                    id: 2,
                    name: 'Brake Rotors (Front)',
                    partNumber: 'BR-F-001',
                    category: 'Brakes',
                    quantity: 8,
                    cost: 45,
                    price: 120,
                    reorderPoint: 3
                },
                {
                    id: 3,
                    name: 'Synthetic Oil (5qt)',
                    partNumber: 'OIL-SYN-5',
                    category: 'Fluids',
                    quantity: 20,
                    cost: 18,
                    price: 45,
                    reorderPoint: 5
                },
                {
                    id: 4,
                    name: 'Oil Filter',
                    partNumber: 'FLT-GEN-01',
                    category: 'Filters',
                    quantity: 35,
                    cost: 5,
                    price: 15,
                    reorderPoint: 10
                },
                {
                    id: 5,
                    name: 'Battery (Standard)',
                    partNumber: 'BAT-STD-001',
                    category: 'Electrical',
                    quantity: 4,
                    cost: 75,
                    price: 150,
                    reorderPoint: 2
                },
                {
                    id: 6,
                    name: 'Spark Plugs (Set of 4)',
                    partNumber: 'SPK-SET-4',
                    category: 'Engine',
                    quantity: 12,
                    cost: 12,
                    price: 45,
                    reorderPoint: 4
                }
            ];
            saveToStorage();
        }

        function saveInventoryItem() {
            const item = {
                id: Date.now(),
                name: document.getElementById('inventoryName').value,
                partNumber: document.getElementById('inventoryPartNumber').value,
                category: document.getElementById('inventoryCategory').value,
                quantity: parseInt(document.getElementById('inventoryQuantity').value) || 1,
                cost: parseFloat(document.getElementById('inventoryCost').value) || 0,
                price: parseFloat(document.getElementById('inventoryPrice').value) || 0,
                reorderPoint: parseInt(document.getElementById('inventoryReorderPoint').value) || 2
            };
            
            inventory.push(item);
            saveToStorage();
            renderInventory();
            closeModal('inventoryModal');
            
            // Clear form
            document.getElementById('inventoryName').value = '';
            document.getElementById('inventoryPartNumber').value = '';
            document.getElementById('inventoryQuantity').value = '1';
            document.getElementById('inventoryCost').value = '0';
            document.getElementById('inventoryPrice').value = '0';
            document.getElementById('inventoryReorderPoint').value = '2';
        }

        function renderInventory() {
            const list = document.getElementById('inventoryList');
            
            // Calculate stats
            const totalItems = inventory.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = inventory.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const lowStock = inventory.filter(item => item.quantity <= item.reorderPoint).length;
            
            const totalItemsEl = document.getElementById('totalInventoryItems');
            const inventoryValueEl = document.getElementById('inventoryValue');
            const lowStockEl = document.getElementById('lowStockItems');
            
            if (totalItemsEl) totalItemsEl.textContent = totalItems;
            if (inventoryValueEl) inventoryValueEl.textContent = `$${totalValue.toFixed(2)}`;
            if (lowStockEl) lowStockEl.textContent = lowStock;
            
            if (inventory.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">No inventory items yet. Add your first item!</p>';
                return;
            }
            
            list.innerHTML = inventory.map(item => {
                const value = item.quantity * item.price;
                const profit = value - (item.quantity * item.cost);
                const isLowStock = item.quantity <= item.reorderPoint;
                
                return `
                    <div class="inventory-item" style="${isLowStock ? 'border: 2px solid #f5576c;' : ''}">
                        <div class="inventory-item-name">${item.name}</div>
                        <div class="inventory-item-details">
                            Part #: ${item.partNumber} | Category: ${item.category}
                        </div>
                        <div class="inventory-item-details">
                            Qty: ${item.quantity} | Cost: $${item.cost.toFixed(2)} | Price: $${item.price.toFixed(2)}
                        </div>
                        <div class="inventory-item-value">
                            Total Value: $${value.toFixed(2)} (Profit: $${profit.toFixed(2)})
                        </div>
                        ${isLowStock ? `
                            <div style="color: #f5576c; font-weight: bold; margin-top: 0.5rem;">
                                <i class="fas fa-exclamation-triangle"></i> LOW STOCK - Reorder Now!
                            </div>
                        ` : ''}
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="editInventoryItem(${item.id})" style="font-size: 0.8rem; padding: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteInventoryItem(${item.id})" style="font-size: 0.8rem; padding: 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteInventoryItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                inventory = inventory.filter(i => i.id !== id);
                saveToStorage();
                renderInventory();
            }
        }

        function editInventoryItem(id) {
            alert('Edit functionality coming soon!');
        }
    </script>
</body>
</html>
