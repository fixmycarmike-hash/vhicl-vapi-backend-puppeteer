<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VHICL Pro - Reports Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #64748b;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --background: #f8fafc;
      --text: #1e293b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background);
      color: var(--text);
      padding: 20px;
    }

    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .dashboard-header h1 {
      color: var(--primary);
      font-size: 28px;
    }

    .report-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .period-select, .export-btn {
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .period-select:hover, .export-btn:hover {
      border-color: var(--primary);
    }

    .export-btn {
      background: var(--primary);
      color: #ffffff;
      border: none;
      font-weight: bold;
    }

    .export-btn:hover {
      background: #1d4ed8;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .report-card {
      background: #ffffff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .report-card:hover {
      transform: translateY(-5px);
    }

    .report-card h3 {
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .report-card h3 i {
      font-size: 20px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--secondary);
      font-size: 14px;
    }

    .stat-value {
      font-weight: bold;
      color: var(--text);
    }

    .stat-value.highlight {
      color: var(--primary);
      font-size: 18px;
    }

    .chart-container {
      background: #ffffff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .chart-container h3 {
      color: var(--primary);
      margin-bottom: 20px;
    }

    .report-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 20px;
      background: #e5e7eb;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: #ffffff;
    }

    .tab:hover:not(.active) {
      background: #d1d5db;
    }

    .report-content {
      display: none;
    }

    .report-content.active {
      display: block;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
      background: #f8fafc;
      font-weight: bold;
      color: var(--secondary);
    }

    .data-table tr:hover {
      background: #f8fafc;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--secondary);
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: #ffffff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .summary-card h4 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .summary-card .value {
      font-size: 32px;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .report-controls {
        flex-direction: column;
        width: 100%;
      }

      .report-grid {
        grid-template-columns: 1fr;
      }

      .dashboard-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <div class="dashboard">
    <div class="dashboard-header">
      <h1><i class="fas fa-chart-line"></i> Reports Dashboard</h1>
      <div class="report-controls">
        <select class="period-select" id="periodSelect" onchange="loadReports()">
          <option value="day">Today</option>
          <option value="week">This Week</option>
          <option value="month" selected>This Month</option>
          <option value="year">This Year</option>
        </select>
        <button class="export-btn" onclick="exportCurrentReport()">
          <i class="fas fa-download"></i> Export CSV
        </button>
      </div>
    </div>

    <div class="report-tabs">
      <button class="tab active" onclick="switchTab('overview')">
        <i class="fas fa-th-large"></i> Overview
      </button>
      <button class="tab" onclick="switchTab('sales')">
        <i class="fas fa-dollar-sign"></i> Sales
      </button>
      <button class="tab" onclick="switchTab('technicians')">
        <i class="fas fa-users"></i> Technicians
      </button>
      <button class="tab" onclick="switchTab('inventory')">
        <i class="fas fa-boxes"></i> Inventory
      </button>
      <button class="tab" onclick="switchTab('customers')">
        <i class="fas fa-user"></i> Customers
      </button>
      <button class="tab" onclick="switchTab('profit-loss')">
        <i class="fas fa-balance-scale"></i> Profit/Loss
      </button>
      <button class="tab" onclick="switchTab('bays')">
        <i class="fas fa-warehouse"></i> Bays
      </button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="report-content active">
      <div class="summary-stats">
        <div class="summary-card">
          <h4>Total Revenue</h4>
          <div class="value" id="totalRevenue">$0</div>
        </div>
        <div class="summary-card">
          <h4>Invoices</h4>
          <div class="value" id="totalInvoices">0</div>
        </div>
        <div class="summary-card">
          <h4>Jobs Completed</h4>
          <div class="value" id="totalJobs">0</div>
        </div>
        <div class="summary-card">
          <h4>Avg Invoice</h4>
          <div class="value" id="avgInvoice">$0</div>
        </div>
      </div>

      <div class="report-grid">
        <div class="chart-container">
          <h3><i class="fas fa-chart-area"></i> Revenue Trend</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-container">
          <h3><i class="fas fa-chart-pie"></i> Revenue Breakdown</h3>
          <canvas id="revenueBreakdownChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Sales Tab -->
    <div id="sales" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-dollar-sign"></i> Sales Report</h3>
        <div id="salesReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading sales report...
          </div>
        </div>
      </div>
    </div>

    <!-- Technicians Tab -->
    <div id="technicians" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-users"></i> Technician Performance</h3>
        <div id="techniciansReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading technician report...
          </div>
        </div>
      </div>
    </div>

    <!-- Inventory Tab -->
    <div id="inventory" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-boxes"></i> Parts Inventory</h3>
        <div id="inventoryReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading inventory report...
          </div>
        </div>
      </div>
    </div>

    <!-- Customers Tab -->
    <div id="customers" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-user"></i> Customer Analysis</h3>
        <div id="customersReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading customer report...
          </div>
        </div>
      </div>
    </div>

    <!-- Profit/Loss Tab -->
    <div id="profit-loss" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-balance-scale"></i> Profit & Loss</h3>
        <div id="profitLossReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading profit/loss report...
          </div>
        </div>
      </div>
    </div>

    <!-- Bays Tab -->
    <div id="bays" class="report-content">
      <div class="report-card">
        <h3><i class="fas fa-warehouse"></i> Bay Utilization</h3>
        <div id="baysReportContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading bay report...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let authToken = localStorage.getItem('authToken');
    let currentPeriod = 'month';
    let currentTab = 'overview';
    let revenueChart = null;
    let revenueBreakdownChart = null;

    // Initialize dashboard
    async function initDashboard() {
      if (!authToken) {
        window.location.href = '/login.html';
        return;
      }

      await loadReports();
      initCharts();
    }

    // Switch tab
    function switchTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update content
      document.querySelectorAll('.report-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      currentTab = tabId;

      // Load specific report if not overview
      if (tabId !== 'overview') {
        loadSpecificReport(tabId);
      }
    }

    // Load all reports
    async function loadReports() {
      currentPeriod = document.getElementById('periodSelect').value;
      
      try {
        // Load all reports summary
        const response = await fetch(`/api/reports/all?period=${currentPeriod}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          updateOverview(data.reports);
          updateSalesReport(data.reports.sales);
          updateTechniciansReport(data.reports.technicianPerformance);
          updateInventoryReport(data.reports.inventory);
          updateCustomersReport(data.reports.customerAnalysis);
          updateProfitLossReport(data.reports.profitLoss);
          updateBaysReport(data.reports.bayUtilization);
          updateTrendChart(data.reports.trends);
        } else {
          throw new Error('Failed to load reports');
        }
      } catch (error) {
        console.error('Error loading reports:', error);
        showError('Failed to load reports. Please try again.');
      }
    }

    // Load specific report
    async function loadSpecificReport(reportType) {
      try {
        const response = await fetch(`/api/reports/${reportType}?period=${currentPeriod}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          switch (reportType) {
            case 'sales':
              updateSalesReport(data.report);
              break;
            case 'technician-performance':
              updateTechniciansReport(data.report);
              break;
            case 'inventory':
              updateInventoryReport(data.report);
              break;
            case 'customers':
              updateCustomersReport(data.report);
              break;
            case 'profit-loss':
              updateProfitLossReport(data.report);
              break;
            case 'bay-utilization':
              updateBaysReport(data.report);
              break;
          }
        }
      } catch (error) {
        console.error(`Error loading ${reportType} report:`, error);
      }
    }

    // Update overview
    function updateOverview(reports) {
      const sales = reports.sales;
      
      document.getElementById('totalRevenue').textContent = `$${(sales.summary.totalRevenue || 0).toLocaleString()}`;
      document.getElementById('totalInvoices').textContent = sales.summary.totalInvoices || 0;
      document.getElementById('totalJobs').textContent = reports.technicianPerformance.summary.totalJobsCompleted || 0;
      document.getElementById('avgInvoice').textContent = `$${(sales.summary.averageInvoice || 0).toLocaleString()}`;
    }

    // Update sales report
    function updateSalesReport(report) {
      const container = document.getElementById('salesReportContent');
      
      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Invoices</span>
          <span class="stat-value highlight">${report.summary.totalInvoices || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Revenue</span>
          <span class="stat-value highlight">$${(report.summary.totalRevenue || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Parts Revenue</span>
          <span class="stat-value">$${(report.summary.totalParts || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Labor Revenue</span>
          <span class="stat-value">$${(report.summary.totalLabor || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Average Invoice</span>
          <span class="stat-value">$${(report.summary.averageInvoice || 0).toLocaleString()}</span>
        </div>
      `;
    }

    // Update technicians report
    function updateTechniciansReport(report) {
      const container = document.getElementById('techniciansReportContent');
      
      if (!report.technicians || report.technicians.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--secondary);">No technician data available</p>';
        return;
      }

      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Technicians</span>
          <span class="stat-value highlight">${report.summary.totalTechnicians || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Jobs Completed</span>
          <span class="stat-value">${report.summary.totalJobsCompleted || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Revenue Generated</span>
          <span class="stat-value">$${(report.summary.totalRevenue || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Avg Revenue per Technician</span>
          <span class="stat-value">$${(report.summary.avgRevenuePerTechnician || 0).toLocaleString()}</span>
        </div>
        
        <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary);">Top Performers</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>Technician</th>
              <th>Jobs</th>
              <th>Hours</th>
              <th>Revenue</th>
              <th>Efficiency</th>
            </tr>
          </thead>
          <tbody>
            ${report.technicians.slice(0, 5).map(tech => `
              <tr>
                <td>${tech.name}</td>
                <td>${tech.jobsCompleted}</td>
                <td>${tech.totalHours.toFixed(1)}</td>
                <td>$${tech.totalRevenue.toLocaleString()}</td>
                <td>${tech.efficiency.toFixed(0)}%</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Update inventory report
    function updateInventoryReport(report) {
      const container = document.getElementById('inventoryReportContent');
      
      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Parts</span>
          <span class="stat-value highlight">${report.summary.totalParts || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Value</span>
          <span class="stat-value highlight">$${(report.summary.totalValue || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Low Stock Items</span>
          <span class="stat-value" style="color: var(--warning);">${report.summary.lowStockCount || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Categories</span>
          <span class="stat-value">${Object.keys(report.byCategory || {}).length}</span>
        </div>

        ${report.lowStockCount > 0 ? `
          <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--warning);">Low Stock Items</h4>
          <table class="data-table">
            <thead>
              <tr>
                <th>Part</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Min</th>
              </tr>
            </thead>
            <tbody>
              ${report.lowStockItems.slice(0, 10).map(part => `
                <tr>
                  <td>${part.name || 'Unknown'}</td>
                  <td>${part.category || 'Uncategorized'}</td>
                  <td style="color: var(--warning);">${part.quantity || 0}</td>
                  <td>${part.minStock || 0}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : ''}
      `;
    }

    // Update customers report
    function updateCustomersReport(report) {
      const container = document.getElementById('customersReportContent');
      
      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Customers</span>
          <span class="stat-value highlight">${report.summary.totalCustomers || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Visits</span>
          <span class="stat-value">${report.summary.totalVisits || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Revenue</span>
          <span class="stat-value">$${(report.summary.totalRevenue || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Avg Spend per Customer</span>
          <span class="stat-value">$${(report.summary.avgSpentPerCustomer || 0).toLocaleString()}</span>
        </div>

        <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary);">Top Customers</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>Customer</th>
              <th>Visits</th>
              <th>Total Spent</th>
              <th>Last Visit</th>
            </tr>
          </thead>
          <tbody>
            ${report.topCustomers.slice(0, 10).map(customer => `
              <tr>
                <td>${customer.name}</td>
                <td>${customer.visitCount}</td>
                <td>$${customer.totalSpent.toLocaleString()}</td>
                <td>${new Date(customer.lastVisit).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Update profit/loss report
    function updateProfitLossReport(report) {
      const container = document.getElementById('profitLossReportContent');
      
      const grossMargin = parseFloat(report.grossMargin) || 0;
      const isProfitable = report.grossProfit > 0;
      
      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Revenue</span>
          <span class="stat-value highlight">$${(report.revenue || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Parts Cost</span>
          <span class="stat-value" style="color: var(--error);">-$${(report.costs.parts || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Labor Cost</span>
          <span class="stat-value" style="color: var(--error);">-$${(report.costs.labor || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Total Costs</span>
          <span class="stat-value" style="color: var(--error);">-$${(report.costs.total || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Gross Profit</span>
          <span class="stat-value highlight" style="color: ${isProfitable ? 'var(--success)' : 'var(--error)'}">
            ${isProfitable ? '+' : ''}$${(report.grossProfit || 0).toLocaleString()}
          </span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Gross Margin</span>
          <span class="stat-value highlight" style="color: ${grossMargin >= 30 ? 'var(--success)' : grossMargin >= 20 ? 'var(--warning)' : 'var(--error)'}">
            ${grossMargin}%
          </span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Invoices</span>
          <span class="stat-value">${report.invoiceCount || 0}</span>
        </div>
      `;
    }

    // Update bays report
    function updateBaysReport(report) {
      const container = document.getElementById('baysReportContent');
      
      if (!report.bays || report.bays.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--secondary);">No bay data available</p>';
        return;
      }

      container.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Bays</span>
          <span class="stat-value highlight">${report.summary.totalBays || 0}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Avg Utilization</span>
          <span class="stat-value">${report.summary.avgUtilization || '0%'}</span>
        </div>

        <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary);">Bay Utilization</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>Bay</th>
              <th>Jobs</th>
              <th>Hours</th>
              <th>Utilization</th>
            </tr>
          </thead>
          <tbody>
            ${report.bays.map(bay => {
              const utilization = parseFloat(bay.utilization) || 0;
              const utilizationColor = utilization >= 70 ? 'var(--success)' : utilization >= 50 ? 'var(--warning)' : 'var(--error)';
              return `
                <tr>
                  <td>${bay.name}</td>
                  <td>${bay.totalJobs}</td>
                  <td>${bay.totalHours.toFixed(1)}</td>
                  <td style="color: ${utilizationColor}; font-weight: bold;">${bay.utilization}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // Update trend chart
    function updateTrendChart(report) {
      if (!report.dailyData || report.dailyData.length === 0) {
        return;
      }

      const labels = report.dailyData.map(d => new Date(d.date).toLocaleDateString());
      const revenueData = report.dailyData.map(d => d.revenue);
      const invoiceData = report.dailyData.map(d => d.invoiceCount);

      if (revenueChart) {
        revenueChart.data.labels = labels;
        revenueChart.data.datasets[0].data = revenueData;
        revenueChart.update();
      }

      if (revenueBreakdownChart) {
        const totalRevenue = revenueData.reduce((sum, r) => sum + r, 0);
        const avgRevenue = report.summary?.avgDailyRevenue || 0;
        
        revenueBreakdownChart.data.datasets[0].data = [
          totalRevenue * 0.6, // Labor (60%)
          totalRevenue * 0.3, // Parts (30%)
          totalRevenue * 0.1  // Other (10%)
        ];
        revenueBreakdownChart.update();
      }
    }

    // Initialize charts
    function initCharts() {
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      const breakdownCtx = document.getElementById('revenueBreakdownChart').getContext('2d');

      revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Revenue',
            data: [],
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });

      revenueBreakdownChart = new Chart(breakdownCtx, {
        type: 'doughnut',
        data: {
          labels: ['Labor', 'Parts', 'Other'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#2563eb', '#22c55e', '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Export current report
    async function exportCurrentReport() {
      try {
        const reportType = currentTab === 'overview' ? 'sales' : currentTab;
        
        const response = await fetch(`/api/reports/${reportType}/export/csv?period=${currentPeriod}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${reportType}-report-${currentPeriod}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          throw new Error('Failed to export report');
        }
      } catch (error) {
        console.error('Error exporting report:', error);
        alert('Failed to export report. Please try again.');
      }
    }

    // Show error
    function showError(message) {
      alert(message);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
